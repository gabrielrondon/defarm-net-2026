openapi: 3.0.3
info:
  title: DeFarm API Gateway
  description: '**Single entry point for all DeFarm services**


    The Gateway provides:

    - JWT-based authentication

    - Request routing to backend services

    - User context injection

    - Rate limiting


    ## Authentication


    Most endpoints require a JWT token in the Authorization header:

    ```

    Authorization: Bearer <access_token>

    ```


    ### Getting Started


    1. **Register**: POST `/auth/register`

    2. **Login**: POST `/auth/login` â†’ Returns `access_token` and `refresh_token`

    3. **Use token**: Add `Authorization: Bearer <access_token>` to all `/api/*` requests

    4. **Refresh**: POST `/auth/refresh` with `refresh_token` when access token expires


    ### Token Lifetimes

    - **Access Token**: 15 minutes

    - **Refresh Token**: 30 days

    '
  version: 1.0.0
  contact:
    name: DeFarm Support
    email: support@defarm.com
servers:
- url: http://gateway.defarm.net:8080
  description: Production (Custom Domain)
- url: https://gateway-service-production-f54d.up.railway.app
  description: Production (Railway Domain)
- url: http://localhost:8000
  description: Local development
tags:
- name: Authentication
  description: User registration, login, and token management
- name: Circuits
  description: Multi-tenant data repositories with RBAC
- name: Items
  description: Agricultural items with traceability
- name: Events
  description: Item state changes and lifecycle events
- name: Audit
  description: Immutable audit trails
- name: DFID
  description: DeFarm Identifier generation and validation
- name: Health
  description: Service health checks
- name: items
  description: Item registry CRUD operations and bulk import
- name: workflows
  description: Item merge, split, unmerge, and relationship tracking
- name: circuits
  description: Circuit and member management
- name: events
  description: Event tracking and lifecycle management
- name: audit
  description: Immutable audit logs with hash chain verification
- name: admin
  description: Administrative operations and API key management
- name: webhooks
  description: Webhook subscriptions and delivery tracking
- name: activity
  description: Activity feeds, sessions, and user tracking
- name: snapshots
  description: Point-in-time snapshots with restore capabilities
- name: merkle
  description: Merkle tree construction and cryptographic verification
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token obtained from /auth/login
  schemas:
    Error:
      description: Standard error response with error code and message.
      type: object
      required:
      - error
      - message
      properties:
        error:
          type: string
          example: unauthorized
        message:
          type: string
          example: Invalid or expired token
        details:
          type: string
          nullable: true
          description: Optional detailed error context
    WorkspaceInfo:
      type: object
      required:
      - id
      - name
      - slug
      - tier
      - role
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        slug:
          type: string
        tier:
          type: string
        role:
          type: string
          enum:
          - viewer
          - editor
          - admin
          - owner
    UserInfo:
      type: object
      required:
      - id
      - email
      - workspace
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        full_name:
          type: string
          nullable: true
        avatar_url:
          type: string
          nullable: true
        workspace:
          $ref: '#/components/schemas/WorkspaceInfo'
    AuthResponse:
      type: object
      required:
      - access_token
      - refresh_token
      - token_type
      - expires_in
      - user
      properties:
        access_token:
          type: string
          description: JWT access token (expires in 15 minutes)
        refresh_token:
          type: string
          description: JWT refresh token (expires in 30 days)
        token_type:
          type: string
          example: Bearer
        expires_in:
          type: integer
          description: Access token lifetime in seconds
          example: 900
        user:
          $ref: '#/components/schemas/UserInfo'
    ActivityFeed:
      description: User activity entry for audit trail and activity feed display.
      type: object
      required:
      - id
      - actor_id
      - action
      - resource_type
      - description
      - is_public
      - created_at
      properties:
        action:
          type: string
        actor_id:
          type: string
          format: uuid
        actor_name:
          type: string
          nullable: true
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        description:
          type: string
        id:
          type: string
          format: uuid
        is_public:
          type: boolean
        metadata:
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_name:
          type: string
          nullable: true
        resource_type:
          type: string
          enum:
          - snapshot
          - circuit
          - audit
          - event
          - item
          - mixed
          enum:
          - snapshot
          - circuit
          - audit
          - event
          - item
          - mixed
    ActivitySummary:
      description: Aggregated summary of activities by type and resource for reporting.
      type: object
      required:
      - id
      - summary_date
      - summary_type
      - action_counts
      - resource_counts
      - created_at
      properties:
        action_counts: {}
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        id:
          type: string
          format: uuid
        resource_counts: {}
        summary_date:
          type: string
          format: date
        summary_type:
          type: string
        user_id:
          type: string
          format: uuid
          nullable: true
    AddMemberRequest:
      description: Request payload to add a new member to a circuit. Requires user_id and role.
      type: object
      required:
      - user_id
      - role
      properties:
        added_by:
          type: string
          format: uuid
          nullable: true
        permissions:
          nullable: true
        role:
          type: string
          enum:
          - viewer
          - editor
          - admin
          - owner
        user_id:
          type: string
          format: uuid
    ApplyRetentionResponse:
      description: API response confirming retention policy application with affected snapshots count.
      type: object
      required:
      - policy_id
      - snapshots_affected
      properties:
        policy_id:
          type: string
          format: uuid
        snapshots_affected:
          type: integer
          format: int64
          minimum: 0
    AuditLog:
      description: Immutable audit log entry with hash chain linkage for tamper-proof record keeping.
      type: object
      required:
      - id
      - action
      - resource_type
      - created_at
      properties:
        action:
          type: string
        changes:
          nullable: true
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        hash:
          type: string
          nullable: true
        id:
          type: string
          format: uuid
        ip_address:
          type: string
          nullable: true
        metadata:
          nullable: true
        previous_hash:
          type: string
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_type:
          type: string
        user_agent:
          type: string
          nullable: true
        user_id:
          type: string
          format: uuid
          nullable: true
    AuditLogResponse:
      description: API response containing audit log details including actor, action, old/new values, and hash chain.
      type: object
      required:
      - id
      - action
      - resource_type
      - created_at
      properties:
        action:
          type: string
        changes:
          nullable: true
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        hash:
          type: string
          nullable: true
        id:
          type: string
          format: uuid
        ip_address:
          type: string
          nullable: true
        metadata:
          nullable: true
        previous_hash:
          type: string
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_type:
          type: string
        user_agent:
          type: string
          nullable: true
        user_id:
          type: string
          format: uuid
          nullable: true
    Circuit:
      description: |
        Multi-tenant data repository that serves as the primary permission boundary in DeFarm.
        Circuits isolate data by organization/workspace and provide RBAC access control for items, events, and audit logs.
      type: object
      required:
      - id
      - name
      - circuit_type
      - visibility
      - owner_id
      - status
      - is_archived
      - created_at
      - updated_at
      - is_published
      - discovery_enabled
      - searchable
      - featured
      - view_count
      properties:
        archived_at:
          type: string
          format: date-time
          nullable: true
        circuit_type:
          type: string
          enum:
          - private
          - shared
          - public
          - enterprise
        created_at:
          type: string
          format: date-time
        description:
          type: string
          nullable: true
        discovery_enabled:
          type: boolean
        featured:
          type: boolean
        id:
          type: string
          format: uuid
        is_archived:
          type: boolean
        is_published:
          type: boolean
        metadata:
          nullable: true
        name:
          type: string
        organization_id:
          type: string
          format: uuid
          nullable: true
        owner_id:
          type: string
          format: uuid
        public_banner_url:
          type: string
          nullable: true
        public_contact_email:
          type: string
          nullable: true
        public_description:
          type: string
          nullable: true
        public_logo_url:
          type: string
          nullable: true
        public_website:
          type: string
          nullable: true
        published_at:
          type: string
          format: date-time
          nullable: true
        published_by:
          type: string
          format: uuid
          nullable: true
        searchable:
          type: boolean
        settings:
          nullable: true
        slug:
          type: string
          nullable: true
        status:
          type: string
          enum:
          - pending
          - active
          - inactive
          - archived
          - local
          - merged
          - split
          - local
          - merged
          - split
          enum:
          - active
          - inactive
          - archived
          enum:
          - active
          - inactive
          - archived
        unpublished_at:
          type: string
          format: date-time
          nullable: true
        updated_at:
          type: string
          format: date-time
        view_count:
          type: integer
          format: int64
        visibility:
          type: string
          enum:
          - private
          - restricted
          - public
        workspace_id:
          type: string
          format: uuid
          nullable: true
    CircuitMember:
      description: Represents a user's membership in a circuit with role and permissions.
      type: object
      required:
      - id
      - circuit_id
      - user_id
      - role
      - status
      - joined_at
      - created_at
      - updated_at
      properties:
        circuit_id:
          type: string
          format: uuid
        created_at:
          type: string
          format: date-time
        custom_permissions:
          nullable: true
        id:
          type: string
          format: uuid
        joined_at:
          type: string
          format: date-time
        permissions:
          nullable: true
        removed_at:
          type: string
          format: date-time
          nullable: true
        role:
          type: string
        status:
          type: string
          enum:
          - pending
          - active
          - inactive
          - archived
          enum:
          - pending
          - processing
          - completed
          - failed
        updated_at:
          type: string
          format: date-time
        user_id:
          type: string
          format: uuid
    CircuitMemberResponse:
      description: API response containing circuit member details including user info, role, and permissions.
      type: object
      required:
      - circuit_id
      - user_id
      - role
      - joined_at
      - updated_at
      properties:
        circuit_id:
          type: string
          format: uuid
        joined_at:
          type: string
          format: date-time
        permissions:
          nullable: true
        role:
          type: string
        updated_at:
          type: string
          format: date-time
        user_id:
          type: string
          format: uuid
    CircuitResponse:
      description: API response containing full circuit details with metadata, members count, and permissions.
      type: object
      required:
      - id
      - name
      - circuit_type
      - visibility
      - owner_id
      - status
      - is_archived
      - created_at
      - updated_at
      properties:
        circuit_type:
          type: string
          enum:
          - private
          - shared
          - public
          - enterprise
        created_at:
          type: string
          format: date-time
        description:
          type: string
          nullable: true
        id:
          type: string
          format: uuid
        is_archived:
          type: boolean
        metadata:
          nullable: true
        name:
          type: string
        organization_id:
          type: string
          format: uuid
          nullable: true
        owner_id:
          type: string
          format: uuid
        settings:
          nullable: true
        status:
          type: string
        updated_at:
          type: string
          format: date-time
        visibility:
          type: string
          enum:
          - private
          - restricted
          - public
    ComparisonResponse:
      description: Result of comparing two resources (snapshots, items, etc.).
      type: object
      required:
      - id
      - snapshot_a_id
      - snapshot_b_id
      - comparison_type
      - diff_data
      - created_at
      properties:
        comparison_type:
          type: string
          enum:
          - forward
          - backward
          - merge_conflict
          - validation
          enum:
          - forward
          - backward
          - merge_conflict
          - validation
          enum:
          - forward
          - backward
          - merge_conflict
          - validation
          enum:
          - forward
          - backward
          - merge_conflict
          - validation
        created_at:
          type: string
          format: date-time
        diff_data: {}
        id:
          type: string
          format: uuid
        snapshot_a_id:
          type: string
          format: uuid
        snapshot_b_id:
          type: string
          format: uuid
        summary:
          nullable: true
    CreateActivityInput:
      description: Request payload to create a new activity entry.
      type: object
      required:
      - actor_id
      - action
      - resource_type
      - description
      - is_public
      properties:
        action:
          type: string
        actor_id:
          type: string
          format: uuid
        actor_name:
          type: string
          nullable: true
        circuit_id:
          type: string
          format: uuid
          nullable: true
        description:
          type: string
        is_public:
          type: boolean
        metadata:
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_name:
          type: string
          nullable: true
        resource_type:
          type: string
    CreateApiKeyRequest:
      description: Request payload to create API key for programmatic access.
      type: object
      required:
      - key_name
      - circuit_id
      properties:
        circuit_id:
          type: string
          format: uuid
          description: Circuit ID this key grants access to
        description:
          type: string
          description: Optional description of key purpose
          nullable: true
        expires_in_days:
          type: integer
          format: int64
          description: 'Number of days until expiration (default: never expires)'
          nullable: true
        key_name:
          type: string
          description: Human-readable name for the API key
    CreateApiKeyResponse:
      description: API response containing new API key (only shown once for security).
      type: object
      required:
      - id
      - key_name
      - circuit_id
      - api_key
      - created_at
      - message
      properties:
        api_key:
          type: string
          description: The actual API key (ONLY shown once!)
        circuit_id:
          type: string
          format: uuid
          description: Circuit this key grants access to
        created_at:
          type: string
          description: Creation timestamp (RFC3339)
        expires_at:
          type: string
          description: Expiration timestamp (RFC3339)
          nullable: true
        id:
          type: string
          format: uuid
          description: Unique identifier for this API key record
        key_name:
          type: string
          description: Name of the API key
        message:
          type: string
          description: Important message about saving the key
    CreatePartnerApiKeyRequest:
      description: Request payload to create a partner API key.
      type: object
      required:
      - key_name
      - circuit_id
      properties:
        key_name:
          type: string
          description: Human-readable name for the API key
        circuit_id:
          type: string
          format: uuid
          description: Circuit ID this key grants access to
        description:
          type: string
          description: Optional description of key purpose
          nullable: true
        expires_in_days:
          type: integer
          format: int64
          description: Number of days until expiration (default 365, max 730)
          nullable: true
    PartnerApiKeyResponse:
      description: Partner API key metadata (key value shown only on creation).
      type: object
      required:
      - id
      - key_name
      - circuit_id
      - is_active
      - created_at
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for this API key record
        key_name:
          type: string
          description: Name of the API key
        circuit_id:
          type: string
          format: uuid
          description: Circuit this key grants access to
        api_key:
          type: string
          description: The actual API key (only shown once at creation)
          nullable: true
        description:
          type: string
          description: Description of the key's purpose
          nullable: true
        is_active:
          type: boolean
          description: Whether the key is currently active
        rate_limit_per_minute:
          type: integer
          format: int32
          nullable: true
        rate_limit_per_day:
          type: integer
          format: int32
          nullable: true
        created_at:
          type: string
          description: Creation timestamp (RFC3339)
        last_used_at:
          type: string
          description: Last time this key was used (RFC3339)
          nullable: true
        expires_at:
          type: string
          description: Expiration timestamp (RFC3339)
          nullable: true
    CreatePartnerApiKeyResponse:
      description: API response containing new partner API key.
      type: object
      required:
      - key
      - message
      properties:
        key:
          $ref: '#/components/schemas/PartnerApiKeyResponse'
        message:
          type: string
          description: Important security message
    ApiKeyMetricsResponse:
      description: Usage metrics for an API key.
      type: object
      required:
      - api_key_id
      - requests_total
      - requests_last_24h
      - errors_last_24h
      properties:
        api_key_id:
          type: string
          format: uuid
        requests_total:
          type: integer
          format: int64
        requests_last_24h:
          type: integer
          format: int64
        errors_last_24h:
          type: integer
          format: int64
        last_used_at:
          type: string
          description: Last time this key was used (RFC3339)
          nullable: true
        rate_limit_per_minute:
          type: integer
          format: int32
          nullable: true
        rate_limit_per_day:
          type: integer
          format: int32
          nullable: true
    CreateCanonicalIdentifierRequest:
      description: Request payload to create a canonical identifier type.
      type: object
      required:
      - value_chain
      - identifier_type
      properties:
        value_chain:
          type: string
        identifier_type:
          type: string
    UpdateCanonicalIdentifierRequest:
      description: Request payload to enable or disable a canonical identifier type.
      type: object
      required:
      - is_active
      properties:
        is_active:
          type: boolean
    CanonicalIdentifierResponse:
      description: Canonical identifier type configuration.
      type: object
      required:
      - id
      - value_chain
      - identifier_type
      - is_active
      - created_at
      properties:
        id:
          type: string
          format: uuid
        value_chain:
          type: string
        identifier_type:
          type: string
        is_active:
          type: boolean
        created_at:
          type: string
          format: date-time
    CreateCircuitRequest:
      description: Request payload to create a new circuit. Requires name, circuit_type, and workspace_id.
      type: object
      required:
      - name
      - circuit_type
      - visibility
      - owner_id
      properties:
        circuit_type:
          type: string
          enum:
          - private
          - shared
          - public
          - enterprise
        description:
          type: string
          nullable: true
        ip_address:
          type: string
          nullable: true
        metadata:
          nullable: true
        name:
          type: string
        organization_id:
          type: string
          format: uuid
          nullable: true
        owner_id:
          type: string
          format: uuid
        settings:
          nullable: true
        user_id:
          type: string
          format: uuid
          nullable: true
        visibility:
          type: string
          enum:
          - private
          - restricted
          - public
    CreateComparisonRequest:
      description: Request payload to create a comparison between two resources.
      type: object
      required:
      - snapshot_b_id
      - comparison_type
      properties:
        comparison_type:
          type: string
          enum:
          - forward
          - backward
          - merge_conflict
          - validation
        snapshot_b_id:
          type: string
          format: uuid
    CreateItemRequest:
      description: Request payload to create a new item with automatic DFID generation. Requires value_chain, country, and circuit_id.
      type: object
      required:
      - value_chain
      - country
      - year
      - circuit_id
      properties:
        circuit_id:
          type: string
          format: uuid
        country:
          type: string
        ip_address:
          type: string
          nullable: true
        identifiers:
          type: array
          items:
            $ref: '#/components/schemas/IdentifierInput'
          nullable: true
        metadata:
          nullable: true
        owner_id:
          type: string
          format: uuid
          nullable: true
        user_id:
          type: string
          format: uuid
          nullable: true
        value_chain:
          type: string
        year:
          type: integer
          format: int32
    IdentifierInput:
      description: Identifier provided by client (canonical or contextual).
      type: object
      required:
      - identifier_type
      - value
      properties:
        identifier_type:
          type: string
        value:
          type: string
        is_canonical:
          type: boolean
          nullable: true
    IdentifierResponse:
      description: Identifier metadata stored for an item.
      type: object
      required:
      - identifier_type
      - value
      - is_canonical
      properties:
        identifier_type:
          type: string
        value:
          type: string
        is_canonical:
          type: boolean
    CreateMerkleTreeRequest:
      description: Request payload to create merkle tree for snapshot verification.
      type: object
      required:
      - tree_type
      - resource_type
      - leaf_data
      properties:
        circuit_id:
          type: string
          format: uuid
          nullable: true
        leaf_data:
          type: array
          items: {}
        metadata:
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_type:
          type: string
        snapshot_id:
          type: string
          format: uuid
          nullable: true
        tree_type:
          type: string
          enum:
          - snapshot
          - circuit
          - audit_batch
          - event_batch
          - item_batch
          enum:
          - snapshot
          - circuit
          - audit_batch
          - event_batch
          - item_batch
    CreateRestorationRequest:
      description: Request payload to restore data from snapshot.
      type: object
      required:
      - restored_by
      - restoration_type
      properties:
        pre_restore_snapshot_id:
          type: string
          format: uuid
          nullable: true
        restoration_type:
          type: string
          enum:
          - full
          - partial
          - merge
          - rollback
        restore_metadata:
          nullable: true
        restored_by:
          type: string
          format: uuid
        target_resource_id:
          type: string
          format: uuid
          nullable: true
    CreateSnapshotRequest:
      description: Request payload to create a new snapshot. Requires resource_type and resource_id.
      type: object
      required:
      - snapshot_type
      - resource_type
      - snapshot_name
      - snapshot_data
      - created_by
      properties:
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_by:
          type: string
          format: uuid
        description:
          type: string
          nullable: true
        expires_at:
          type: string
          format: date-time
          nullable: true
        metadata:
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_type:
          type: string
        snapshot_data: {}
        snapshot_name:
          type: string
        snapshot_type:
          type: string
    CreateWebhookInput:
      description: Request payload to create a new webhook. Requires URL and event types.
      type: object
      required:
      - circuit_id
      - name
      - url
      - events
      - created_by
      properties:
        circuit_id:
          type: string
          format: uuid
        created_by:
          type: string
          format: uuid
        events:
          type: array
          items:
            type: string
        headers:
          nullable: true
        name:
          type: string
        retry_config:
          allOf:
          - $ref: '#/components/schemas/WebhookRetryConfig'
          nullable: true
        secret:
          type: string
          nullable: true
        url:
          type: string
    ErrorResponse:
      description: API error response with detailed error information.
      type: object
      required:
      - error
      - message
      properties:
        details:
          type: string
          nullable: true
        error:
          type: string
        message:
          type: string
    Event:
      description: Represents a lifecycle event for an item (created, updated, transferred, certified, etc.).
      type: object
      required:
      - id
      - event_type
      - source_type
      - source_id
      - payload
      - status
      - created_at
      - visibility
      - is_duplicate
      properties:
        circuit_id:
          type: string
          format: uuid
          nullable: true
        content_hash:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        encrypted_payload:
          type: string
          format: binary
          nullable: true
        encryption_key_id:
          type: string
          nullable: true
        error_message:
          type: string
          nullable: true
        event_type:
          type: string
        id:
          type: string
          format: uuid
        is_duplicate:
          type: boolean
        item_id:
          type: string
          format: uuid
          nullable: true
        metadata:
          nullable: true
        original_event_id:
          type: string
          format: uuid
          nullable: true
        payload: {}
        processed_at:
          type: string
          format: date-time
          nullable: true
        source_id:
          type: string
          format: uuid
        source_type:
          type: string
        status:
          type: string
          enum:
          - pending
          - processing
          - completed
          - failed
        user_id:
          type: string
          format: uuid
          nullable: true
        visibility:
          type: string
        visible_to_roles:
          nullable: true
    EventResponse:
      description: API response containing full event details including type, timestamp, actor, and metadata.
      type: object
      required:
      - id
      - event_type
      - source_type
      - source_id
      - payload
      - status
      - created_at
      properties:
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        error_message:
          type: string
          nullable: true
        event_type:
          type: string
        id:
          type: string
          format: uuid
        item_id:
          type: string
          format: uuid
          nullable: true
        metadata:
          nullable: true
        payload: {}
        processed_at:
          type: string
          format: date-time
          nullable: true
        source_id:
          type: string
          format: uuid
        source_type:
          type: string
        status:
          type: string
          enum:
          - pending
          - processing
          - completed
          - failed
        user_id:
          type: string
          format: uuid
          nullable: true
    GenerateProofRequest:
      description: Request payload to generate cryptographic proof for data.
      type: object
      required:
      - leaf_data
      properties:
        leaf_data: {}
    HashChainVerificationResponse:
      description: Result of audit log hash chain integrity verification.
      type: object
      required:
      - valid
      - logs_checked
      - message
      properties:
        logs_checked:
          type: integer
          minimum: 0
        message:
          type: string
        valid:
          type: boolean
    HealthResponse:
      description: System health status response including component statuses.
      type: object
      required:
      - status
      - database
      - redis
      - timestamp
      properties:
        database:
          $ref: '#/components/schemas/HealthStatus'
        redis:
          $ref: '#/components/schemas/HealthStatus'
        status:
          type: string
        timestamp:
          type: string
    HealthStatus:
      description: Individual component health status (database, redis, etc.).
      type: object
      required:
      - connected
      - latency_ms
      properties:
        connected:
          type: boolean
        latency_ms:
          type: integer
          format: int64
          minimum: 0
    IngestionReceipt:
      description: Receipt for bulk ingestion operation with success/failure counts.
      type: object
      description: Receipt returned after ingestion completes
      required:
      - receipt_id
      - status
      - processing_time_ms
      - summary
      properties:
        error_message:
          type: string
          description: Error message if status is "failed" or "partial"
          nullable: true
        processing_time_ms:
          type: integer
          format: int64
          description: Processing time in milliseconds
          minimum: 0
        receipt_id:
          type: string
          format: uuid
          description: Unique receipt ID
        status:
          type: string
          description: 'Status: "processing", "completed", "failed", "partial"'
        summary:
          $ref: '#/components/schemas/IngestionSummary'
    IngestionSummary:
      type: object
      description: Statistics for a completed ingestion
      required:
      - rows_total
      - rows_processed
      - rows_failed
      - items_created
      - items_updated
      - events_created
      - identifiers_resolved
      - unclassified_fields
      properties:
        events_created:
          type: integer
          description: Events created
          minimum: 0
        identifiers_resolved:
          type: object
          description: Count of each identifier type resolved
          additionalProperties:
            type: integer
            minimum: 0
        items_created:
          type: integer
          description: New items created
          minimum: 0
        items_updated:
          type: integer
          description: Existing items updated
          minimum: 0
        rows_failed:
          type: integer
          description: Rows that failed
          minimum: 0
        rows_processed:
          type: integer
          description: Rows successfully processed
          minimum: 0
        rows_total:
          type: integer
          description: Total rows in CSV
          minimum: 0
        unclassified_fields:
          type: array
          items:
            type: string
          description: CSV fields that were not recognized
    Item:
      description: Represents a physical or digital asset in the supply chain, uniquely identified by a DFID.
      type: object
      required:
      - id
      - dfid
      - value_chain
      - country
      - year
      - status
      - registered_at
      - last_updated_at
      - created_at
      - updated_at
      properties:
        archived_at:
          type: string
          format: date-time
          nullable: true
        circuit_id:
          type: string
          format: uuid
          nullable: true
        country:
          type: string
        created_at:
          type: string
          format: date-time
        dfid:
          type: string
        id:
          type: string
          format: uuid
        last_updated_at:
          type: string
          format: date-time
        local_id:
          type: string
          format: uuid
          nullable: true
        merged_into:
          type: string
          nullable: true
        metadata:
          nullable: true
        owner_id:
          type: string
          format: uuid
          nullable: true
        registered_at:
          type: string
          format: date-time
        split_from:
          type: string
          nullable: true
        status:
          type: string
        updated_at:
          type: string
          format: date-time
        value_chain:
          type: string
        year:
          type: integer
          format: int32
    ItemResponse:
      description: API response containing full item details including DFID, status, metadata, and relationships.
      type: object
      required:
      - id
      - dfid
      - value_chain
      - country
      - year
      - status
      - registered_at
      - updated_at
      properties:
        circuit_id:
          type: string
          format: uuid
          nullable: true
        country:
          type: string
        dfid:
          type: string
        id:
          type: string
          format: uuid
        metadata:
          nullable: true
        owner_id:
          type: string
          format: uuid
          nullable: true
        registered_at:
          type: string
          format: date-time
        status:
          type: string
          enum:
          - pending
          - active
          - inactive
          - archived
        updated_at:
          type: string
          format: date-time
        value_chain:
          type: string
        year:
          type: integer
          format: int32
    ItemDetailsResponse:
      description: Item details with identifiers and events.
      type: object
      required:
      - item
      - identifiers
      - events
      properties:
        item:
          $ref: '#/components/schemas/ItemResponse'
        identifiers:
          type: array
          items:
            $ref: '#/components/schemas/IdentifierResponse'
        canonical_identifier:
          $ref: '#/components/schemas/IdentifierResponse'
          nullable: true
        events:
          type: array
          items:
            $ref: '#/components/schemas/Event'
    CreateItemResponse:
      description: Item creation response with identifiers, events, and deduplication status.
      type: object
      required:
      - item
      - identifiers
      - events
      - was_deduplicated
      properties:
        item:
          $ref: '#/components/schemas/ItemResponse'
        identifiers:
          type: array
          items:
            $ref: '#/components/schemas/IdentifierResponse'
        canonical_identifier:
          $ref: '#/components/schemas/IdentifierResponse'
          nullable: true
        events:
          type: array
          items:
            $ref: '#/components/schemas/Event'
        was_deduplicated:
          type: boolean
    ListAuditLogsResponse:
      description: Paginated API response containing list of audit logs with hash chain integrity.
      type: object
      required:
      - logs
      - count
      properties:
        count:
          type: integer
          minimum: 0
        logs:
          type: array
          items:
            $ref: '#/components/schemas/AuditLogResponse'
    ListCircuitsResponse:
      description: Paginated API response containing list of circuits with metadata.
      type: object
      required:
      - circuits
      - count
      properties:
        circuits:
          type: array
          items:
            $ref: '#/components/schemas/CircuitResponse'
        count:
          type: integer
          minimum: 0
    ListEventsResponse:
      description: Paginated API response containing list of lifecycle events with filters.
      type: object
      required:
      - events
      - count
      properties:
        count:
          type: integer
          minimum: 0
        events:
          type: array
          items:
            $ref: '#/components/schemas/EventResponse'
    ListItemsResponse:
      description: Paginated API response containing list of items with DFIDs and metadata.
      type: object
      required:
      - items
      - count
      properties:
        count:
          type: integer
          minimum: 0
        items:
          type: array
          items:
            $ref: '#/components/schemas/ItemResponse'
    ListMembersResponse:
      description: API response containing list of circuit members with roles and permissions.
      type: object
      required:
      - members
      - count
      properties:
        count:
          type: integer
          minimum: 0
        members:
          type: array
          items:
            $ref: '#/components/schemas/CircuitMemberResponse'
    ListMerkleTreesResponse:
      description: Paginated API response containing list of merkle trees with root hashes.
      type: object
      required:
      - trees
      - count
      properties:
        count:
          type: integer
          minimum: 0
        trees:
          type: array
          items:
            $ref: '#/components/schemas/MerkleTreeResponse'
    ListSnapshotsResponse:
      description: Paginated API response containing list of snapshots with metadata.
      type: object
      required:
      - snapshots
      - count
      properties:
        count:
          type: integer
          minimum: 0
        snapshots:
          type: array
          items:
            $ref: '#/components/schemas/SnapshotResponse'
    MergeItemsRequest:
      description: Request payload to merge two items. Requires secondary_dfid and merge strategy.
      type: object
      required:
      - secondary_dfid
      - strategy
      properties:
        secondary_dfid:
          type: string
          description: DFID of the secondary item to merge into the primary
        strategy:
          type: string
          description: 'Merge strategy: "append", "keep_first", or "overwrite"'
        user_id:
          type: string
          format: uuid
          description: User performing the merge operation
          nullable: true
    MergeItemsResponse:
      description: API response confirming item merge with primary and secondary DFIDs.
      type: object
      required:
      - merged_item
      - message
      properties:
        merged_item:
          $ref: '#/components/schemas/Item'
        message:
          type: string
          description: Success message
    ItemRelationshipRecord:
      description: Relationship record between two items (merge/split/related).
      type: object
      required:
      - id
      - primary_item_id
      - related_item_id
      - relationship_type
      - created_at
      properties:
        id:
          type: string
          format: uuid
        primary_item_id:
          type: string
          format: uuid
        related_item_id:
          type: string
          format: uuid
        relationship_type:
          type: string
          enum:
          - duplicate
          - derived
          - related
        confidence_score:
          type: number
          format: double
          nullable: true
        created_at:
          type: string
          format: date-time
    MerkleNode:
      description: Node in the merkle tree representing hashed data with left/right children.
      type: object
      required:
      - id
      - tree_id
      - node_hash
      - node_type
      - level
      - position
      - created_at
      properties:
        created_at:
          type: string
          format: date-time
        data_hash:
          type: string
          nullable: true
        data_reference:
          nullable: true
        id:
          type: string
          format: uuid
        left_child_id:
          type: string
          format: uuid
          nullable: true
        level:
          type: integer
          format: int32
        node_hash:
          type: string
        node_type:
          type: string
        parent_id:
          type: string
          format: uuid
          nullable: true
        position:
          type: integer
          format: int32
        right_child_id:
          type: string
          format: uuid
          nullable: true
        tree_id:
          type: string
          format: uuid
    MerkleProof:
      description: Cryptographic proof path from leaf to root for data verification.
      type: object
      required:
      - id
      - tree_id
      - leaf_hash
      - leaf_data
      - proof_path
      - proof_positions
      - root_hash
      - is_valid
      - created_at
      properties:
        created_at:
          type: string
          format: date-time
        id:
          type: string
          format: uuid
        is_valid:
          type: boolean
        leaf_data: {}
        leaf_hash:
          type: string
        proof_path: {}
        proof_positions: {}
        root_hash:
          type: string
        tree_id:
          type: string
          format: uuid
        verified_at:
          type: string
          format: date-time
          nullable: true
    MerkleTree:
      description: Cryptographic data structure using BLAKE3 hashing for snapshot integrity verification.
      type: object
      required:
      - id
      - tree_type
      - resource_type
      - root_hash
      - height
      - leaf_count
      - hash_algorithm
      - created_at
      - updated_at
      properties:
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        hash_algorithm:
          type: string
        height:
          type: integer
          format: int32
        id:
          type: string
          format: uuid
        leaf_count:
          type: integer
          format: int32
        metadata:
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_type:
          type: string
          enum:
          - snapshot
          - circuit
          - audit
          - event
          - item
          - mixed
        root_hash:
          type: string
        snapshot_id:
          type: string
          format: uuid
          nullable: true
        tree_type:
          type: string
          enum:
          - snapshot
          - circuit
          - audit_batch
          - event_batch
          - item_batch
        updated_at:
          type: string
          format: date-time
    MerkleTreeResponse:
      description: API response containing merkle tree details including root hash and leaf count.
      type: object
      required:
      - id
      - tree_type
      - resource_type
      - root_hash
      - height
      - leaf_count
      - hash_algorithm
      - created_at
      - updated_at
      properties:
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        hash_algorithm:
          type: string
        height:
          type: integer
          format: int32
        id:
          type: string
          format: uuid
        leaf_count:
          type: integer
          format: int32
        metadata:
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_type:
          type: string
          enum:
          - snapshot
          - circuit
          - audit
          - event
          - item
          - mixed
        root_hash:
          type: string
        snapshot_id:
          type: string
          format: uuid
          nullable: true
        tree_type:
          type: string
          enum:
          - snapshot
          - circuit
          - audit_batch
          - event_batch
          - item_batch
        updated_at:
          type: string
          format: date-time
    MerkleVerification:
      description: Result of verifying data against merkle tree root hash.
      type: object
      required:
      - id
      - tree_id
      - verification_type
      - leaf_hash
      - expected_root
      - actual_root
      - is_valid
      - created_at
      properties:
        actual_root:
          type: string
        created_at:
          type: string
          format: date-time
        error_message:
          type: string
          nullable: true
        expected_root:
          type: string
        id:
          type: string
          format: uuid
        is_valid:
          type: boolean
        leaf_hash:
          type: string
        proof_id:
          type: string
          format: uuid
          nullable: true
        tree_id:
          type: string
          format: uuid
        verification_time_ms:
          type: integer
          format: int32
          nullable: true
        verification_type:
          type: string
        verified_by:
          type: string
          format: uuid
          nullable: true
    ProofResponse:
      description: Cryptographic proof response for data verification.
      type: object
      required:
      - id
      - tree_id
      - leaf_hash
      - leaf_data
      - proof_path
      - proof_positions
      - root_hash
      - is_valid
      - created_at
      properties:
        created_at:
          type: string
          format: date-time
        id:
          type: string
          format: uuid
        is_valid:
          type: boolean
        leaf_data: {}
        leaf_hash:
          type: string
        proof_path: {}
        proof_positions: {}
        root_hash:
          type: string
        tree_id:
          type: string
          format: uuid
        verified_at:
          type: string
          format: date-time
          nullable: true
    RecentActivity:
      description: Recent activity entries for dashboard display.
      type: object
      required:
      - id
      - user_id
      - activity_type
      - activity_count
      - last_activity_at
      - created_at
      properties:
        activity_count:
          type: integer
          format: int32
        activity_type:
          type: string
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        id:
          type: string
          format: uuid
        last_activity_at:
          type: string
          format: date-time
        user_id:
          type: string
          format: uuid
    RestorationResponse:
      description: Result of data restoration from snapshot or backup.
      type: object
      required:
      - id
      - snapshot_id
      - restored_by
      - restoration_type
      - status
      - created_at
      properties:
        completed_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        error_message:
          type: string
          nullable: true
        id:
          type: string
          format: uuid
        pre_restore_snapshot_id:
          type: string
          format: uuid
          nullable: true
        restoration_type:
          type: string
        restore_metadata:
          nullable: true
        restored_by:
          type: string
          format: uuid
        snapshot_id:
          type: string
          format: uuid
        status:
          type: string
        target_resource_id:
          type: string
          format: uuid
          nullable: true
    RetentionPolicyResponse:
      description: API response containing retention policy details and affected snapshots count.
      type: object
      required:
      - id
      - snapshot_type
      - retention_days
      - auto_archive
      - is_active
      - created_at
      - updated_at
      properties:
        auto_archive:
          type: boolean
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        id:
          type: string
          format: uuid
        is_active:
          type: boolean
        max_snapshots:
          type: integer
          format: int32
          nullable: true
        resource_type:
          type: string
          nullable: true
        retention_days:
          type: integer
          format: int32
        snapshot_type:
          type: string
        updated_at:
          type: string
          format: date-time
    Snapshot:
      description: Point-in-time capture of item or circuit state for versioning and rollback.
      type: object
      required:
      - id
      - snapshot_type
      - resource_type
      - snapshot_name
      - snapshot_data
      - created_by
      - created_at
      - is_archived
      - checksum
      properties:
        archived_at:
          type: string
          format: date-time
          nullable: true
        checksum:
          type: string
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        created_by:
          type: string
          format: uuid
        description:
          type: string
          nullable: true
        expires_at:
          type: string
          format: date-time
          nullable: true
        id:
          type: string
          format: uuid
        is_archived:
          type: boolean
        metadata:
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_type:
          type: string
        snapshot_data: {}
        snapshot_name:
          type: string
        snapshot_type:
          type: string
    SnapshotComparison:
      description: Comparison result between two snapshots showing differences and changes.
      type: object
      required:
      - id
      - snapshot_a_id
      - snapshot_b_id
      - comparison_type
      - diff_data
      - created_at
      properties:
        comparison_type:
          type: string
        created_at:
          type: string
          format: date-time
        diff_data: {}
        id:
          type: string
          format: uuid
        snapshot_a_id:
          type: string
          format: uuid
        snapshot_b_id:
          type: string
          format: uuid
        summary:
          nullable: true
    SnapshotResponse:
      description: API response containing snapshot details including data, merkle root, and retention policy.
      type: object
      required:
      - id
      - snapshot_type
      - resource_type
      - snapshot_name
      - snapshot_data
      - created_by
      - created_at
      - is_archived
      - checksum
      properties:
        archived_at:
          type: string
          format: date-time
          nullable: true
        checksum:
          type: string
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        created_by:
          type: string
          format: uuid
        description:
          type: string
          nullable: true
        expires_at:
          type: string
          format: date-time
          nullable: true
        id:
          type: string
          format: uuid
        is_archived:
          type: boolean
        metadata:
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_type:
          type: string
        snapshot_data: {}
        snapshot_name:
          type: string
        snapshot_type:
          type: string
    SnapshotRestoration:
      description: Result of restoring data from a snapshot including affected resources.
      type: object
      required:
      - id
      - snapshot_id
      - restored_by
      - restoration_type
      - status
      - created_at
      properties:
        completed_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        error_message:
          type: string
          nullable: true
        id:
          type: string
          format: uuid
        pre_restore_snapshot_id:
          type: string
          format: uuid
          nullable: true
        restoration_type:
          type: string
        restore_metadata:
          nullable: true
        restored_by:
          type: string
          format: uuid
        snapshot_id:
          type: string
          format: uuid
        status:
          type: string
        target_resource_id:
          type: string
          format: uuid
          nullable: true
    SnapshotRetentionPolicy:
      description: Policy defining how long snapshots are retained before automatic deletion.
      type: object
      required:
      - id
      - snapshot_type
      - retention_days
      - auto_archive
      - is_active
      - created_at
      - updated_at
      properties:
        auto_archive:
          type: boolean
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        id:
          type: string
          format: uuid
        is_active:
          type: boolean
        max_snapshots:
          type: integer
          format: int32
          nullable: true
        resource_type:
          type: string
          nullable: true
        retention_days:
          type: integer
          format: int32
        snapshot_type:
          type: string
        updated_at:
          type: string
          format: date-time
    SplitItemRequest:
      description: Request payload to split an item into two. Creates new item with new DFID.
      type: object
      required:
      - value_chain
      - country
      - year
      - metadata
      properties:
        country:
          type: string
          description: Country code for the new item
        metadata:
          description: Metadata for the new item
        user_id:
          type: string
          format: uuid
          description: User performing the split operation
          nullable: true
        value_chain:
          type: string
          description: Value chain for the new item
        year:
          type: integer
          format: int32
          description: Year for the new item
    SplitItemResponse:
      description: API response containing original DFID and new DFID after split operation.
      type: object
      required:
      - source_item
      - new_item
      - message
      properties:
        message:
          type: string
          description: Success message
        new_item:
          $ref: '#/components/schemas/Item'
        source_item:
          $ref: '#/components/schemas/Item'
    TrustLevel:
      type: string
      description: Trust level of the data source for conflict resolution
      enum:
      - SanitaryAgency
      - Certifier
      - Processor
      - Producer
      - Unknown
    UnmergeItemRequest:
      description: Request payload to restore a previously merged item. Reverses merge operation.
      type: object
      properties:
        user_id:
          type: string
          format: uuid
          description: User performing the unmerge operation
          nullable: true
    UnmergeItemResponse:
      description: API response confirming unmerge with restored item DFID and status.
      type: object
      required:
      - restored_item
      - message
      properties:
        message:
          type: string
          description: Success message
        restored_item:
          $ref: '#/components/schemas/Item'
    UpdateCircuitRequest:
      description: Request payload to update circuit details. Allows changing name, description, metadata, and status.
      type: object
      properties:
        description:
          type: string
          nullable: true
        ip_address:
          type: string
          nullable: true
        metadata:
          nullable: true
        name:
          type: string
          nullable: true
        settings:
          nullable: true
        status:
          type: string
          nullable: true
        user_id:
          type: string
          format: uuid
          nullable: true
        visibility:
          type: string
          nullable: true
    UpdateEventStatusRequest:
      description: Request payload to update event processing status (pending, processing, completed, failed).
      type: object
      required:
      - status
      properties:
        error_message:
          type: string
          nullable: true
        status:
          type: string
          enum:
          - processing
          - completed
          - failed
    UpdateItemRequest:
      description: Request payload to update item metadata, tags, and status. DFID and circuit_id are immutable.
      type: object
      required:
      - metadata
      properties:
        ip_address:
          type: string
          nullable: true
        metadata: {}
        user_id:
          type: string
          format: uuid
          nullable: true
    UpdateItemStatusRequest:
      description: Request payload to update item lifecycle status (pending, active, inactive, archived).
      type: object
      required:
      - status
      properties:
        ip_address:
          type: string
          nullable: true
        status:
          type: string
          enum:
          - pending
          - active
          - inactive
          - archived
        user_id:
          type: string
          format: uuid
          nullable: true
    UpdateMemberRequest:
      description: Request payload to update a member's role or custom permissions in a circuit.
      type: object
      properties:
        permissions:
          nullable: true
        role:
          type: string
          nullable: true
        updated_by:
          type: string
          format: uuid
          nullable: true
    UpdateRestorationStatusRequest:
      description: Request payload to update restoration operation status.
      type: object
      required:
      - status
      properties:
        error_message:
          type: string
          nullable: true
        status:
          type: string
    UpdateWebhookInput:
      description: Request payload to update webhook configuration including URL, events, and retry settings.
      type: object
      properties:
        events:
          type: array
          items:
            type: string
          nullable: true
        headers:
          nullable: true
        is_active:
          type: boolean
          nullable: true
        name:
          type: string
          nullable: true
        retry_config:
          allOf:
          - $ref: '#/components/schemas/WebhookRetryConfig'
          nullable: true
        secret:
          type: string
          nullable: true
        url:
          type: string
          nullable: true
    UserSession:
      description: User session information including login time and activity.
      type: object
      required:
      - id
      - user_id
      - started_at
      - last_activity_at
      - is_active
      properties:
        ended_at:
          type: string
          format: date-time
          nullable: true
        id:
          type: string
          format: uuid
        ip_address:
          type: string
          nullable: true
        is_active:
          type: boolean
        last_activity_at:
          type: string
          format: date-time
        session_token:
          type: string
          nullable: true
        started_at:
          type: string
          format: date-time
        user_agent:
          type: string
          nullable: true
        user_id:
          type: string
          format: uuid
    VerificationHistoryResponse:
      description: History of verification attempts with timestamps and results.
      type: object
      required:
      - verifications
      - count
      properties:
        count:
          type: integer
          minimum: 0
        verifications:
          type: array
          items:
            $ref: '#/components/schemas/MerkleVerification'
    VerificationResponse:
      description: Result of cryptographic verification with validity status.
      type: object
      required:
      - is_valid
      - computed_root
      - expected_root
      properties:
        computed_root:
          type: string
        expected_root:
          type: string
        is_valid:
          type: boolean
    VerifyProofRequest:
      description: Request payload to verify cryptographic proof against data.
      type: object
      required:
      - leaf_hash
      - proof_path
      - proof_positions
      - expected_root
      properties:
        expected_root:
          type: string
        leaf_hash:
          type: string
        proof_path:
          type: array
          items:
            type: string
        proof_positions:
          type: array
          items:
            type: integer
            format: int32
    Webhook:
      description: HTTP callback configuration for receiving real-time event notifications.
      type: object
      required:
      - id
      - circuit_id
      - name
      - url
      - events
      - is_active
      - created_by
      - created_at
      - updated_at
      properties:
        circuit_id:
          type: string
          format: uuid
        created_at:
          type: string
          format: date-time
        created_by:
          type: string
          format: uuid
        events: {}
        headers:
          nullable: true
        id:
          type: string
          format: uuid
        is_active:
          type: boolean
        name:
          type: string
        retry_config:
          nullable: true
        secret:
          type: string
          nullable: true
        updated_at:
          type: string
          format: date-time
        url:
          type: string
    WebhookDelivery:
      description: Record of webhook delivery attempt including status, response, and retry count.
      type: object
      required:
      - id
      - webhook_id
      - event_id
      - attempt_number
      - status
      - request_body
      - created_at
      properties:
        attempt_number:
          type: integer
          format: int32
        created_at:
          type: string
          format: date-time
        delivered_at:
          type: string
          format: date-time
          nullable: true
        error_message:
          type: string
          nullable: true
        event_id:
          type: string
          format: uuid
        id:
          type: string
          format: uuid
        next_retry_at:
          type: string
          format: date-time
          nullable: true
        request_body: {}
        request_headers:
          nullable: true
        response_body:
          type: string
          nullable: true
        response_headers:
          nullable: true
        response_status_code:
          type: integer
          format: int32
          nullable: true
        status:
          type: string
        webhook_id:
          type: string
          format: uuid
    WebhookRetryConfig:
      description: Retry configuration for failed webhook deliveries (max attempts, backoff strategy).
      type: object
      required:
      - max_retries
      - retry_delay
      properties:
        max_retries:
          type: integer
          format: int32
        retry_delay:
          type: integer
          format: int32
    WebhookStats:
      description: Statistics for webhook deliveries including success rate and failure count.
      type: object
      required:
      - webhook_id
      - total_deliveries
      - successful_deliveries
      - failed_deliveries
      - updated_at
      properties:
        average_response_time_ms:
          type: integer
          format: int32
          nullable: true
        failed_deliveries:
          type: integer
          format: int64
        last_delivery_at:
          type: string
          format: date-time
          nullable: true
        last_failure_at:
          type: string
          format: date-time
          nullable: true
        last_success_at:
          type: string
          format: date-time
          nullable: true
        successful_deliveries:
          type: integer
          format: int64
        total_deliveries:
          type: integer
          format: int64
        updated_at:
          type: string
          format: date-time
        webhook_id:
          type: string
          format: uuid
paths:
  /health:
    get:
      tags:
      - Health
      summary: Gateway health check
      description: Check if the gateway is running
      responses:
        '200':
          description: Gateway is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  service:
                    type: string
                    example: gateway-service
                  status:
                    type: string
                    example: healthy
                  timestamp:
                    type: string
                    format: date-time
  /auth/register:
    post:
      tags:
      - Authentication
      summary: Register a new user
      description: |
        Create a new user account in the DeFarm platform.

        **What it does:**
        - Creates a new user with email/password credentials
        - Automatically creates a default workspace for the user
        - Assigns the user as workspace owner
        - Generates initial authentication tokens

        **Requirements:**
        - Valid email address (must be unique)
        - Strong password (minimum 8 characters)
        - Full name for identification

        **Response:**
        - User profile with workspace information
        - Access token (JWT, expires in 15 minutes)
        - Refresh token (expires in 30 days)

        **Use cases:**
        - New farmer/organization onboarding
        - Team member registration
        - API client setup

        **Example:**
        ```json
        POST /auth/register
        {
          "email": "farmer@example.com",
          "password": "SecurePass123!",
          "full_name": "JoÃ£o Silva"
        }
        ```
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - email
              - password
              - full_name
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  minLength: 8
                  example: SecurePassword123!
                full_name:
                  type: string
                  example: John Doe
                name:
                  type: string
                  deprecated: true
                  description: Deprecated alias for full_name
                workspace_slug:
                  type: string
                  nullable: true
                  description: Optional custom workspace slug
                workspace_name:
                  type: string
                  nullable: true
                  description: Optional custom workspace name
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /auth/login:
    post:
      tags:
      - Authentication
      summary: Login with email and password
      description: |
        Authenticate with email and password to obtain JWT tokens.

        **What it does:**
        - Validates credentials against database
        - Generates fresh access and refresh tokens
        - Returns user profile and workspace information
        - Tracks login session for activity monitoring

        **Token Lifetimes:**
        - **Access Token**: 15 minutes (use for API requests)
        - **Refresh Token**: 30 days (use to get new access tokens)

        **Security:**
        - Passwords are hashed with bcrypt
        - Failed login attempts are rate-limited
        - Tokens are signed with HS256 (configurable to RS256)

        **Response includes:**
        - User ID, email, full name, avatar
        - Workspace ID, name, slug, tier, and user's role
        - Both access and refresh tokens

        **Example:**
        ```json
        POST /auth/login
        {
          "email": "farmer@example.com",
          "password": "SecurePass123!"
        }

        Response:
        {
          "access_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
          "refresh_token": "28214fc8c04cba687dc7...",
          "token_type": "Bearer",
          "expires_in": 900,
          "user": {
            "id": "40a66997-b090-...",
            "email": "farmer@example.com",
            "workspace": { ... }
          }
        }
        ```

        **Next step:** Add `Authorization: Bearer <access_token>` header to all `/api/*` requests
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - email
              - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  example: SecurePassword123!
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /auth/refresh:
    post:
      tags:
      - Authentication
      summary: Refresh access token
      description: |
        Exchange a refresh token for a new access token.

        **When to use:**
        - Access token expired (returns 401 Unauthorized)
        - Before token expires (proactive refresh)
        - On app startup if refresh token is still valid

        **How it works:**
        1. Send refresh token in request body
        2. Backend validates refresh token signature and expiration
        3. If valid, generates new access token (15 min lifetime)
        4. Optionally rotates refresh token for enhanced security

        **Best practices:**
        - Store refresh token securely (httpOnly cookie or encrypted storage)
        - Never send refresh token to third parties
        - Refresh proactively before access token expires
        - Handle 401 errors by attempting refresh before re-login

        **Example:**
        ```json
        POST /auth/refresh
        {
          "refresh_token": "28214fc8c04cba687dc778e6d8a1e8e2..."
        }

        Response:
        {
          "access_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
          "expires_in": 900
        }
        ```

        **Error handling:**
        - 401: Refresh token expired â†’ redirect to login
        - 400: Invalid token format â†’ redirect to login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - refresh_token
              properties:
                refresh_token:
                  type: string
                  example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
      responses:
        '200':
          description: New access token issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid or expired refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /auth/logout:
    post:
      tags:
      - Authentication
      summary: Logout (revoke refresh token)
      description: |
        Invalidate current session and revoke tokens.

        **What it does:**
        - Marks refresh token as revoked in database
        - Ends current user session
        - Tracks logout event in activity log
        - Clears any server-side session data

        **Client responsibilities:**
        - Delete stored tokens from local storage
        - Clear any cached user data
        - Redirect to login page
        - Remove Authorization headers from future requests

        **Security notes:**
        - Access tokens remain valid until expiration (15 min)
        - Refresh token is immediately revoked and cannot be used
        - Use this for explicit user logout or security incidents

        **Example:**
        ```json
        POST /auth/logout
        Authorization: Bearer <access_token>
        ```

        **Response:** 204 No Content (success)
      security:
      - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - refresh_token
              properties:
                refresh_token:
                  type: string
      responses:
        '204':
          description: Successfully logged out
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/circuits:
    get:
      tags:
      - circuits
      summary: GET /circuits?name=...&owner_id=...
      description: |
        List circuits (permission-based data repositories) with optional filters.

        **What is a Circuit:**
        A circuit is a multi-tenant data repository that isolates data by organization/workspace.
        It serves as the primary permission boundary in DeFarm's RBAC system.

        **What it does:**
        - Lists all circuits the authenticated user has access to
        - Supports filtering by owner, organization, type, and status
        - Returns paginated results (limit/offset)
        - Includes circuit metadata, member count, and permissions

        **RBAC Requirements:**
        - User must have `read_circuits` permission in at least one circuit
        - Only returns circuits where user is a member
        - Circuit owners see all fields, members see limited fields

        **Common filters:**
        - `owner_id`: Filter by circuit owner UUID
        - `organization_id`: Filter by organization
        - `circuit_type`: Filter by type (private, shared, public, enterprise)
        - `status`: Filter by status (active, inactive, archived)
        - `limit/offset`: Pagination (default: 50 per page)

        **Use cases:**
        - Dashboard: List user's accessible circuits
        - Admin panel: Organization-wide circuit management
        - API integration: Discover available data repositories

        **Example:**
        ```
        GET /api/circuits?organization_id=abc123&status=active&limit=20
        Authorization: Bearer <access_token>
        ```
      operationId: list_circuits
      parameters:
      - name: owner_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: organization_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: circuit_type
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: status
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: limit
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      - name: offset
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: List of circuits
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListCircuitsResponse'
        '400':
          description: Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    post:
      tags:
      - circuits
      summary: POST /circuits
      description: |
        Create a new circuit (permission-based data repository).

        **What it does:**
        - Creates a new multi-tenant data isolation boundary
        - Automatically assigns creator as circuit owner
        - Sets up default RBAC permissions
        - Generates unique circuit ID
        - Creates audit trail for circuit creation

        **Required fields:**
        - `name`: Human-readable circuit name (unique within workspace)
        - `circuit_type`: Type of circuit (private, shared, public, enterprise)
        - `visibility`: Circuit visibility (private, restricted, public)
        - `owner_id`: Owner user UUID

        **Optional fields:**
        - `description`: Circuit purpose and context
        - `metadata`: Custom JSON metadata (tags, categories, etc.)
        - `settings`: Circuit-specific configuration

        **RBAC:**
        - User must be workspace owner or admin
        - Creator automatically becomes circuit owner with full permissions
        - Circuit owner can then invite members with specific roles

        **After creation:**
        1. Add members via `POST /api/circuits/{id}/members`
        2. Create items within circuit via `POST /api/items`
        3. Track events via `POST /api/events`

        **Use cases:**
        - New private or shared circuit onboarding
        - Public/enterprise circuit setup
        - Project-specific data isolation

        **Example:**
        ```json
        POST /api/circuits
        {
          "name": "Fazenda SÃ£o JosÃ© - Soja 2025",
          "circuit_type": "private",
          "visibility": "private",
          "owner_id": "abc-123-...",
          "description": "Safra de soja 2025 da Fazenda SÃ£o JosÃ©",
          "metadata": {
            "crop": "soy",
            "season": "2025",
            "area_hectares": 500
          }
        }
        ```
      operationId: create_circuit
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCircuitRequest'
        required: true
      responses:
        '201':
          description: Circuit created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CircuitResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/items:
    get:
      tags:
      - items
      summary: GET /items?dfid=...&value_chain=...
      description: |
        List items (physical/digital assets) with optional filters.

        **What is an Item:**
        An item represents a physical or digital asset in the supply chain, uniquely identified by a DFID.
        Items can be farm products, livestock, equipment, land parcels, or any trackable entity.

        **What it returns:**
        - List of items with DFID, status, metadata
        - Owner and circuit information
        - Current lifecycle stage
        - Relationship graph (parent/child items)
        - Pagination metadata

        **RBAC Requirements:**
        - User must have `read_items` permission in the circuit
        - Only returns items from circuits where user is a member
        - Filters automatically apply circuit boundaries

        **Common filters:**
        - `value_chain`: Filter by value chain (BEEF, SOY, CORN, etc.)
        - `country`: ISO 3166-1 alpha-2 country code (BR, US, etc.)
        - `year`: Item creation year
        - `status`: Item status (pending, active, inactive, archived, local, merged, split)
        - `circuit_id`: Filter by specific circuit
        - `owner_id`: Filter by item owner
        - `limit/offset`: Pagination (default: 50 per page)

        **Use cases:**
        - Dashboard: View all items in a circuit
        - Search: Find items by DFID or metadata
        - Reporting: Filter items by value chain, year, status

        **Example:**
        ```
        GET /api/items?value_chain=BEEF&country=BR&year=2025&status=active&limit=20
        Authorization: Bearer <access_token>
        ```
      operationId: list_items
      parameters:
      - name: value_chain
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: country
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: year
        in: query
        required: false
        schema:
          type: integer
          format: int32
          nullable: true
      - name: status
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: circuit_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: owner_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: limit
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      - name: offset
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: List of items
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListItemsResponse'
        '400':
          description: Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    post:
      tags:
      - items
      summary: POST /items
      description: |
        Create a new item with automatic DFID generation.

        **What it does:**
        - Generates unique DFID for the item
        - Creates item record in specified circuit
        - If a canonical identifier already exists, enriches the existing item
        - Sets up initial lifecycle stage
        - Creates audit trail entry
        - Validates DFID checksum (BLAKE3)

        **Required fields:**
        - `value_chain`: Value chain code (BEEF, SOY, CORN, etc.)
        - `country`: ISO 3166-1 alpha-2 country code
        - `circuit_id`: Target circuit UUID
        - `metadata`: Item-specific data (weight, breed, location, etc.)
        - `identifiers` (optional): Canonical/contextual identifiers (SISBOV, CPF, chip, etc.)

        **Optional fields:**
        - `parent_dfid`: Parent item DFID (for derived items)
        - `status`: Initial status (default: 'active')
        - `tags`: Searchable tags for categorization

        **DFID Format:**
        Generated DFID follows: `DFID-{VC}-{CC}-{YYYY}-{NNNNNN}-{CS}`
        - Example: `DFID-BEEF-BR-2025-000123-a3f2c1`

        **RBAC Requirements:**
        - User must have `create_items` permission in the circuit
        - Circuit must be active (not archived)
        - Workspace must have available DFID quota

        **After creation:**
        1. System detects events from metadata and records them automatically
        2. Create snapshots via `POST /api/snapshots`
        3. Establish relationships (merge/split operations)

        **Use cases:**
        - Register new farm product (batch of soybeans)
        - Add livestock to tracking system
        - Create land parcel record

        **Example:**
        ```json
        POST /api/items
        {
          "value_chain": "BEEF",
          "country": "BR",
          "circuit_id": "abc-123-...",
          "metadata": {
            "breed": "Nelore",
            "weight_kg": 450,
            "birth_date": "2024-01-15",
            "farm_name": "Fazenda SÃ£o JosÃ©"
          },
          "tags": ["cattle", "organic", "2025-batch"]
        }

        Response (when created):
        {
          "item": {
            "id": "item-uuid-...",
            "dfid": "DFID-BEEF-BR-2025-000789-f4e1a2",
            "status": "active"
          },
          "events": [],
          "was_deduplicated": false
        }
        ```
      operationId: create_item
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateItemRequest'
        required: true
      responses:
        '200':
          description: Item already existed and was enriched
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateItemResponse'
        '201':
          description: Item created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateItemResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/dfid/generate:
    post:
      tags:
      - DFID
      summary: Generate DFID
      description: Generate a new DeFarm Identifier
      security:
      - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - value_chain
              - country
              - year
              properties:
                value_chain:
                  type: string
                  example: BEEF
                country:
                  type: string
                  example: BR
                year:
                  type: integer
                  example: 2025
      responses:
        '200':
          description: DFID generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  dfid:
                    type: string
                    example: DFID-BEEF-BR-2025-000123-a3f2c1
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/dfid/validate:
    post:
      tags:
      - DFID
      summary: Validate DFID
      description: Check if a DFID is valid
      security:
      - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - dfid
              properties:
                dfid:
                  type: string
                  example: DFID-BEEF-BR-2025-000123-a3f2c1
      responses:
        '200':
          description: Validation result
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                  dfid:
                    type: string
                  components:
                    type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /swagger-ui:
    get:
      tags:
      - Documentation
      summary: API Documentation UI
      description: Interactive API documentation (Swagger UI)
      responses:
        '200':
          description: Swagger UI HTML
  /api-docs/openapi.json:
    get:
      tags:
      - Documentation
      summary: OpenAPI Specification
      description: Complete OpenAPI 3.0 specification for all endpoints
      responses:
        '200':
          description: OpenAPI JSON
          content:
            application/json:
              schema:
                type: object
  /api/activity/circuit/{circuit_id}:
    get:
      tags:
      - activity
      summary: Get circuit activity feed
      operationId: get_circuit_activity_feed
      parameters:
      - name: circuit_id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      - name: actor_id
        in: query
        description: Filter by actor
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: resource_type
        in: query
        description: Filter by resource type
        required: false
        schema:
          type: string
          nullable: true
      - name: action
        in: query
        description: Filter by action
        required: false
        schema:
          type: string
          nullable: true
      - name: limit
        in: query
        description: Maximum results
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      - name: offset
        in: query
        description: Results offset
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: Circuit activity feed retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ActivityFeed'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/activity/public:
    get:
      tags:
      - activity
      summary: Get public activity feed
      operationId: get_public_activity_feed
      parameters:
      - name: circuit_id
        in: query
        description: Filter by circuit
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: resource_type
        in: query
        description: Filter by resource type
        required: false
        schema:
          type: string
          nullable: true
      - name: action
        in: query
        description: Filter by action
        required: false
        schema:
          type: string
          nullable: true
      - name: limit
        in: query
        description: Maximum results
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      - name: offset
        in: query
        description: Results offset
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: Public activity feed retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ActivityFeed'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/activity/recent:
    get:
      tags:
      - activity
      summary: Get recent activity cache
      operationId: get_recent_activity
      parameters:
      - name: user_id
        in: query
        description: User ID
        required: true
        schema:
          type: string
          format: uuid
      - name: limit
        in: query
        description: 'Maximum results (default: 10)'
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: Recent activity retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/RecentActivity'
        '400':
          description: Missing user_id parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/activity/summaries:
    get:
      tags:
      - activity
      summary: Get activity summaries
      operationId: get_activity_summaries
      parameters:
      - name: circuit_id
        in: query
        description: Filter by circuit
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: user_id
        in: query
        description: Filter by user
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: start_date
        in: query
        description: Start date (YYYY-MM-DD)
        required: true
        schema:
          type: string
      - name: end_date
        in: query
        description: End date (YYYY-MM-DD)
        required: true
        schema:
          type: string
      - name: summary_type
        in: query
        description: Summary type (daily, weekly, monthly)
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Activity summaries retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ActivitySummary'
        '400':
          description: Invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/activity/user/{user_id}:
    get:
      tags:
      - activity
      summary: Get user activity feed
      operationId: get_user_activity_feed
      parameters:
      - name: user_id
        in: path
        description: User ID
        required: true
        schema:
          type: string
          format: uuid
      - name: circuit_id
        in: query
        description: Filter by circuit
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: resource_type
        in: query
        description: Filter by resource type
        required: false
        schema:
          type: string
          nullable: true
      - name: action
        in: query
        description: Filter by action
        required: false
        schema:
          type: string
          nullable: true
      - name: limit
        in: query
        description: Maximum results
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      - name: offset
        in: query
        description: Results offset
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: Activity feed retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ActivityFeed'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/admin/api-keys:
    post:
      tags:
      - admin
      summary: POST /admin/api-keys
      description: 'Create a new API key for circuit access


        **âš ï¸ SECURITY**: The API key is only returned once and cannot be retrieved
        later!'
      operationId: create_api_key
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateApiKeyRequest'
        required: true
      responses:
        '201':
          description: API key created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateApiKeyResponse'
        '500':
          description: Internal server error
  /api/admin/api-keys/{circuit_id}:
    get:
      tags:
      - admin
      summary: GET /admin/api-keys/:circuit_id
      description: 'List API keys for a circuit


        Returns metadata about API keys without revealing the actual key values.'
      operationId: list_api_keys
      parameters:
      - name: circuit_id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: List of API keys returned
        '500':
          description: Internal server error
  /api/admin/api-keys/{id}/metrics:
    get:
      tags:
      - admin
      summary: GET /admin/api-keys/{id}/metrics
      description: Get API key metrics (admin only)
      operationId: get_api_key_metrics
      parameters:
      - name: id
        in: path
        description: API key ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: API key metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiKeyMetricsResponse'
        '403':
          description: Admin key required
        '404':
          description: API key not found
        '500':
          description: Internal server error
  /api/admin/canonical-identifiers:
    post:
      tags:
      - admin
      summary: POST /admin/canonical-identifiers
      description: Create or enable a canonical identifier type for a value chain
      operationId: create_canonical_identifier
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCanonicalIdentifierRequest'
        required: true
      responses:
        '201':
          description: Canonical identifier created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CanonicalIdentifierResponse'
        '403':
          description: Admin key required
        '500':
          description: Internal server error
  /api/admin/canonical-identifiers/value-chain/{value_chain}:
    get:
      tags:
      - admin
      summary: GET /admin/canonical-identifiers/value-chain/{value_chain}
      description: List canonical identifier types for a value chain
      operationId: list_canonical_identifiers
      parameters:
      - name: value_chain
        in: path
        description: Value chain code
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Canonical identifiers
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CanonicalIdentifierResponse'
        '403':
          description: Admin key required
        '500':
          description: Internal server error
  /api/admin/canonical-identifiers/{id}:
    patch:
      tags:
      - admin
      summary: PATCH /admin/canonical-identifiers/{id}
      description: Enable or disable a canonical identifier type
      operationId: update_canonical_identifier
      parameters:
      - name: id
        in: path
        description: Canonical identifier ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCanonicalIdentifierRequest'
        required: true
      responses:
        '200':
          description: Canonical identifier updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CanonicalIdentifierResponse'
        '403':
          description: Admin key required
        '500':
          description: Internal server error
  /api/partner/api-keys:
    post:
      tags:
      - partner-api-keys
      summary: POST /api/partner/api-keys
      description: |-
        Create a new API key for your circuit.

        The API key is only shown once at creation time.
      operationId: create_partner_api_key
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePartnerApiKeyRequest'
        required: true
      responses:
        '201':
          description: API key created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreatePartnerApiKeyResponse'
        '400':
          description: Invalid request
        '401':
          description: Unauthorized - invalid or missing JWT token
        '403':
          description: Forbidden - insufficient permissions in circuit
        '500':
          description: Internal server error
      security:
      - bearerAuth: []
    get:
      tags:
      - partner-api-keys
      summary: GET /api/partner/api-keys
      description: List your API keys across all circuits
      operationId: list_partner_api_keys
      responses:
        '200':
          description: List of your API keys
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PartnerApiKeyResponse'
        '401':
          description: Unauthorized
        '500':
          description: Internal server error
      security:
      - bearerAuth: []
  /api/partner/api-keys/{id}:
    delete:
      tags:
      - partner-api-keys
      summary: DELETE /api/partner/api-keys/{id}
      description: Revoke (deactivate) an API key
      operationId: revoke_partner_api_key
      parameters:
      - name: id
        in: path
        description: API key ID to revoke
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '204':
          description: API key revoked successfully
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - you don't own this key
        '404':
          description: API key not found
        '500':
          description: Internal server error
      security:
      - bearerAuth: []
  /api/partner/api-keys/{id}/metrics:
    get:
      tags:
      - partner-api-keys
      summary: GET /api/partner/api-keys/{id}/metrics
      description: Get metrics for a specific API key
      operationId: get_partner_api_key_metrics
      parameters:
      - name: id
        in: path
        description: API key ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: API key metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiKeyMetricsResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - you don't own this key
        '404':
          description: API key not found
        '500':
          description: Internal server error
      security:
      - bearerAuth: []
  /api/audit:
    get:
      tags:
      - audit
      summary: GET /audit?user_id=...&action=...
      description: |
        List immutable audit logs with optional filters.

        **What is the Audit System:**
        DeFarm uses a hash-chained audit trail to provide tamper-proof records of all operations.
        Each audit log entry is cryptographically linked to the previous entry, making it impossible
        to modify or delete past records without detection.

        **What it returns:**
        - Audit log entries with timestamps
        - Actor (user) who performed the action
        - Action type (CREATE, UPDATE, DELETE, etc.)
        - Resource affected (item, circuit, member, etc.)
        - Old and new values (for updates)
        - Hash chain linkage (previous_hash, current_hash)
        - Circuit context

        **RBAC Requirements:**
        - User must be a member of the circuit (any role)
        - Only returns audit logs from circuits where user has access
        - System-level audits visible only to workspace admins

        **Common filters:**
        - `user_id`: Filter by actor who performed actions
        - `action`: Filter by action type (CREATE, UPDATE, DELETE, etc.)
        - `resource_type`: Filter by resource (item, circuit, member, event, etc.)
        - `resource_id`: Filter by specific resource UUID
        - `circuit_id`: Filter by circuit
        - `limit/offset`: Pagination (default: 50 per page)

        **Use cases:**
        - Compliance and regulatory reporting
        - Security investigation and forensics
        - Data lineage and provenance tracking
        - Verify data integrity

        **Example:**
        ```
        GET /api/audit?action=UPDATE&resource_type=item&circuit_id=abc-123&limit=20
        Authorization: Bearer <access_token>
        ```
      operationId: list_audit_logs
      parameters:
      - name: user_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: action
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: resource_type
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: resource_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: circuit_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: limit
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      - name: offset
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: List of audit logs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListAuditLogsResponse'
        '400':
          description: Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/audit/verify:
    get:
      tags:
      - audit
      summary: GET /audit/verify?limit=...
      description: |
        Verify cryptographic hash chain integrity of audit logs.

        **What it does:**
        - Validates hash chain linkage between audit log entries
        - Detects any tampering or data corruption
        - Reports broken links and inconsistencies
        - Verifies each entry's hash against computed hash

        **How hash chain works:**
        ```
        Entry 1: hash = BLAKE3(timestamp + action + data + "genesis")
        Entry 2: hash = BLAKE3(timestamp + action + data + Entry1.hash)
        Entry 3: hash = BLAKE3(timestamp + action + data + Entry2.hash)
        ...
        ```

        **RBAC Requirements:**
        - User must have `read_audit` permission
        - Only verifies audit logs from accessible circuits
        - System-level verification requires admin privileges

        **Verification process:**
        1. Fetches audit log entries (most recent N or all)
        2. Recomputes hash for each entry
        3. Compares computed hash with stored hash
        4. Validates linkage (entry.previous_hash == previous_entry.hash)
        5. Reports any mismatches or gaps

        **Query parameters:**
        - `limit`: Maximum number of logs to verify (default: all accessible)

        **Response includes:**
        - Total logs verified
        - Verification status (valid, invalid, partial)
        - List of broken links (if any)
        - First and last verified entry
        - Verification timestamp

        **Use cases:**
        - Compliance audit requirements
        - Detect data tampering attempts
        - Verify system integrity
        - Forensic investigation

        **Example:**
        ```
        GET /api/audit/verify?limit=1000
        Authorization: Bearer <access_token>

        Response:
        {
          "status": "valid",
          "total_verified": 1000,
          "broken_links": [],
          "first_entry": "2025-01-01T00:00:00Z",
          "last_entry": "2025-02-08T15:30:00Z"
        }
        ```
      operationId: verify_hash_chain
      parameters:
      - name: limit
        in: query
        description: Maximum number of logs to verify
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: Hash chain verification result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HashChainVerificationResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/audit/{id}:
    get:
      tags:
      - audit
      summary: GET /audit/:id
      description: |
        Retrieve detailed information about a specific audit log entry.

        **What it returns:**
        - Audit log UUID and timestamp
        - Actor (user) who performed the action
        - Action type (CREATE, UPDATE, DELETE, etc.)
        - Resource type and ID (item, circuit, member, etc.)
        - Old and new values (for updates)
        - Context and metadata
        - Hash chain information:
          - `current_hash`: BLAKE3 hash of this entry
          - `previous_hash`: Hash of previous entry (linkage)
        - Circuit context

        **RBAC Requirements:**
        - User must have `read_audit` permission
        - User must be a member of the circuit where audit log belongs
        - Returns 403 if user lacks access

        **Audit log fields:**
        - `id`: UUID of audit log entry
        - `timestamp`: When action occurred (UTC)
        - `user_id`: Actor who performed action
        - `action`: Action type (CREATE, UPDATE, DELETE, etc.)
        - `resource_type`: Type of resource (item, circuit, etc.)
        - `resource_id`: UUID of affected resource
        - `old_value`: State before action (JSON)
        - `new_value`: State after action (JSON)
        - `metadata`: Additional context
        - `current_hash`: BLAKE3 hash for integrity
        - `previous_hash`: Link to previous entry

        **Use cases:**
        - Audit log detail page
        - Investigate specific data change
        - Verify hash chain linkage
        - Forensic analysis

        **Example:**
        ```
        GET /api/audit/550e8400-e29b-41d4-a716-446655440000
        Authorization: Bearer <access_token>
        ```
      operationId: get_audit_log
      parameters:
      - name: id
        in: path
        description: Audit log ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Audit log found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditLogResponse'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Audit log not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/circuits/{id}:
    get:
      tags:
      - circuits
      summary: GET /circuits/:id
      description: |
        Retrieve detailed information about a specific circuit.

        **What it returns:**
        - Circuit metadata (name, type, description, status)
        - Owner and organization information
        - Member count and your role/permissions
        - Circuit settings and configuration
        - Creation and update timestamps

        **RBAC Requirements:**
        - User must be a member of the circuit (any role)
        - Requires `read_circuits` permission
        - Different roles see different levels of detail

        **Visibility by role:**
        - **Owner/Admin**: Full details including all metadata and settings
        - **Editor/Member**: Basic info and operational fields
        - **Viewer**: Read-only fields only

        **Use cases:**
        - Circuit dashboard page
        - Permission checks before operations
        - Audit trail and compliance reports

        **Example:**
        ```
        GET /api/circuits/abc-123-def-456
        Authorization: Bearer <access_token>
        ```
      operationId: get_circuit
      parameters:
      - name: id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Circuit found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CircuitResponse'
        '404':
          description: Circuit not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    put:
      tags:
      - circuits
      summary: PUT /circuits/:id
      description: |
        Update circuit details and configuration.

        **What you can update:**
        - Circuit name (must remain unique within workspace)
        - Description and metadata
        - Circuit type (with restrictions)
        - Settings and configuration
        - Status (active â†’ archived, etc.)

        **RBAC Requirements:**
        - User must have `admin` permission in the circuit
        - Only circuit owners/admins can update
        - Some fields require owner-level access

        **Restricted fields:**
        - `workspace_id`: Cannot be changed (permanent association)
        - `created_at`: Immutable timestamp
        - `owner_id`: Use transfer ownership endpoint instead

        **Audit trail:**
        - All updates are logged in audit trail
        - Includes actor, timestamp, old/new values
        - Immutable record for compliance

        **Use cases:**
        - Update circuit metadata as project evolves
        - Archive completed supply chains
        - Adjust settings and configuration

        **Example:**
        ```json
        PUT /api/circuits/abc-123-def-456
        {
          "name": "Fazenda SÃ£o JosÃ© - Soja 2025 (Atualizado)",
          "description": "Safra expandida com Ã¡rea adicional",
          "metadata": {
            "crop": "soy",
            "season": "2025",
            "area_hectares": 750
          },
          "status": "active"
        }
        ```
      operationId: update_circuit
      parameters:
      - name: id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCircuitRequest'
        required: true
      responses:
        '200':
          description: Circuit updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CircuitResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Circuit not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      tags:
      - circuits
      summary: DELETE /circuits/:id
      description: |
        Soft delete a circuit (archive it, but preserve data).

        **What it does:**
        - Marks circuit as archived (status = 'archived')
        - Preserves all data for audit/compliance
        - Removes from active circuit lists
        - Maintains data integrity for related items/events
        - Creates audit log entry

        **RBAC Requirements:**
        - User must be circuit owner
        - Requires workspace owner approval for production circuits
        - Cannot delete circuits with active workflows

        **Data preservation:**
        - Circuit data remains in database
        - Items within circuit are preserved
        - Audit trail remains accessible
        - Can be restored by system admin

        **Cascade behavior:**
        - Does NOT delete items (items remain accessible)
        - Does NOT delete events or audit logs
        - Member access is revoked immediately
        - Webhooks are disabled

        **Use cases:**
        - Decommission completed supply chains
        - Remove test/demo circuits
        - Compliance with data retention policies

        **Important:**
        This is a soft delete. For hard delete (permanent data removal), contact support.

        **Example:**
        ```
        DELETE /api/circuits/abc-123-def-456
        Authorization: Bearer <access_token>
        ```
      operationId: delete_circuit
      parameters:
      - name: id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '204':
          description: Circuit archived successfully
        '404':
          description: Circuit not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/circuits/{id}/members:
    get:
      tags:
      - circuits
      summary: GET /circuits/:id/members
      description: |
        List all members of a circuit with their roles and permissions.

        **What it returns:**
        For each member:
        - User ID, email, name, avatar
        - Role (owner, admin, editor, member, viewer)
        - Permissions object (read, write, admin, manage_members, etc.)
        - Custom permissions (if overriding role defaults)
        - Join date and last activity

        **RBAC Requirements:**
        - User must be a member of the circuit
        - All members can see member list (transparency)
        - Permission details visible only to admins

        **Member roles:**
        - **Owner**: Full control, cannot be removed, typically 1 per circuit
        - **Admin**: Can manage members and settings
        - **Editor**: Can create/edit items and events
        - **Member**: Can create items within scope
        - **Viewer**: Read-only access

        **Use cases:**
        - Member management dashboard
        - Permission audit and compliance
        - Team collaboration views

        **Example:**
        ```
        GET /api/circuits/abc-123-def-456/members
        Authorization: Bearer <access_token>
        ```
      operationId: list_members
      parameters:
      - name: id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: List of circuit members
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListMembersResponse'
        '404':
          description: Circuit not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    post:
      tags:
      - circuits
      summary: POST /circuits/:id/members
      description: |
        Add a new member to a circuit with specified role and permissions.

        **What it does:**
        - Adds user to circuit with specified role
        - Grants standard permissions for that role
        - Optionally sets custom permissions
        - Creates audit log entry
        - Sends notification to added user

        **Required fields:**
        - `user_id`: UUID of user to add (must exist in workspace)
        - `role`: One of: owner, admin, editor, member, viewer

        **Optional fields:**
        - `custom_permissions`: Override standard role permissions
        - `notify`: Send invitation email (default: true)

        **RBAC Requirements:**
        - User must have `manage_members` permission
        - Only admins/owners can add members
        - Cannot add duplicate members (409 Conflict)

        **Standard permissions by role:**
        - **Admin**: Full permissions except ownership transfer
        - **Editor**: Create/edit items, create events, read all
        - **Member**: Create items, read circuits/items
        - **Viewer**: Read-only access to circuits and items

        **Use cases:**
        - Onboard new team members
        - Grant external auditors view access
        - Add suppliers/farmers to supply chain

        **Example:**
        ```json
        POST /api/circuits/abc-123-def-456/members
        {
          "user_id": "user-uuid-123",
          "role": "editor",
          "notify": true
        }
        ```
      operationId: add_member
      parameters:
      - name: id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddMemberRequest'
        required: true
      responses:
        '201':
          description: Member added successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CircuitMemberResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Circuit not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Member already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/circuits/{id}/members/{user_id}:
    get:
      tags:
      - circuits
      summary: GET /circuits/:id/members/:user_id
      description: |
        Get detailed information about a specific circuit member.

        **What it returns:**
        - User profile (ID, email, name, avatar)
        - Current role in the circuit
        - Standard permissions from role
        - Custom permissions (if any overrides exist)
        - Join date and activity timestamps
        - Invitation details (invited_by, accepted_at)

        **RBAC Requirements:**
        - User must be a member of the circuit
        - All members can view other member details
        - Custom permissions visible only to admins

        **Use cases:**
        - Member profile page
        - Permission verification before operations
        - Activity tracking and auditing

        **Example:**
        ```
        GET /api/circuits/abc-123/members/user-456
        Authorization: Bearer <access_token>
        ```
      operationId: get_member
      parameters:
      - name: id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      - name: user_id
        in: path
        description: User ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Member found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CircuitMemberResponse'
        '404':
          description: Member not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    put:
      tags:
      - circuits
      summary: PUT /circuits/:id/members/:user_id
      description: |
        Update a circuit member's role or permissions.

        **What you can update:**
        - Role (promote/demote between roles)
        - Custom permissions (override role defaults)
        - Member status (active, suspended)

        **RBAC Requirements:**
        - User must have `manage_members` permission
        - Only admins/owners can update members
        - Cannot demote circuit owner
        - Cannot modify your own permissions

        **Role changes:**
        - Viewer â†’ Member â†’ Editor â†’ Admin â†’ Owner
        - Role change updates standard permissions automatically
        - Custom permissions are preserved unless explicitly cleared

        **Permission overrides:**
        - Can grant/revoke specific permissions
        - Custom permissions take precedence over role defaults
        - Use carefully - prefer standard roles for clarity

        **Audit trail:**
        - All permission changes are logged
        - Includes actor, timestamp, old/new values
        - Visible in audit log

        **Use cases:**
        - Promote trusted members to admin
        - Grant temporary elevated access
        - Revoke specific permissions without changing role

        **Example:**
        ```json
        PUT /api/circuits/abc-123/members/user-456
        {
          "role": "admin",
          "custom_permissions": null
        }
        ```
      operationId: update_member
      parameters:
      - name: id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      - name: user_id
        in: path
        description: User ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateMemberRequest'
        required: true
      responses:
        '200':
          description: Member updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CircuitMemberResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Member not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      tags:
      - circuits
      summary: DELETE /circuits/:id/members/:user_id
      description: |
        Remove a member from a circuit (revoke all access).

        **What it does:**
        - Immediately revokes all circuit access
        - Removes user from circuit member list
        - Preserves audit trail of member's past actions
        - Creates audit log entry for removal
        - Sends notification to removed user

        **RBAC Requirements:**
        - User must have `manage_members` permission
        - Only admins/owners can remove members
        - Cannot remove circuit owner
        - Cannot remove yourself (use leave endpoint)

        **Data preservation:**
        - Member's past actions remain in audit trail
        - Items created by member are NOT deleted
        - Events created by member are preserved
        - Attribution remains for compliance

        **Cascade behavior:**
        - Access revoked immediately (active sessions invalidated)
        - Member cannot access circuit via API or UI
        - Pending invitations are cancelled
        - Webhooks for this user are disabled

        **Use cases:**
        - Remove team members who left organization
        - Revoke access after contract ends
        - Remove users who violated policies

        **Query parameters:**
        - `removed_by`: UUID of user performing removal (for audit)

        **Example:**
        ```
        DELETE /api/circuits/abc-123/members/user-456?removed_by=admin-789
        Authorization: Bearer <access_token>
        ```
      operationId: remove_member
      parameters:
      - name: id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      - name: user_id
        in: path
        description: User ID
        required: true
        schema:
          type: string
          format: uuid
      - name: removed_by
        in: query
        description: User performing the removal
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      responses:
        '204':
          description: Member removed successfully
        '404':
          description: Member not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/events:
    get:
      tags:
      - events
      summary: GET /events?event_type=...&circuit_id=...
      description: |
        List lifecycle events for items with optional filters.

        **What is an Event:**
        Events capture state changes and actions in the item lifecycle (created, updated, transferred, certified, etc.).
        They provide an immutable audit trail of all operations on items.

        **What it returns:**
        - Event type and timestamp
        - Associated item (DFID and UUID)
        - Circuit and user who triggered event
        - Event-specific metadata
        - Processing status (pending, completed, failed)

        **RBAC Requirements:**
        - User must have `read_events` permission in the circuit
        - Only returns events from circuits where user is a member
        - Filters automatically apply circuit boundaries

        **Common event types:**
        - `item_created`: Item registered in system
        - `item_updated`: Metadata changed
        - `item_transferred`: Ownership or custody changed
        - `item_certified`: Quality certification recorded
        - `item_merged`: Item merged with another
        - `item_split`: Item divided into multiple items
        - `snapshot_created`: Data snapshot created

        **Common filters:**
        - `event_type`: Filter by specific event type
        - `source_type`: Filter by source (item, circuit, user, system)
        - `circuit_id`: Events in specific circuit
        - `item_id`: Events for specific item
        - `user_id`: Events triggered by specific user
        - `status`: Processing status (pending, completed, failed)
        - `limit/offset`: Pagination (default: 50 per page)

        **Use cases:**
        - Audit trail and compliance reporting
        - Track item lifecycle from creation to disposal
        - Investigate data changes and anomalies

        **Example:**
        ```
        GET /api/events?event_type=item_transferred&circuit_id=abc-123&limit=20
        Authorization: Bearer <access_token>
        ```
      operationId: list_events
      parameters:
      - name: event_type
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: source_type
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: circuit_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: item_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: user_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: status
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: limit
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      - name: offset
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: List of events
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListEventsResponse'
        '400':
          description: Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/events/{id}:
    get:
      tags:
      - events
      summary: GET /events/:id
      description: |
        Retrieve detailed information about a specific lifecycle event.

        **What it returns:**
        - Event UUID and timestamp
        - Event type and source type
        - Associated item (DFID, UUID, name)
        - Circuit and user who triggered event
        - Full event payload/metadata
        - Processing status and error details (if failed)
        - Audit trail information

        **RBAC Requirements:**
        - User must have `read_events` permission in the circuit
        - User must be a member of the circuit where event occurred

        **Event metadata includes:**
        - Old and new values (for update events)
        - Actor information (who performed the action)
        - Context and reason (if provided)
        - Validation results
        - Related events (parent/child operations)

        **Use cases:**
        - Event detail page
        - Investigate failed processing
        - Audit trail analysis
        - Compliance verification

        **Example:**
        ```
        GET /api/events/550e8400-e29b-41d4-a716-446655440000
        Authorization: Bearer <access_token>
        ```
      operationId: get_event
      parameters:
      - name: id
        in: path
        description: Event ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Event found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventResponse'
        '404':
          description: Event not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/events/{id}/status:
    put:
      tags:
      - events
      summary: PUT /events/:id/status
      description: |
        Update event processing status (typically for async workflows).

        **What it does:**
        - Updates event processing status
        - Records processing results or errors
        - Triggers downstream workflows
        - Updates audit trail

        **Valid status transitions:**
        - `pending` â†’ `processing`: Event being processed
        - `pending` â†’ `failed`: Failure before processing completes
        - `processing` â†’ `completed`: Successfully completed
        - `processing` â†’ `failed`: Processing error occurred

        **RBAC Requirements:**
        - User must have `manage_events` permission (admin only)
        - Typically used by system/worker processes
        - Not commonly used by end users

        **Request body includes:**
        - `status`: New status value
        - `error_message`: Error details (if failed)
        - `processed_at`: Timestamp (optional)

        **Use cases:**
        - Async event processing workflows
        - Webhook delivery status updates
        - External integration callbacks
        - Retry failed operations

        **Example:**
        ```json
        PUT /api/events/550e8400-e29b-41d4-a716-446655440000/status
        {
          "status": "completed",
          "processed_at": "2025-02-08T15:30:00Z"
        }
        ```

        **Error example:**
        ```json
        {
          "status": "failed",
          "error_message": "External API timeout after 30s"
        }
        ```
      operationId: update_event_status
      parameters:
      - name: id
        in: path
        description: Event ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateEventStatusRequest'
        required: true
      responses:
        '204':
          description: Event status updated successfully
        '400':
          description: Invalid status value
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Event not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/items/bulk:
    post:
      tags:
      - items
      summary: Bulk ingest items from CSV file
      description: |
        Create multiple items at once from CSV file upload.

        **What it does:**
        - Parses CSV file with item data
        - Generates DFID for each item automatically
        - Creates all items in a single transaction
        - Validates data and enforces schema
        - Returns detailed receipt with success/failure counts

        **CSV Format:**
        - Required multipart fields: `file` (CSV) and `circuit_id` (UUID)
        - Required CSV columns: value_chain, country
        - Optional columns: metadata.*, tags, status
        - Header row must match expected field names
        - UTF-8 encoding required

        **RBAC Requirements:**
        - User must have `create_items` permission in target circuit(s)
        - All items must belong to circuits where user is a member
        - Workspace must have sufficient DFID quota

        **Processing:**
        - Validates all rows before inserting any
        - Atomic transaction (all succeed or all fail)
        - Returns detailed error report for failed rows
        - Generates audit trail for bulk operation

        **Use cases:**
        - Migrate items from legacy system
        - Import harvest/production data
        - Bulk onboarding for large farms

        **Example CSV:**
        ```csv
        value_chain,country,circuit_id,metadata.breed,metadata.weight_kg
        BEEF,BR,abc-123,Nelore,450
        BEEF,BR,abc-123,Angus,520
        ```
      operationId: bulk_ingest
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
              - file
              - circuit_id
              properties:
                file:
                  type: string
                  format: binary
                circuit_id:
                  type: string
                  format: uuid
      responses:
        '201':
          description: Ingestion completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestionReceipt'
        '400':
          description: Invalid CSV or missing fields
        '401':
          description: Missing or invalid authentication
        '403':
          description: Permission denied
        '500':
          description: Internal server error
  /api/items/{dfid}/merge:
    post:
      tags:
      - workflows
      summary: POST /items/{dfid}/merge
      description: |
        Merge two items together (deduplication or consolidation).

        **What it does:**
        - Combines two items into one (primary remains, secondary archived)
        - Merges metadata based on strategy (append, override, keep_primary)
        - Preserves audit trail for both items
        - Updates relationships (parent/child items)
        - Creates "merged" event in lifecycle

        **Merge strategies:**
        - `append`: Concatenate arrays, keep all fields
        - `override`: Secondary values override primary
        - `keep_primary`: Keep primary values, discard secondary
        - `custom`: Provide field-by-field merge rules

        **RBAC Requirements:**
        - User must have `update_items` permission in both circuits
        - Items must be in same workspace (cross-workspace not allowed)
        - Cannot merge already-merged items

        **What happens to secondary item:**
        - Status changed to 'merged'
        - DFID preserved for audit trail
        - Relationship created: secondary â†’ merged_into â†’ primary
        - Data remains accessible (read-only)

        **Use cases:**
        - Deduplicate accidentally created items
        - Consolidate batches from same source
        - Combine split shipments

        **Example:**
        ```json
        POST /api/items/DFID-BEEF-BR-2025-000123-abc/merge
        {
          "secondary_dfid": "DFID-BEEF-BR-2025-000456-def",
          "strategy": "append",
          "user_id": "550e8400-e29b-41d4-a716-446655440000"
        }
        ```
      operationId: merge_items
      parameters:
      - name: dfid
        in: path
        description: Primary item DFID (master)
        required: true
        schema:
          type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MergeItemsRequest'
        required: true
      responses:
        '200':
          description: Items merged successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MergeItemsResponse'
        '400':
          description: Invalid request or merge not possible
        '404':
          description: Item not found
        '500':
          description: Internal server error
  /api/items/{dfid}/relationships:
    get:
      tags:
      - workflows
      summary: GET /items/{dfid}/relationships
      description: |
        Get all relationships for an item (parent/child, merges, splits).

        **What it returns:**
        - Parent items (source/origin)
        - Child items (derived products)
        - Merged items (consolidated duplicates)
        - Split items (divided portions)
        - Related items (linked for traceability)

        **Relationship types:**
        - `parent_of`: This item is source for child items
        - `child_of`: This item derived from parent
        - `merged_into`: This item was merged into another
        - `split_from`: This item was split from source
        - `related_to`: Linked for traceability (e.g., same batch)

        **RBAC Requirements:**
        - User must have `read_items` permission
        - Only returns relationships where user has access to both items
        - Relationships cross circuit boundaries (within workspace)

        **Use cases:**
        - Build supply chain graph/tree
        - Trace item origins and destinations
        - Audit data integrity and lineage

        **Example response:**
        ```json
        [
          {
            "relationship_type": "child_of",
            "related_dfid": "DFID-BEEF-BR-2025-000123-abc",
            "created_at": "2025-02-08T10:30:00Z"
          },
          {
            "relationship_type": "split_from",
            "related_dfid": "DFID-BEEF-BR-2025-000456-def",
            "created_at": "2025-02-10T14:22:00Z"
          }
        ]
        ```
      operationId: get_item_relationships
      parameters:
      - name: dfid
        in: path
        description: Item DFID
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Relationships retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ItemRelationshipRecord'
        '404':
          description: Item not found
        '500':
          description: Internal server error
  /api/items/{dfid}/split:
    post:
      tags:
      - workflows
      summary: POST /items/{dfid}/split
      description: |
        Split an item into two separate items (division/transfer).

        **What it does:**
        - Creates new item with new DFID
        - Both items remain active (original + new)
        - Establishes parent-child relationship
        - Updates metadata based on split parameters
        - Creates "split" event in lifecycle

        **Required fields:**
        - `value_chain`: Value chain for new item (typically same as original)
        - `country`: Country code for new item
        - `year`: Year for DFID generation
        - `metadata`: Metadata for new item

        **RBAC Requirements:**
        - User must have `update_items` permission in source circuit
        - User must have `create_items` permission in target circuit
        - Items can be split across circuits (within same workspace)

        **Use cases:**
        - Divide batch for different buyers
        - Transfer portion to another farm
        - Separate products from same source

        **What happens:**
        - Original item status remains 'active'
        - New item created with `split_from` relationship
        - Metadata copied to new item (can be overridden)
        - Audit trail records split operation

        **Example:**
        ```json
        POST /api/items/DFID-BEEF-BR-2025-000123-abc/split
        {
          "value_chain": "BEEF",
          "country": "BR",
          "year": 2025,
          "metadata": {
            "note": "Split for transfer to Buyer X",
            "weight_kg": 225
          },
          "user_id": "550e8400-e29b-41d4-a716-446655440000"
        }

        Response:
        {
          "original_dfid": "DFID-BEEF-BR-2025-000123-abc",
          "new_dfid": "DFID-BEEF-BR-2025-000789-xyz"
        }
        ```
      operationId: split_item
      parameters:
      - name: dfid
        in: path
        description: Source item DFID to split
        required: true
        schema:
          type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SplitItemRequest'
        required: true
      responses:
        '201':
          description: Item split successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SplitItemResponse'
        '400':
          description: Invalid request
        '404':
          description: Item not found
        '500':
          description: Internal server error
  /api/items/{dfid}/unmerge:
    post:
      tags:
      - workflows
      summary: POST /items/{dfid}/unmerge
      description: |
        Unmerge a previously merged item (restore both original items).

        **What it does:**
        - Restores secondary item to 'active' status
        - Removes 'merged_into' relationship
        - Reverts metadata changes from merge
        - Creates "unmerged" event in lifecycle
        - Preserves audit trail of original merge

        **RBAC Requirements:**
        - User must have `update_items` permission in both circuits
        - Only merged items can be unmerged (status = 'merged')
        - Cannot unmerge if primary item was subsequently merged/archived

        **What gets restored:**
        - Secondary item status: merged â†’ active
        - Secondary item metadata (pre-merge snapshot)
        - Independent access to both items

        **When unmerge is blocked:**
        - Primary item was archived
        - Primary item was merged into another
        - More than 90 days elapsed since merge (configurable)

        **Use cases:**
        - Undo accidental merge
        - Restore items mistakenly deduplicated
        - Correct data entry errors

        **Example:**
        ```json
        POST /api/items/DFID-BEEF-BR-2025-000456-def/unmerge
        {
          "user_id": "550e8400-e29b-41d4-a716-446655440000"
        }

        Response:
        {
          "primary_dfid": "DFID-BEEF-BR-2025-000123-abc",
          "restored_dfid": "DFID-BEEF-BR-2025-000456-def",
          "status": "unmerged"
        }
        ```
      operationId: unmerge_item
      parameters:
      - name: dfid
        in: path
        description: Merged item DFID to restore
        required: true
        schema:
          type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UnmergeItemRequest'
        required: true
      responses:
        '200':
          description: Item unmerged successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnmergeItemResponse'
        '400':
          description: Item is not merged
        '404':
          description: Item not found
        '500':
          description: Internal server error
  /api/items/{id}:
    get:
      tags:
      - items
      summary: GET /items/:id
      description: |
        Retrieve detailed information about a specific item by UUID.

        **What it returns:**
        - DFID (unique identifier)
        - Status (pending, active, inactive, archived, local, merged, split)
        - Metadata (item-specific data)
        - Identifiers (canonical + contextual)
        - Circuit ID and ownership
        - Lifecycle events (creation, updates, state changes)
        - Relationships (parent/child items)

        **RBAC Requirements:**
        - User must have `read_items` permission in the circuit
        - User must be a member of the item's circuit

        **Note:**
        This endpoint uses UUID (internal database ID), not DFID.
        To query by DFID, use `GET /api/items?dfid=DFID-...` instead.

        **Use cases:**
        - Item detail page
        - Verify item existence before operations
        - Audit trail review

        **Example:**
        ```
        GET /api/items/550e8400-e29b-41d4-a716-446655440000
        Authorization: Bearer <access_token>
        ```
      operationId: get_item
      parameters:
      - name: id
        in: path
        description: Item ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Item found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ItemDetailsResponse'
        '404':
          description: Item not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    put:
      tags:
      - items
      summary: PUT /items/:id
      description: |
        Update item metadata and properties.

        **What you can update:**
        - Metadata fields (weight, location, notes, etc.)
        - Tags for categorization
        - Status (active, archived, etc.)
        - Custom properties

        **Immutable fields:**
        - `dfid`: Cannot be changed (permanent identifier)
        - `circuit_id`: Cannot be moved between circuits
        - `created_at`: Immutable timestamp
        - Value chain, country, year (embedded in DFID)

        **RBAC Requirements:**
        - User must have `update_items` permission in the circuit
        - Only item owner or circuit admin can update

        **Audit trail:**
        - All updates are logged with old/new values
        - Tracks actor, timestamp, and change reason
        - Immutable record for compliance

        **Use cases:**
        - Update item properties as data becomes available
        - Correct data entry errors
        - Add notes and observations

        **Example:**
        ```json
        PUT /api/items/550e8400-e29b-41d4-a716-446655440000
        {
          "metadata": {
            "weight_kg": 475,
            "location": "Warehouse B",
            "quality_grade": "A"
          },
          "tags": ["certified", "organic", "2025-Q1"]
        }
        ```
      operationId: update_item
      parameters:
      - name: id
        in: path
        description: Item ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateItemRequest'
        required: true
      responses:
        '200':
          description: Item updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ItemResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Item not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      tags:
      - items
      summary: DELETE /items/:id
      description: |
        Soft delete an item (archive it, but preserve data).

        **What it does:**
        - Changes item status to 'archived'
        - Preserves all data for audit/compliance
        - Removes from active item lists
        - Maintains DFID and relationships
        - Creates audit log entry

        **RBAC Requirements:**
        - User must have `delete_items` permission in the circuit
        - Only item owner or circuit admin can delete
        - Cannot delete items with active dependencies

        **Data preservation:**
        - Item data remains in database
        - DFID remains valid and cannot be reused
        - Audit trail remains accessible
        - Relationships are preserved
        - Can be restored by system admin

        **Cascade behavior:**
        - Child items are NOT deleted (remain active)
        - Events remain accessible
        - Snapshots remain accessible
        - Merkle tree verification still works

        **When deletion is blocked:**
        - Item has active child items that depend on it
        - Item is referenced in active workflows
        - Circuit is archived

        **Use cases:**
        - Remove test/demo data
        - Decommission deprecated items
        - Compliance with data retention policies

        **Important:**
        This is a soft delete. For hard delete (permanent removal), contact support.

        **Example:**
        ```
        DELETE /api/items/550e8400-e29b-41d4-a716-446655440000?user_id=admin-uuid
        Authorization: Bearer <access_token>
        ```
      operationId: delete_item
      parameters:
      - name: id
        in: path
        description: Item ID
        required: true
        schema:
          type: string
          format: uuid
      - name: user_id
        in: query
        description: User performing the deletion
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      responses:
        '204':
          description: Item archived successfully
        '404':
          description: Item not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/items/{id}/status:
    put:
      tags:
      - items
      summary: PUT /items/:id/status
      description: Update item status
      operationId: update_item_status
      parameters:
      - name: id
        in: path
        description: Item ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateItemStatusRequest'
        required: true
      responses:
        '200':
          description: Item status updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ItemResponse'
        '400':
          description: Invalid status value
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Item not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/merkle-trees:
    get:
      tags:
      - merkle
      summary: GET /merkle-trees
      description: List Merkle trees with optional filters
      operationId: list_merkle_trees
      parameters:
      - name: tree_type
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: resource_type
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: resource_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: circuit_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: snapshot_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: limit
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      - name: offset
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: List of Merkle trees
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListMerkleTreesResponse'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    post:
      tags:
      - merkle
      summary: POST /merkle-trees
      description: Create a new Merkle tree
      operationId: create_merkle_tree
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateMerkleTreeRequest'
        required: true
      responses:
        '201':
          description: Merkle tree created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MerkleTreeResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/merkle-trees/{id}:
    get:
      tags:
      - merkle
      summary: GET /merkle-trees/:id
      description: Get a Merkle tree by ID
      operationId: get_merkle_tree
      parameters:
      - name: id
        in: path
        description: Merkle tree ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Merkle tree found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MerkleTreeResponse'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Merkle tree not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      tags:
      - merkle
      summary: DELETE /merkle-trees/:id
      description: Delete a Merkle tree
      operationId: delete_merkle_tree
      parameters:
      - name: id
        in: path
        description: Merkle tree ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '204':
          description: Merkle tree deleted successfully
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Merkle tree not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/merkle-trees/{id}/generate-proof:
    post:
      tags:
      - merkle
      summary: POST /merkle-trees/:id/generate-proof
      description: Generate a Merkle proof for a leaf
      operationId: generate_proof
      parameters:
      - name: id
        in: path
        description: Merkle tree ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateProofRequest'
        required: true
      responses:
        '201':
          description: Proof generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProofResponse'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Tree or leaf not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/merkle-trees/{id}/verifications:
    get:
      tags:
      - merkle
      summary: GET /merkle-trees/:id/verifications
      description: Get verification history for a tree
      operationId: get_verifications
      parameters:
      - name: id
        in: path
        description: Merkle tree ID
        required: true
        schema:
          type: string
          format: uuid
      - name: limit
        in: query
        description: Maximum number of verifications to return
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: Verification history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerificationHistoryResponse'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Tree not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/merkle-trees/{id}/verify:
    post:
      tags:
      - merkle
      summary: POST /merkle-trees/:id/verify
      description: Verify the entire Merkle tree structure
      operationId: verify_tree
      parameters:
      - name: id
        in: path
        description: Merkle tree ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Tree verification result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerificationResponse'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Tree not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/merkle-trees/{id}/verify-proof:
    post:
      tags:
      - merkle
      summary: POST /merkle-trees/:id/verify-proof
      description: Verify a Merkle proof
      operationId: verify_proof
      parameters:
      - name: id
        in: path
        description: Merkle tree ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerifyProofRequest'
        required: true
      responses:
        '200':
          description: Proof verified
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerificationResponse'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Tree not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/sessions:
    get:
      tags:
      - activity
      summary: Get active sessions for a user
      operationId: get_active_sessions
      parameters:
      - name: user_id
        in: query
        description: User ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Active sessions retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserSession'
        '400':
          description: Missing user_id parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/snapshots:
    get:
      tags:
      - snapshots
      summary: GET /snapshots - List snapshots with filtering
      description: 'List all snapshots from circuits in your workspace with optional
        filtering.


        **Filters**: resource_type, resource_id, circuit_id, snapshot_type, created_by,
        is_archived, limit, offset


        Results include snapshots from all circuits in your workspace that you have
        access to.


        **Example**: `GET /snapshots?snapshot_type=full&is_archived=false&limit=50`


        **Permissions Required**: Access to at least one circuit in your workspace'
      operationId: list_snapshots
      parameters:
      - name: resource_type
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: resource_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: circuit_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: snapshot_type
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: created_by
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: is_archived
        in: query
        required: false
        schema:
          type: boolean
          nullable: true
      - name: limit
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      - name: offset
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: List of snapshots
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListSnapshotsResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    post:
      tags:
      - snapshots
      summary: POST /snapshots - Create a point-in-time snapshot
      description: 'Create a point-in-time snapshot of circuit or item state.


        Snapshots are immutable records of state at a specific moment, useful for:

        - **Version Control**: Track changes over time

        - **Compliance**: Maintain audit trail for regulatory requirements

        - **Disaster Recovery**: Restore to previous known-good state

        - **Data Analysis**: Compare state changes between time periods


        Each snapshot includes:

        - Complete state data (JSON)

        - BLAKE3 checksum for integrity verification

        - Optional expiration date for automatic cleanup

        - Circuit association for access control


        **Permissions Required**: `ManageSnapshots` permission in the target circuit'
      operationId: create_snapshot
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSnapshotRequest'
        required: true
      responses:
        '201':
          description: Snapshot created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SnapshotResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/snapshots/comparisons/{id}:
    get:
      tags:
      - snapshots
      summary: GET /snapshots/comparisons/:id
      description: Get a snapshot comparison by ID
      operationId: get_comparison
      parameters:
      - name: id
        in: path
        description: Comparison ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Comparison found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ComparisonResponse'
        '404':
          description: Comparison not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/snapshots/restorations/{id}/status:
    put:
      tags:
      - snapshots
      summary: PUT /snapshots/restorations/:id/status
      description: Update restoration status
      operationId: update_restoration_status
      parameters:
      - name: id
        in: path
        description: Restoration ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateRestorationStatusRequest'
        required: true
      responses:
        '200':
          description: Restoration status updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestorationResponse'
        '404':
          description: Restoration not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/snapshots/retention-policies:
    get:
      tags:
      - snapshots
      summary: GET /snapshots/retention-policies
      description: Get retention policies for a circuit
      operationId: get_retention_policies
      parameters:
      - name: circuit_id
        in: query
        description: Circuit ID (optional, null for global policies)
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      responses:
        '200':
          description: List of retention policies
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/RetentionPolicyResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/snapshots/retention-policies/{id}/apply:
    post:
      tags:
      - snapshots
      summary: POST /snapshots/retention-policies/:id/apply
      description: Manually apply a retention policy
      operationId: apply_retention_policy
      parameters:
      - name: id
        in: path
        description: Retention policy ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Retention policy applied successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApplyRetentionResponse'
        '404':
          description: Retention policy not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/snapshots/{id}:
    get:
      tags:
      - snapshots
      summary: GET /snapshots/:id - Retrieve a specific snapshot
      description: 'Retrieve a specific snapshot by its unique identifier.


        Returns complete snapshot details including:

        - Snapshot metadata (name, type, timestamps)

        - Complete state data (JSON)

        - BLAKE3 checksum for integrity verification

        - Archival status

        - Expiration date (if set)


        **Use Cases**: Verify integrity, review history, download backup, check metadata


        **Permissions Required**: `ReadCircuits` permission in the snapshot''s circuit'
      operationId: get_snapshot
      parameters:
      - name: id
        in: path
        description: Snapshot ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Snapshot found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SnapshotResponse'
        '404':
          description: Snapshot not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      tags:
      - snapshots
      summary: DELETE /snapshots/:id
      description: Delete a snapshot
      operationId: delete_snapshot
      parameters:
      - name: id
        in: path
        description: Snapshot ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '204':
          description: Snapshot deleted successfully
        '404':
          description: Snapshot not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/snapshots/{id}/archive:
    post:
      tags:
      - snapshots
      summary: POST /snapshots/:id/archive
      description: Archive a snapshot
      operationId: archive_snapshot
      parameters:
      - name: id
        in: path
        description: Snapshot ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Snapshot archived successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SnapshotResponse'
        '404':
          description: Snapshot not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/snapshots/{id}/compare:
    post:
      tags:
      - snapshots
      summary: POST /snapshots/:id/compare - Compare two snapshots
      description: 'Compare two snapshots to analyze changes over time.


        Creates a detailed comparison showing added, removed, and modified data with
        summary statistics.


        **Use Cases**: Audit compliance, change detection, data analysis, quality
        control


        **Note**: Both snapshots must belong to the same circuit.


        **Permissions Required**: `ReadCircuits` permission in the circuit containing
        both snapshots'
      operationId: create_comparison
      parameters:
      - name: id
        in: path
        description: First snapshot ID (snapshot A)
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateComparisonRequest'
        required: true
      responses:
        '201':
          description: Comparison created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ComparisonResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/snapshots/{id}/restore:
    post:
      tags:
      - snapshots
      summary: POST /snapshots/:id/restore - Restore from snapshot (CRITICAL OPERATION)
      description: 'Initiate a restoration operation to rollback to a previous snapshot
        state.


        **âš ï¸ WARNING**: This operation will modify current circuit/item state.


        **Process**: Auto-creates pre-restore snapshot â†’ Validates integrity â†’ Applies
        changes â†’ Tracks status


        **Restoration Types**: full (complete replacement), partial (selective), merge
        (combine with current)


        **Safety Features**: Pre-restore backup, rollback on failure, integrity verification,
        async processing


        **Permissions Required**: `ManageSnapshots` permission in the snapshot''s
        circuit'
      operationId: create_restoration
      parameters:
      - name: id
        in: path
        description: Snapshot ID to restore from
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRestorationRequest'
        required: true
      responses:
        '201':
          description: Restoration created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestorationResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/webhooks:
    get:
      tags:
      - webhooks
      summary: List webhooks
      operationId: list_webhooks
      parameters:
      - name: circuit_id
        in: query
        description: Filter by circuit ID
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: is_active
        in: query
        description: Filter by active status
        required: false
        schema:
          type: boolean
          nullable: true
      responses:
        '200':
          description: Webhooks retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Webhook'
        '403':
          description: Permission denied
        '500':
          description: Internal server error
    post:
      tags:
      - webhooks
      summary: Create a new webhook
      operationId: create_webhook
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWebhookInput'
        required: true
      responses:
        '201':
          description: Webhook created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Webhook'
        '400':
          description: Invalid input
        '403':
          description: Permission denied
        '500':
          description: Internal server error
  /api/webhooks/{id}:
    get:
      tags:
      - webhooks
      summary: Get webhook by ID
      operationId: get_webhook
      parameters:
      - name: id
        in: path
        description: Webhook ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Webhook found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Webhook'
        '403':
          description: Permission denied
        '404':
          description: Webhook not found
        '500':
          description: Internal server error
    put:
      tags:
      - webhooks
      summary: Update webhook
      operationId: update_webhook
      parameters:
      - name: id
        in: path
        description: Webhook ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateWebhookInput'
        required: true
      responses:
        '200':
          description: Webhook updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Webhook'
        '400':
          description: Invalid input
        '403':
          description: Permission denied
        '404':
          description: Webhook not found
        '500':
          description: Internal server error
    delete:
      tags:
      - webhooks
      summary: Delete webhook
      operationId: delete_webhook
      parameters:
      - name: id
        in: path
        description: Webhook ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '204':
          description: Webhook deleted successfully
        '403':
          description: Permission denied
        '404':
          description: Webhook not found
        '500':
          description: Internal server error
  /api/webhooks/{id}/deliveries:
    get:
      tags:
      - webhooks
      summary: Get webhook delivery history
      operationId: get_webhook_deliveries
      parameters:
      - name: id
        in: path
        description: Webhook ID
        required: true
        schema:
          type: string
          format: uuid
      - name: limit
        in: query
        description: Maximum number of deliveries to return
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: Delivery history retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/WebhookDelivery'
        '403':
          description: Permission denied
        '404':
          description: Webhook not found
        '500':
          description: Internal server error
  /api/webhooks/{id}/retry:
    post:
      tags:
      - webhooks
      summary: Trigger manual delivery retry
      operationId: retry_webhook
      parameters:
      - name: id
        in: path
        description: Webhook ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '202':
          description: Retry scheduled
        '403':
          description: Permission denied
        '404':
          description: Webhook not found
        '500':
          description: Internal server error
  /api/webhooks/{id}/stats:
    get:
      tags:
      - webhooks
      summary: Get webhook statistics
      operationId: get_webhook_stats
      parameters:
      - name: id
        in: path
        description: Webhook ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Webhook statistics retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookStats'
        '403':
          description: Permission denied
        '404':
          description: Webhook not found
        '500':
          description: Internal server error
