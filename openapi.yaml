openapi: 3.0.3
info:
  title: DeFarm API Gateway
  description: "**Single entry point for all DeFarm services**\n\nThe Gateway provides:\n\
    - JWT-based authentication\n- Request routing to backend services\n- User context\
    \ injection\n- Rate limiting\n\n## Authentication\n\nMost endpoints require a\
    \ JWT token in the Authorization header:\n```\nAuthorization: Bearer <access_token>\n\
    ```\n\n### Getting Started\n\n1. **Register**: POST `/auth/register`\n2. **Login**:\
    \ POST `/auth/login` \u2192 Returns `access_token` and `refresh_token`\n3. **Use\
    \ token**: Add `Authorization: Bearer <access_token>` to all `/api/*` requests\n\
    4. **Refresh**: POST `/auth/refresh` with `refresh_token` when access token expires\n\
    \n### Token Lifetimes\n- **Access Token**: 15 minutes\n- **Refresh Token**: 30\
    \ days\n"
  version: 1.0.0
  contact:
    name: DeFarm Support
    email: support@defarm.com
servers:
- url: http://gateway.defarm.net:8080
  description: Production (Custom Domain)
- url: https://gateway-service-production-f54d.up.railway.app
  description: Production (Railway Domain)
- url: http://localhost:8000
  description: Local development
tags:
- name: Authentication
  description: User registration, login, and token management
- name: Circuits
  description: Multi-tenant data repositories with RBAC
- name: Items
  description: Agricultural items with traceability
- name: Events
  description: Item state changes and lifecycle events
- name: Audit
  description: Immutable audit trails
- name: DFID
  description: DeFarm Identifier generation and validation
- name: Health
  description: Service health checks
- name: items
  description: Item registry CRUD operations and bulk import
- name: workflows
  description: Item merge, split, unmerge, and relationship tracking
- name: circuits
  description: Circuit and member management
- name: events
  description: Event tracking and lifecycle management
- name: audit
  description: Immutable audit logs with hash chain verification
- name: admin
  description: Administrative operations and API key management
- name: webhooks
  description: Webhook subscriptions and delivery tracking
- name: activity
  description: Activity feeds, sessions, and user tracking
- name: snapshots
  description: Point-in-time snapshots with restore capabilities
- name: merkle
  description: Merkle tree construction and cryptographic verification
- name: compliance
  description: Compliance checks proxy endpoints
- name: Circuit Adapters
  description: Manage adapter configurations per circuit (enable/disable auto-publish to Stellar, IPFS, NFT)
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token obtained from /auth/login
  schemas:
    Error:
      description: Standard error response with error code and message.
      type: object
      required:
      - error
      - message
      properties:
        error:
          type: string
          example: unauthorized
        message:
          type: string
          example: Invalid or expired token
        details:
          type: string
          nullable: true
          description: Optional detailed error context
    WorkspaceInfo:
      type: object
      required:
      - id
      - name
      - slug
      - tier
      - role
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        slug:
          type: string
        tier:
          type: string
        role:
          type: string
          enum:
          - viewer
          - editor
          - admin
          - owner
    UserInfo:
      type: object
      required:
      - id
      - email
      - is_admin
      - is_active
      - workspace
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        full_name:
          type: string
          nullable: true
        avatar_url:
          type: string
          nullable: true
        is_admin:
          type: boolean
          description: Whether user has system-wide admin privileges
          example: false
        is_active:
          type: boolean
          description: Whether user account is active (can login)
          example: true
        workspace:
          $ref: '#/components/schemas/WorkspaceInfo'
    AuthResponse:
      type: object
      required:
      - access_token
      - refresh_token
      - token_type
      - expires_in
      - user
      properties:
        access_token:
          type: string
          description: JWT access token (expires in 15 minutes)
        refresh_token:
          type: string
          description: JWT refresh token (expires in 30 days)
        token_type:
          type: string
          example: Bearer
        expires_in:
          type: integer
          description: Access token lifetime in seconds
          example: 900
        user:
          $ref: '#/components/schemas/UserInfo'
    ActivityFeed:
      description: User activity entry for audit trail and activity feed display.
      type: object
      required:
      - id
      - actor_id
      - action
      - resource_type
      - description
      - is_public
      - created_at
      properties:
        action:
          type: string
        actor_id:
          type: string
          format: uuid
        actor_name:
          type: string
          nullable: true
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        description:
          type: string
        id:
          type: string
          format: uuid
        is_public:
          type: boolean
        metadata:
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_name:
          type: string
          nullable: true
        resource_type:
          type: string
          enum:
          - snapshot
          - circuit
          - audit
          - event
          - item
          - mixed
    ActivitySummary:
      description: Aggregated summary of activities by type and resource for reporting.
      type: object
      required:
      - id
      - summary_date
      - summary_type
      - action_counts
      - resource_counts
      - created_at
      properties:
        action_counts: {}
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        id:
          type: string
          format: uuid
        resource_counts: {}
        summary_date:
          type: string
          format: date
        summary_type:
          type: string
        user_id:
          type: string
          format: uuid
          nullable: true
    AddMemberRequest:
      description: Request payload to add a new member to a circuit. Requires user_id
        and role.
      type: object
      required:
      - user_id
      - role
      properties:
        added_by:
          type: string
          format: uuid
          nullable: true
        permissions:
          nullable: true
        role:
          type: string
          enum:
          - viewer
          - editor
          - admin
          - owner
        user_id:
          type: string
          format: uuid
    ApplyRetentionResponse:
      description: API response confirming retention policy application with affected
        snapshots count.
      type: object
      required:
      - policy_id
      - snapshots_affected
      properties:
        policy_id:
          type: string
          format: uuid
        snapshots_affected:
          type: integer
          format: int64
          minimum: 0
    AuditLog:
      description: Immutable audit log entry with hash chain linkage for tamper-proof
        record keeping.
      type: object
      required:
      - id
      - action
      - resource_type
      - created_at
      properties:
        action:
          type: string
        changes:
          nullable: true
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        hash:
          type: string
          nullable: true
        id:
          type: string
          format: uuid
        ip_address:
          type: string
          nullable: true
        metadata:
          nullable: true
        previous_hash:
          type: string
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_type:
          type: string
        user_agent:
          type: string
          nullable: true
        user_id:
          type: string
          format: uuid
          nullable: true
    AuditLogResponse:
      description: API response containing audit log details including actor, action,
        old/new values, and hash chain.
      type: object
      required:
      - id
      - action
      - resource_type
      - created_at
      properties:
        action:
          type: string
        changes:
          nullable: true
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        hash:
          type: string
          nullable: true
        id:
          type: string
          format: uuid
        ip_address:
          type: string
          nullable: true
        metadata:
          nullable: true
        previous_hash:
          type: string
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_type:
          type: string
        user_agent:
          type: string
          nullable: true
        user_id:
          type: string
          format: uuid
          nullable: true
    Circuit:
      description: 'Multi-tenant data repository that serves as the primary permission
        boundary in DeFarm.

        Circuits isolate data by organization/workspace and provide RBAC access control
        for items, events, and audit logs.

        '
      type: object
      required:
      - id
      - name
      - circuit_type
      - visibility
      - owner_id
      - status
      - is_archived
      - created_at
      - updated_at
      - is_published
      - discovery_enabled
      - searchable
      - featured
      - view_count
      properties:
        archived_at:
          type: string
          format: date-time
          nullable: true
        circuit_type:
          type: string
          enum:
          - private
          - shared
          - public
          - enterprise
        created_at:
          type: string
          format: date-time
        description:
          type: string
          nullable: true
        discovery_enabled:
          type: boolean
        featured:
          type: boolean
        id:
          type: string
          format: uuid
        is_archived:
          type: boolean
        is_published:
          type: boolean
        metadata:
          nullable: true
        name:
          type: string
        organization_id:
          type: string
          format: uuid
          nullable: true
        owner_id:
          type: string
          format: uuid
        public_banner_url:
          type: string
          nullable: true
        public_contact_email:
          type: string
          nullable: true
        public_description:
          type: string
          nullable: true
        public_logo_url:
          type: string
          nullable: true
        public_website:
          type: string
          nullable: true
        published_at:
          type: string
          format: date-time
          nullable: true
        published_by:
          type: string
          format: uuid
          nullable: true
        searchable:
          type: boolean
        settings:
          nullable: true
        slug:
          type: string
          nullable: true
        status:
          type: string
          enum:
          - active
          - inactive
          - archived
        unpublished_at:
          type: string
          format: date-time
          nullable: true
        updated_at:
          type: string
          format: date-time
        view_count:
          type: integer
          format: int64
        visibility:
          type: string
          enum:
          - private
          - restricted
          - public
        workspace_id:
          type: string
          format: uuid
          nullable: true
    CircuitMember:
      description: Represents a user's membership in a circuit with role and permissions.
      type: object
      required:
      - id
      - circuit_id
      - user_id
      - role
      - status
      - joined_at
      - created_at
      - updated_at
      properties:
        circuit_id:
          type: string
          format: uuid
        created_at:
          type: string
          format: date-time
        custom_permissions:
          nullable: true
        id:
          type: string
          format: uuid
        joined_at:
          type: string
          format: date-time
        permissions:
          nullable: true
        removed_at:
          type: string
          format: date-time
          nullable: true
        role:
          type: string
        status:
          type: string
          enum:
          - pending
          - processing
          - completed
          - failed
        updated_at:
          type: string
          format: date-time
        user_id:
          type: string
          format: uuid
    CircuitMemberResponse:
      description: API response containing circuit member details including user info,
        role, and permissions.
      type: object
      required:
      - circuit_id
      - user_id
      - role
      - joined_at
      - updated_at
      properties:
        circuit_id:
          type: string
          format: uuid
        joined_at:
          type: string
          format: date-time
        permissions:
          nullable: true
        role:
          type: string
        updated_at:
          type: string
          format: date-time
        user_id:
          type: string
          format: uuid
    CircuitResponse:
      description: API response containing full circuit details with metadata, members
        count, and permissions.
      type: object
      required:
      - id
      - name
      - circuit_type
      - visibility
      - owner_id
      - status
      - is_archived
      - created_at
      - updated_at
      properties:
        circuit_type:
          type: string
          enum:
          - private
          - shared
          - public
          - enterprise
        created_at:
          type: string
          format: date-time
        description:
          type: string
          nullable: true
        id:
          type: string
          format: uuid
        is_archived:
          type: boolean
        metadata:
          nullable: true
        name:
          type: string
        organization_id:
          type: string
          format: uuid
          nullable: true
        owner_id:
          type: string
          format: uuid
        settings:
          nullable: true
        status:
          type: string
        updated_at:
          type: string
          format: date-time
        visibility:
          type: string
          enum:
          - private
          - restricted
          - public
    CircuitJoinRequest:
      description: Join request from a user wanting to join a public circuit
      type: object
      required:
      - id
      - circuit_id
      - user_id
      - status
      - created_at
      - updated_at
      properties:
        id:
          type: string
          format: uuid
        circuit_id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        status:
          type: string
          enum:
          - pending
          - approved
          - rejected
          description: Request status
        message:
          type: string
          nullable: true
          description: User's message explaining why they want to join
        user_metadata:
          type: object
          nullable: true
          description: Additional user information (company, location, etc.)
        reviewed_at:
          type: string
          format: date-time
          nullable: true
        reviewed_by:
          type: string
          format: uuid
          nullable: true
          description: Admin/owner who reviewed the request
        rejection_reason:
          type: string
          nullable: true
          description: Reason for rejection (if rejected)
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    CreateJoinRequestPayload:
      description: Payload to create a join request for a public circuit
      type: object
      properties:
        message:
          type: string
          description: Message explaining why you want to join
          example: Sou produtor de soja em Dourados/MS e gostaria de participar
        user_metadata:
          type: object
          description: Additional information about you
          example:
            company: "Fazenda S\xE3o Jo\xE3o"
            location: Dourados, MS
    ReviewJoinRequestInput:
      description: Payload to approve or reject a join request
      type: object
      required:
      - action
      properties:
        action:
          type: string
          enum:
          - approve
          - reject
          description: Action to take on the request
        role:
          type: string
          description: Role to assign if approving (e.g., "member", "viewer")
          example: member
        rejection_reason:
          type: string
          description: Reason for rejection (required if action is "reject")
          example: Circuit is currently full
    PublicCircuitInfo:
      description: Public information about a circuit for discovery
      type: object
      required:
      - id
      - name
      - circuit_type
      - visibility
      - member_count
      - item_count
      - featured
      - searchable
      - discovery_enabled
      - allow_join_requests
      - created_at
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
          nullable: true
        circuit_type:
          type: string
          enum:
          - producer
          - processor
          - distributor
          - marketplace
        visibility:
          type: string
          enum:
          - public
        public_slug:
          type: string
          nullable: true
          description: Human-readable slug for public URL
          example: produtores-soja-sp
        public_banner_url:
          type: string
          nullable: true
          description: Banner image URL
        public_logo_url:
          type: string
          nullable: true
          description: Logo URL
        member_count:
          type: integer
          format: int64
          description: Number of active members
        item_count:
          type: integer
          format: int64
          description: Number of items in circuit
        featured:
          type: boolean
          description: Whether circuit is featured in discovery
        searchable:
          type: boolean
          description: Whether circuit appears in search results
        discovery_enabled:
          type: boolean
          description: Whether circuit is discoverable publicly
        allow_join_requests:
          type: boolean
          description: Whether circuit accepts join requests
        created_at:
          type: string
          format: date-time
    CircuitStats:
      description: Statistics about a circuit's activity and items
      type: object
      required:
      - total_items
      - active_items
      - value_chains
      - countries
      - recent_activity_count
      properties:
        total_items:
          type: integer
          format: int64
        active_items:
          type: integer
          format: int64
        value_chains:
          type: array
          items:
            type: string
          description: List of value chains in this circuit
          example:
          - SOY
          - CORN
        countries:
          type: array
          items:
            type: string
          description: List of countries represented
          example:
          - BR
          - US
        recent_activity_count:
          type: integer
          format: int64
          description: Number of items added in last 7 days
    ItemSummary:
      description: Summary of an item for display in public portfolios
      type: object
      required:
      - id
      - dfid
      - value_chain
      - country
      - year
      - status
      - registered_at
      properties:
        id:
          type: string
          format: uuid
        dfid:
          type: string
          example: DFID-SOY-BR-2025-000123-a3f2c1
        value_chain:
          type: string
        country:
          type: string
        year:
          type: integer
        status:
          type: string
        registered_at:
          type: string
          format: date-time
    PublicCircuitPortfolio:
      description: Public portfolio of a circuit including stats and recent items
      type: object
      required:
      - circuit
      - stats
      - recent_items
      properties:
        circuit:
          $ref: '#/components/schemas/PublicCircuitInfo'
        stats:
          $ref: '#/components/schemas/CircuitStats'
        recent_items:
          type: array
          items:
            $ref: '#/components/schemas/ItemSummary'
          description: Most recent items (up to 10)
    PublicCircuitsResponse:
      description: Response containing list of public circuits with pagination
      type: object
      required:
      - circuits
      - total
      - limit
      - offset
      properties:
        circuits:
          type: array
          items:
            $ref: '#/components/schemas/PublicCircuitInfo'
        total:
          type: integer
          format: int64
          description: Total number of public circuits matching filters
        limit:
          type: integer
          format: int64
          description: Results limit used
        offset:
          type: integer
          format: int64
          description: Results offset used
    ComparisonResponse:
      description: Result of comparing two resources (snapshots, items, etc.).
      type: object
      required:
      - id
      - snapshot_a_id
      - snapshot_b_id
      - comparison_type
      - diff_data
      - created_at
      properties:
        comparison_type:
          type: string
          enum:
          - forward
          - backward
          - merge_conflict
          - validation
        created_at:
          type: string
          format: date-time
        diff_data: {}
        id:
          type: string
          format: uuid
        snapshot_a_id:
          type: string
          format: uuid
        snapshot_b_id:
          type: string
          format: uuid
        summary:
          nullable: true
    CreateActivityInput:
      description: Request payload to create a new activity entry.
      type: object
      required:
      - actor_id
      - action
      - resource_type
      - description
      - is_public
      properties:
        action:
          type: string
        actor_id:
          type: string
          format: uuid
        actor_name:
          type: string
          nullable: true
        circuit_id:
          type: string
          format: uuid
          nullable: true
        description:
          type: string
        is_public:
          type: boolean
        metadata:
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_name:
          type: string
          nullable: true
        resource_type:
          type: string
    CreateApiKeyRequest:
      description: Request payload to create API key for programmatic access.
      type: object
      required:
      - key_name
      - circuit_id
      properties:
        circuit_id:
          type: string
          format: uuid
          description: Circuit ID this key grants access to
        description:
          type: string
          description: Optional description of key purpose
          nullable: true
        expires_in_days:
          type: integer
          format: int64
          description: 'Number of days until expiration (default: never expires)'
          nullable: true
        key_name:
          type: string
          description: Human-readable name for the API key
    CreateApiKeyResponse:
      description: API response containing new API key (only shown once for security).
      type: object
      required:
      - id
      - key_name
      - circuit_id
      - api_key
      - created_at
      - message
      properties:
        api_key:
          type: string
          description: The actual API key (ONLY shown once!)
        circuit_id:
          type: string
          format: uuid
          description: Circuit this key grants access to
        created_at:
          type: string
          description: Creation timestamp (RFC3339)
        expires_at:
          type: string
          description: Expiration timestamp (RFC3339)
          nullable: true
        id:
          type: string
          format: uuid
          description: Unique identifier for this API key record
        key_name:
          type: string
          description: Name of the API key
        message:
          type: string
          description: Important message about saving the key
    CreatePartnerApiKeyRequest:
      description: Request payload to create a partner API key.
      type: object
      required:
      - key_name
      - circuit_id
      properties:
        key_name:
          type: string
          description: Human-readable name for the API key
        circuit_id:
          type: string
          format: uuid
          description: Circuit ID this key grants access to
        description:
          type: string
          description: Optional description of key purpose
          nullable: true
        expires_in_days:
          type: integer
          format: int64
          description: Number of days until expiration (default 365, max 730)
          nullable: true
    PartnerApiKeyResponse:
      description: Partner API key metadata (key value shown only on creation).
      type: object
      required:
      - id
      - key_name
      - circuit_id
      - is_active
      - created_at
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for this API key record
        key_name:
          type: string
          description: Name of the API key
        circuit_id:
          type: string
          format: uuid
          description: Circuit this key grants access to
        api_key:
          type: string
          description: The actual API key (only shown once at creation)
          nullable: true
        description:
          type: string
          description: Description of the key's purpose
          nullable: true
        is_active:
          type: boolean
          description: Whether the key is currently active
        rate_limit_per_minute:
          type: integer
          format: int32
          nullable: true
        rate_limit_per_day:
          type: integer
          format: int32
          nullable: true
        created_at:
          type: string
          description: Creation timestamp (RFC3339)
        last_used_at:
          type: string
          description: Last time this key was used (RFC3339)
          nullable: true
        expires_at:
          type: string
          description: Expiration timestamp (RFC3339)
          nullable: true
    CreatePartnerApiKeyResponse:
      description: API response containing new partner API key.
      type: object
      required:
      - key
      - message
      properties:
        key:
          $ref: '#/components/schemas/PartnerApiKeyResponse'
        message:
          type: string
          description: Important security message
    ApiKeyMetricsResponse:
      description: Usage metrics for an API key.
      type: object
      required:
      - api_key_id
      - requests_total
      - requests_last_24h
      - errors_last_24h
      properties:
        api_key_id:
          type: string
          format: uuid
        requests_total:
          type: integer
          format: int64
        requests_last_24h:
          type: integer
          format: int64
        errors_last_24h:
          type: integer
          format: int64
        last_used_at:
          type: string
          description: Last time this key was used (RFC3339)
          nullable: true
        rate_limit_per_minute:
          type: integer
          format: int32
          nullable: true
        rate_limit_per_day:
          type: integer
          format: int32
          nullable: true
    AdapterStatsResponse:
      description: Adapter service statistics for admin dashboard
      type: object
      required:
      - jobs
      - queue
      - adapters
      - costs
      - rate_limits
      properties:
        jobs:
          type: object
          description: Job processing statistics
          required:
          - completed
          - failed
          - total
          - success_rate
          properties:
            completed:
              type: integer
              format: int64
              description: Total jobs completed successfully
              example: 1234
            failed:
              type: integer
              format: int64
              description: Total jobs that failed
              example: 5
            total:
              type: integer
              format: int64
              description: Total jobs processed
              example: 1239
            success_rate:
              type: number
              format: double
              description: Success rate (0.0 - 1.0)
              example: 0.996
        queue:
          type: object
          description: Queue statistics
          required:
          - depth
          - active_workers
          properties:
            depth:
              type: integer
              format: int64
              description: Current number of jobs in queue
              example: 10
            active_workers:
              type: integer
              format: int64
              description: Number of workers processing jobs
              example: 2
        adapters:
          type: object
          description: Adapter operation statistics
          required:
          - stellar
          - ipfs
          properties:
            stellar:
              type: object
              description: Stellar blockchain adapter stats
              required:
              - success
              - failed
              - total
              - success_rate
              properties:
                success:
                  type: integer
                  format: int64
                  example: 500
                failed:
                  type: integer
                  format: int64
                  example: 3
                total:
                  type: integer
                  format: int64
                  example: 503
                success_rate:
                  type: number
                  format: double
                  example: 0.994
            ipfs:
              type: object
              description: IPFS storage adapter stats
              required:
              - success
              - failed
              - total
              - success_rate
              properties:
                success:
                  type: integer
                  format: int64
                  example: 450
                failed:
                  type: integer
                  format: int64
                  example: 1
                total:
                  type: integer
                  format: int64
                  example: 451
                success_rate:
                  type: number
                  format: double
                  example: 0.998
        costs:
          type: object
          description: Cost tracking
          required:
          - stellar_xlm
          - stellar_usd
          - ipfs_storage_bytes
          - ipfs_storage_gb
          properties:
            stellar_xlm:
              type: number
              format: double
              description: Total Stellar costs in XLM
              example: 0.05
            stellar_usd:
              type: number
              format: double
              description: Total Stellar costs in USD (approximate)
              example: 0.005
            ipfs_storage_bytes:
              type: integer
              format: int64
              description: Total IPFS storage in bytes
              example: 10485760
            ipfs_storage_gb:
              type: number
              format: double
              description: Total IPFS storage in GB
              example: 0.01
        rate_limits:
          type: object
          description: Rate limiting statistics
          required:
          - rejections
          properties:
            rejections:
              type: integer
              format: int64
              description: Total requests rejected due to rate limits
              example: 15
    CreateCanonicalIdentifierRequest:
      description: Request payload to create a canonical identifier type.
      type: object
      required:
      - value_chain
      - identifier_type
      properties:
        value_chain:
          type: string
        identifier_type:
          type: string
    UpdateCanonicalIdentifierRequest:
      description: Request payload to enable or disable a canonical identifier type.
      type: object
      required:
      - is_active
      properties:
        is_active:
          type: boolean
    CanonicalIdentifierResponse:
      description: Canonical identifier type configuration.
      type: object
      required:
      - id
      - value_chain
      - identifier_type
      - is_active
      - created_at
      properties:
        id:
          type: string
          format: uuid
        value_chain:
          type: string
        identifier_type:
          type: string
        is_active:
          type: boolean
        created_at:
          type: string
          format: date-time
    CreateCircuitRequest:
      description: Request payload to create a new circuit. Requires name, circuit_type,
        and workspace_id.
      type: object
      required:
      - name
      - circuit_type
      - visibility
      - owner_id
      properties:
        circuit_type:
          type: string
          enum:
          - private
          - shared
          - public
          - enterprise
        description:
          type: string
          nullable: true
        ip_address:
          type: string
          nullable: true
        metadata:
          nullable: true
        name:
          type: string
        organization_id:
          type: string
          format: uuid
          nullable: true
        owner_id:
          type: string
          format: uuid
        settings:
          nullable: true
        user_id:
          type: string
          format: uuid
          nullable: true
        visibility:
          type: string
          enum:
          - private
          - restricted
          - public
    CreateComparisonRequest:
      description: Request payload to create a comparison between two resources.
      type: object
      required:
      - snapshot_b_id
      - comparison_type
      properties:
        comparison_type:
          type: string
          enum:
          - forward
          - backward
          - merge_conflict
          - validation
        snapshot_b_id:
          type: string
          format: uuid
    CreateItemRequest:
      description: 'Request payload to create a new item with automatic DFID generation.


        **Many-to-Many Architecture**: `circuit_id` represents the first circuit to
        add this item (becomes ''owner'').

        Items are global entities identified by DFID and can exist in multiple circuits
        simultaneously.'
      type: object
      required:
      - value_chain
      - country
      - year
      - circuit_id
      properties:
        circuit_id:
          type: string
          format: uuid
          description: First circuit to add this item (will have role='owner')
        country:
          type: string
        ip_address:
          type: string
          nullable: true
        identifiers:
          type: array
          items:
            $ref: '#/components/schemas/IdentifierInput'
          nullable: true
        metadata:
          nullable: true
        user_id:
          type: string
          format: uuid
          nullable: true
        value_chain:
          type: string
        year:
          type: integer
          format: int32
    IdentifierInput:
      description: Identifier provided by client (canonical or contextual).
      type: object
      required:
      - identifier_type
      - value
      properties:
        identifier_type:
          type: string
        value:
          type: string
        is_canonical:
          type: boolean
          nullable: true
    IdentifierResponse:
      description: Identifier metadata stored for an item.
      type: object
      required:
      - identifier_type
      - value
      - is_canonical
      properties:
        identifier_type:
          type: string
        value:
          type: string
        is_canonical:
          type: boolean
    CreateMerkleTreeRequest:
      description: Request payload to create merkle tree for snapshot verification.
      type: object
      required:
      - tree_type
      - resource_type
      - leaf_data
      properties:
        circuit_id:
          type: string
          format: uuid
          nullable: true
        leaf_data:
          type: array
          items: {}
        metadata:
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_type:
          type: string
        snapshot_id:
          type: string
          format: uuid
          nullable: true
        tree_type:
          type: string
          enum:
          - snapshot
          - circuit
          - audit_batch
          - event_batch
          - item_batch
    CreateRestorationRequest:
      description: Request payload to restore data from snapshot.
      type: object
      required:
      - restored_by
      - restoration_type
      properties:
        pre_restore_snapshot_id:
          type: string
          format: uuid
          nullable: true
        restoration_type:
          type: string
          enum:
          - full
          - partial
          - merge
          - rollback
        restore_metadata:
          nullable: true
        restored_by:
          type: string
          format: uuid
        target_resource_id:
          type: string
          format: uuid
          nullable: true
    CreateSnapshotRequest:
      description: Request payload to create a new snapshot. Requires resource_type
        and resource_id.
      type: object
      required:
      - snapshot_type
      - resource_type
      - snapshot_name
      - snapshot_data
      - created_by
      properties:
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_by:
          type: string
          format: uuid
        description:
          type: string
          nullable: true
        expires_at:
          type: string
          format: date-time
          nullable: true
        metadata:
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_type:
          type: string
        snapshot_data: {}
        snapshot_name:
          type: string
        snapshot_type:
          type: string
    CreateWebhookInput:
      description: Request payload to create a new webhook. Requires URL and event
        types.
      type: object
      required:
      - circuit_id
      - name
      - url
      - events
      - created_by
      properties:
        circuit_id:
          type: string
          format: uuid
        created_by:
          type: string
          format: uuid
        events:
          type: array
          items:
            type: string
        headers:
          nullable: true
        name:
          type: string
        retry_config:
          allOf:
          - $ref: '#/components/schemas/WebhookRetryConfig'
          nullable: true
        secret:
          type: string
          nullable: true
        url:
          type: string
    ErrorResponse:
      description: API error response with detailed error information.
      type: object
      required:
      - error
      - message
      properties:
        details:
          type: string
          nullable: true
        error:
          type: string
        message:
          type: string
    Event:
      description: Represents a lifecycle event for an item (created, updated, transferred,
        certified, etc.).
      type: object
      required:
      - id
      - event_type
      - source_type
      - source_id
      - payload
      - status
      - created_at
      - visibility
      - is_duplicate
      properties:
        circuit_id:
          type: string
          format: uuid
          nullable: true
        content_hash:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        encrypted_payload:
          type: string
          format: binary
          nullable: true
        encryption_key_id:
          type: string
          nullable: true
        error_message:
          type: string
          nullable: true
        event_type:
          type: string
        id:
          type: string
          format: uuid
        is_duplicate:
          type: boolean
        item_id:
          type: string
          format: uuid
          nullable: true
        metadata:
          nullable: true
        original_event_id:
          type: string
          format: uuid
          nullable: true
        payload: {}
        processed_at:
          type: string
          format: date-time
          nullable: true
        source_id:
          type: string
          format: uuid
        source_type:
          type: string
        status:
          type: string
          enum:
          - pending
          - processing
          - completed
          - failed
        user_id:
          type: string
          format: uuid
          nullable: true
        visibility:
          type: string
        visible_to_roles:
          nullable: true
    EventResponse:
      description: API response containing full event details including type, timestamp,
        actor, and metadata.
      type: object
      required:
      - id
      - event_type
      - source_type
      - source_id
      - payload
      - status
      - created_at
      properties:
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        error_message:
          type: string
          nullable: true
        event_type:
          type: string
        id:
          type: string
          format: uuid
        item_id:
          type: string
          format: uuid
          nullable: true
        metadata:
          nullable: true
        payload: {}
        processed_at:
          type: string
          format: date-time
          nullable: true
        source_id:
          type: string
          format: uuid
        source_type:
          type: string
        status:
          type: string
          enum:
          - pending
          - processing
          - completed
          - failed
        user_id:
          type: string
          format: uuid
          nullable: true
    GenerateProofRequest:
      description: Request payload to generate cryptographic proof for data.
      type: object
      required:
      - leaf_data
      properties:
        leaf_data: {}
    HashChainVerificationResponse:
      description: Result of audit log hash chain integrity verification.
      type: object
      required:
      - valid
      - logs_checked
      - message
      properties:
        logs_checked:
          type: integer
          minimum: 0
        message:
          type: string
        valid:
          type: boolean
    HealthResponse:
      description: System health status response including component statuses.
      type: object
      required:
      - status
      - database
      - redis
      - timestamp
      properties:
        database:
          $ref: '#/components/schemas/HealthStatus'
        redis:
          $ref: '#/components/schemas/HealthStatus'
        status:
          type: string
        timestamp:
          type: string
    HealthStatus:
      description: Individual component health status (database, redis, etc.).
      type: object
      required:
      - connected
      - latency_ms
      properties:
        connected:
          type: boolean
        latency_ms:
          type: integer
          format: int64
          minimum: 0
    IngestionReceipt:
      description: Receipt returned after ingestion completes
      type: object
      required:
      - receipt_id
      - status
      - processing_time_ms
      - summary
      properties:
        error_message:
          type: string
          description: Error message if status is "failed" or "partial"
          nullable: true
        processing_time_ms:
          type: integer
          format: int64
          description: Processing time in milliseconds
          minimum: 0
        receipt_id:
          type: string
          format: uuid
          description: Unique receipt ID
        status:
          type: string
          description: 'Status: "processing", "completed", "failed", "partial"'
        summary:
          $ref: '#/components/schemas/IngestionSummary'
    IngestionSummary:
      type: object
      description: Statistics for a completed ingestion
      required:
      - rows_total
      - rows_processed
      - rows_failed
      - items_created
      - items_updated
      - events_created
      - identifiers_resolved
      - unclassified_fields
      properties:
        events_created:
          type: integer
          description: Events created
          minimum: 0
        identifiers_resolved:
          type: object
          description: Count of each identifier type resolved
          additionalProperties:
            type: integer
            minimum: 0
        items_created:
          type: integer
          description: New items created
          minimum: 0
        items_updated:
          type: integer
          description: Existing items updated
          minimum: 0
        rows_failed:
          type: integer
          description: Rows that failed
          minimum: 0
        rows_processed:
          type: integer
          description: Rows successfully processed
          minimum: 0
        rows_total:
          type: integer
          description: Total rows in CSV
          minimum: 0
        unclassified_fields:
          type: array
          items:
            type: string
          description: CSV fields that were not recognized
    Item:
      description: 'Represents a physical or digital asset in the supply chain, uniquely
        identified by a DFID.


        **Many-to-Many Architecture**: Items are global entities that can exist in
        multiple circuits.

        Circuit associations are managed via the circuit_items junction table, not
        as properties on the item.'
      type: object
      required:
      - id
      - dfid
      - value_chain
      - country
      - year
      - status
      - registered_at
      - last_updated_at
      - created_at
      - updated_at
      properties:
        archived_at:
          type: string
          format: date-time
          nullable: true
        country:
          type: string
        created_at:
          type: string
          format: date-time
        dfid:
          type: string
        id:
          type: string
          format: uuid
        last_updated_at:
          type: string
          format: date-time
        local_id:
          type: string
          format: uuid
          nullable: true
        merged_into:
          type: string
          nullable: true
        metadata:
          nullable: true
        registered_at:
          type: string
          format: date-time
        split_from:
          type: string
          nullable: true
        status:
          type: string
        updated_at:
          type: string
          format: date-time
        value_chain:
          type: string
        year:
          type: integer
          format: int32
    ItemResponse:
      description: 'API response containing full item details including DFID, status,
        metadata, and relationships.


        **Many-to-Many Architecture**: Items are global entities identified by DFID.

        To see which circuits an item belongs to, use the circuits relationship endpoint.'
      type: object
      required:
      - id
      - dfid
      - value_chain
      - country
      - year
      - status
      - registered_at
      - updated_at
      properties:
        country:
          type: string
        dfid:
          type: string
          example: DFID-BEEF-BR-2025-000123-a3f2c1
        id:
          type: string
          format: uuid
        metadata:
          nullable: true
        registered_at:
          type: string
          format: date-time
        status:
          type: string
          enum:
          - pending
          - active
          - inactive
          - archived
        updated_at:
          type: string
          format: date-time
        value_chain:
          type: string
        year:
          type: integer
          format: int32
    ItemDetailsResponse:
      description: Item details with identifiers and events.
      type: object
      required:
      - item
      - identifiers
      - events
      properties:
        item:
          $ref: '#/components/schemas/ItemResponse'
        identifiers:
          type: array
          items:
            $ref: '#/components/schemas/IdentifierResponse'
        canonical_identifier:
          $ref: '#/components/schemas/IdentifierResponse'
          nullable: true
        events:
          type: array
          items:
            $ref: '#/components/schemas/Event'
    CreateItemResponse:
      description: Item creation response with identifiers, events, and deduplication
        status.
      type: object
      required:
      - item
      - identifiers
      - events
      - was_deduplicated
      properties:
        item:
          $ref: '#/components/schemas/ItemResponse'
        identifiers:
          type: array
          items:
            $ref: '#/components/schemas/IdentifierResponse'
        canonical_identifier:
          $ref: '#/components/schemas/IdentifierResponse'
          nullable: true
        events:
          type: array
          items:
            $ref: '#/components/schemas/Event'
        was_deduplicated:
          type: boolean
    ListAuditLogsResponse:
      description: Paginated API response containing list of audit logs with hash
        chain integrity.
      type: object
      required:
      - logs
      - count
      properties:
        count:
          type: integer
          minimum: 0
        logs:
          type: array
          items:
            $ref: '#/components/schemas/AuditLogResponse'
    ListCircuitsResponse:
      description: Paginated API response containing list of circuits with metadata.
      type: object
      required:
      - circuits
      - count
      properties:
        circuits:
          type: array
          items:
            $ref: '#/components/schemas/CircuitResponse'
        count:
          type: integer
          minimum: 0
    ListEventsResponse:
      description: Paginated API response containing list of lifecycle events with
        filters.
      type: object
      required:
      - events
      - count
      properties:
        count:
          type: integer
          minimum: 0
        events:
          type: array
          items:
            $ref: '#/components/schemas/EventResponse'
    ListItemsResponse:
      description: Paginated API response containing list of items with DFIDs and
        metadata.
      type: object
      required:
      - items
      - count
      properties:
        count:
          type: integer
          minimum: 0
        items:
          type: array
          items:
            $ref: '#/components/schemas/ItemResponse'
    ListMembersResponse:
      description: API response containing list of circuit members with roles and
        permissions.
      type: object
      required:
      - members
      - count
      properties:
        count:
          type: integer
          minimum: 0
        members:
          type: array
          items:
            $ref: '#/components/schemas/CircuitMemberResponse'
    ListMerkleTreesResponse:
      description: Paginated API response containing list of merkle trees with root
        hashes.
      type: object
      required:
      - trees
      - count
      properties:
        count:
          type: integer
          minimum: 0
        trees:
          type: array
          items:
            $ref: '#/components/schemas/MerkleTreeResponse'
    ListSnapshotsResponse:
      description: Paginated API response containing list of snapshots with metadata.
      type: object
      required:
      - snapshots
      - count
      properties:
        count:
          type: integer
          minimum: 0
        snapshots:
          type: array
          items:
            $ref: '#/components/schemas/SnapshotResponse'
    MergeItemsRequest:
      description: Request payload to merge two items. Requires secondary_dfid and
        merge strategy.
      type: object
      required:
      - secondary_dfid
      - strategy
      properties:
        secondary_dfid:
          type: string
          description: DFID of the secondary item to merge into the primary
        strategy:
          type: string
          description: 'Merge strategy: "append", "keep_first", or "overwrite"'
        user_id:
          type: string
          format: uuid
          description: User performing the merge operation
          nullable: true
    MergeItemsResponse:
      description: API response confirming item merge with primary and secondary DFIDs.
      type: object
      required:
      - merged_item
      - message
      properties:
        merged_item:
          $ref: '#/components/schemas/Item'
        message:
          type: string
          description: Success message
    ItemRelationshipRecord:
      description: Relationship record between two items (merge/split/related).
      type: object
      required:
      - id
      - primary_item_id
      - related_item_id
      - relationship_type
      - created_at
      properties:
        id:
          type: string
          format: uuid
        primary_item_id:
          type: string
          format: uuid
        related_item_id:
          type: string
          format: uuid
        relationship_type:
          type: string
          enum:
          - duplicate
          - derived
          - related
        confidence_score:
          type: number
          format: double
          nullable: true
        created_at:
          type: string
          format: date-time
    MerkleNode:
      description: Node in the merkle tree representing hashed data with left/right
        children.
      type: object
      required:
      - id
      - tree_id
      - node_hash
      - node_type
      - level
      - position
      - created_at
      properties:
        created_at:
          type: string
          format: date-time
        data_hash:
          type: string
          nullable: true
        data_reference:
          nullable: true
        id:
          type: string
          format: uuid
        left_child_id:
          type: string
          format: uuid
          nullable: true
        level:
          type: integer
          format: int32
        node_hash:
          type: string
        node_type:
          type: string
        parent_id:
          type: string
          format: uuid
          nullable: true
        position:
          type: integer
          format: int32
        right_child_id:
          type: string
          format: uuid
          nullable: true
        tree_id:
          type: string
          format: uuid
    MerkleProof:
      description: Cryptographic proof path from leaf to root for data verification.
      type: object
      required:
      - id
      - tree_id
      - leaf_hash
      - leaf_data
      - proof_path
      - proof_positions
      - root_hash
      - is_valid
      - created_at
      properties:
        created_at:
          type: string
          format: date-time
        id:
          type: string
          format: uuid
        is_valid:
          type: boolean
        leaf_data: {}
        leaf_hash:
          type: string
        proof_path: {}
        proof_positions: {}
        root_hash:
          type: string
        tree_id:
          type: string
          format: uuid
        verified_at:
          type: string
          format: date-time
          nullable: true
    MerkleTree:
      description: Cryptographic data structure using BLAKE3 hashing for snapshot
        integrity verification.
      type: object
      required:
      - id
      - tree_type
      - resource_type
      - root_hash
      - height
      - leaf_count
      - hash_algorithm
      - created_at
      - updated_at
      properties:
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        hash_algorithm:
          type: string
        height:
          type: integer
          format: int32
        id:
          type: string
          format: uuid
        leaf_count:
          type: integer
          format: int32
        metadata:
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_type:
          type: string
          enum:
          - snapshot
          - circuit
          - audit
          - event
          - item
          - mixed
        root_hash:
          type: string
        snapshot_id:
          type: string
          format: uuid
          nullable: true
        tree_type:
          type: string
          enum:
          - snapshot
          - circuit
          - audit_batch
          - event_batch
          - item_batch
        updated_at:
          type: string
          format: date-time
    MerkleTreeResponse:
      description: API response containing merkle tree details including root hash
        and leaf count.
      type: object
      required:
      - id
      - tree_type
      - resource_type
      - root_hash
      - height
      - leaf_count
      - hash_algorithm
      - created_at
      - updated_at
      properties:
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        hash_algorithm:
          type: string
        height:
          type: integer
          format: int32
        id:
          type: string
          format: uuid
        leaf_count:
          type: integer
          format: int32
        metadata:
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_type:
          type: string
          enum:
          - snapshot
          - circuit
          - audit
          - event
          - item
          - mixed
        root_hash:
          type: string
        snapshot_id:
          type: string
          format: uuid
          nullable: true
        tree_type:
          type: string
          enum:
          - snapshot
          - circuit
          - audit_batch
          - event_batch
          - item_batch
        updated_at:
          type: string
          format: date-time
    MerkleVerification:
      description: Result of verifying data against merkle tree root hash.
      type: object
      required:
      - id
      - tree_id
      - verification_type
      - leaf_hash
      - expected_root
      - actual_root
      - is_valid
      - created_at
      properties:
        actual_root:
          type: string
        created_at:
          type: string
          format: date-time
        error_message:
          type: string
          nullable: true
        expected_root:
          type: string
        id:
          type: string
          format: uuid
        is_valid:
          type: boolean
        leaf_hash:
          type: string
        proof_id:
          type: string
          format: uuid
          nullable: true
        tree_id:
          type: string
          format: uuid
        verification_time_ms:
          type: integer
          format: int32
          nullable: true
        verification_type:
          type: string
        verified_by:
          type: string
          format: uuid
          nullable: true
    ProofResponse:
      description: Cryptographic proof response for data verification.
      type: object
      required:
      - id
      - tree_id
      - leaf_hash
      - leaf_data
      - proof_path
      - proof_positions
      - root_hash
      - is_valid
      - created_at
      properties:
        created_at:
          type: string
          format: date-time
        id:
          type: string
          format: uuid
        is_valid:
          type: boolean
        leaf_data: {}
        leaf_hash:
          type: string
        proof_path: {}
        proof_positions: {}
        root_hash:
          type: string
        tree_id:
          type: string
          format: uuid
        verified_at:
          type: string
          format: date-time
          nullable: true
    RecentActivity:
      description: Recent activity entries for dashboard display.
      type: object
      required:
      - id
      - user_id
      - activity_type
      - activity_count
      - last_activity_at
      - created_at
      properties:
        activity_count:
          type: integer
          format: int32
        activity_type:
          type: string
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        id:
          type: string
          format: uuid
        last_activity_at:
          type: string
          format: date-time
        user_id:
          type: string
          format: uuid
    RestorationResponse:
      description: Result of data restoration from snapshot or backup.
      type: object
      required:
      - id
      - snapshot_id
      - restored_by
      - restoration_type
      - status
      - created_at
      properties:
        completed_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        error_message:
          type: string
          nullable: true
        id:
          type: string
          format: uuid
        pre_restore_snapshot_id:
          type: string
          format: uuid
          nullable: true
        restoration_type:
          type: string
        restore_metadata:
          nullable: true
        restored_by:
          type: string
          format: uuid
        snapshot_id:
          type: string
          format: uuid
        status:
          type: string
        target_resource_id:
          type: string
          format: uuid
          nullable: true
    CreateRetentionPolicyRequest:
  type: object
  required:
    - circuit_id
    - snapshot_type
    - retention_days
    - auto_archive
  properties:
    circuit_id:
      type: string
      format: uuid
    snapshot_type:
      type: string
    resource_type:
      type: string
      nullable: true
    retention_days:
      type: integer
    max_snapshots:
      type: integer
      nullable: true
    auto_archive:
      type: boolean
    is_active:
      type: boolean
      nullable: true

RetentionPolicyResponse:
      description: API response containing retention policy details and affected snapshots
        count.
      type: object
      required:
      - id
      - snapshot_type
      - retention_days
      - auto_archive
      - is_active
      - created_at
      - updated_at
      properties:
        auto_archive:
          type: boolean
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        id:
          type: string
          format: uuid
        is_active:
          type: boolean
        max_snapshots:
          type: integer
          format: int32
          nullable: true
        resource_type:
          type: string
          nullable: true
        retention_days:
          type: integer
          format: int32
        snapshot_type:
          type: string
        updated_at:
          type: string
          format: date-time
    Snapshot:
      description: Point-in-time capture of item or circuit state for versioning and
        rollback.
      type: object
      required:
      - id
      - snapshot_type
      - resource_type
      - snapshot_name
      - snapshot_data
      - created_by
      - created_at
      - is_archived
      - checksum
      properties:
        archived_at:
          type: string
          format: date-time
          nullable: true
        checksum:
          type: string
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        created_by:
          type: string
          format: uuid
        description:
          type: string
          nullable: true
        expires_at:
          type: string
          format: date-time
          nullable: true
        id:
          type: string
          format: uuid
        is_archived:
          type: boolean
        metadata:
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_type:
          type: string
        snapshot_data: {}
        snapshot_name:
          type: string
        snapshot_type:
          type: string
    SnapshotComparison:
      description: Comparison result between two snapshots showing differences and
        changes.
      type: object
      required:
      - id
      - snapshot_a_id
      - snapshot_b_id
      - comparison_type
      - diff_data
      - created_at
      properties:
        comparison_type:
          type: string
        created_at:
          type: string
          format: date-time
        diff_data: {}
        id:
          type: string
          format: uuid
        snapshot_a_id:
          type: string
          format: uuid
        snapshot_b_id:
          type: string
          format: uuid
        summary:
          nullable: true
    SnapshotResponse:
      description: API response containing snapshot details including data, merkle
        root, and retention policy.
      type: object
      required:
      - id
      - snapshot_type
      - resource_type
      - snapshot_name
      - snapshot_data
      - created_by
      - created_at
      - is_archived
      - checksum
      properties:
        archived_at:
          type: string
          format: date-time
          nullable: true
        checksum:
          type: string
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        created_by:
          type: string
          format: uuid
        description:
          type: string
          nullable: true
        expires_at:
          type: string
          format: date-time
          nullable: true
        id:
          type: string
          format: uuid
        is_archived:
          type: boolean
        metadata:
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_type:
          type: string
        snapshot_data: {}
        snapshot_name:
          type: string
        snapshot_type:
          type: string
    SnapshotRestoration:
      description: Result of restoring data from a snapshot including affected resources.
      type: object
      required:
      - id
      - snapshot_id
      - restored_by
      - restoration_type
      - status
      - created_at
      properties:
        completed_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        error_message:
          type: string
          nullable: true
        id:
          type: string
          format: uuid
        pre_restore_snapshot_id:
          type: string
          format: uuid
          nullable: true
        restoration_type:
          type: string
        restore_metadata:
          nullable: true
        restored_by:
          type: string
          format: uuid
        snapshot_id:
          type: string
          format: uuid
        status:
          type: string
        target_resource_id:
          type: string
          format: uuid
          nullable: true
    SnapshotRetentionPolicy:
      description: Policy defining how long snapshots are retained before automatic
        deletion.
      type: object
      required:
      - id
      - snapshot_type
      - retention_days
      - auto_archive
      - is_active
      - created_at
      - updated_at
      properties:
        auto_archive:
          type: boolean
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        id:
          type: string
          format: uuid
        is_active:
          type: boolean
        max_snapshots:
          type: integer
          format: int32
          nullable: true
        resource_type:
          type: string
          nullable: true
        retention_days:
          type: integer
          format: int32
        snapshot_type:
          type: string
        updated_at:
          type: string
          format: date-time
    SplitItemRequest:
      description: Request payload to split an item into two. Creates new item with
        new DFID.
      type: object
      required:
      - value_chain
      - country
      - year
      - metadata
      properties:
        country:
          type: string
          description: Country code for the new item
        metadata:
          description: Metadata for the new item
        user_id:
          type: string
          format: uuid
          description: User performing the split operation
          nullable: true
        value_chain:
          type: string
          description: Value chain for the new item
        year:
          type: integer
          format: int32
          description: Year for the new item
    SplitItemResponse:
      description: API response containing original DFID and new DFID after split
        operation.
      type: object
      required:
      - source_item
      - new_item
      - message
      properties:
        message:
          type: string
          description: Success message
        new_item:
          $ref: '#/components/schemas/Item'
        source_item:
          $ref: '#/components/schemas/Item'
    TrustLevel:
      type: string
      description: Trust level of the data source for conflict resolution
      enum:
      - SanitaryAgency
      - Certifier
      - Processor
      - Producer
      - Unknown
    UnmergeItemRequest:
      description: Request payload to restore a previously merged item. Reverses merge
        operation.
      type: object
      properties:
        user_id:
          type: string
          format: uuid
          description: User performing the unmerge operation
          nullable: true
    UnmergeItemResponse:
      description: API response confirming unmerge with restored item DFID and status.
      type: object
      required:
      - restored_item
      - message
      properties:
        message:
          type: string
          description: Success message
        restored_item:
          $ref: '#/components/schemas/Item'
    UpdateCircuitRequest:
      description: Request payload to update circuit details. Allows changing name,
        description, metadata, and status.
      type: object
      properties:
        description:
          type: string
          nullable: true
        ip_address:
          type: string
          nullable: true
        metadata:
          nullable: true
        name:
          type: string
          nullable: true
        settings:
          nullable: true
        status:
          type: string
          nullable: true
        user_id:
          type: string
          format: uuid
          nullable: true
        visibility:
          type: string
          nullable: true
    UpdateEventStatusRequest:
      description: Request payload to update event processing status (pending, processing,
        completed, failed).
      type: object
      required:
      - status
      properties:
        error_message:
          type: string
          nullable: true
        status:
          type: string
          enum:
          - processing
          - completed
          - failed
    UpdateItemRequest:
      description: Request payload to update item metadata, tags, and status. DFID
        and circuit_id are immutable.
      type: object
      required:
      - metadata
      properties:
        ip_address:
          type: string
          nullable: true
        metadata: {}
        user_id:
          type: string
          format: uuid
          nullable: true
    UpdateItemStatusRequest:
      description: Request payload to update item lifecycle status (pending, active,
        inactive, archived).
      type: object
      required:
      - status
      properties:
        ip_address:
          type: string
          nullable: true
        status:
          type: string
          enum:
          - pending
          - active
          - inactive
          - archived
        user_id:
          type: string
          format: uuid
          nullable: true
    UpdateMemberRequest:
      description: Request payload to update a member's role or custom permissions
        in a circuit.
      type: object
      properties:
        permissions:
          nullable: true
        role:
          type: string
          nullable: true
        updated_by:
          type: string
          format: uuid
          nullable: true
    UpdateRestorationStatusRequest:
      description: Request payload to update restoration operation status.
      type: object
      required:
      - status
      properties:
        error_message:
          type: string
          nullable: true
        status:
          type: string
    UpdateWebhookInput:
      description: Request payload to update webhook configuration including URL,
        events, and retry settings.
      type: object
      properties:
        events:
          type: array
          items:
            type: string
          nullable: true
        headers:
          nullable: true
        is_active:
          type: boolean
          nullable: true
        name:
          type: string
          nullable: true
        retry_config:
          allOf:
          - $ref: '#/components/schemas/WebhookRetryConfig'
          nullable: true
        secret:
          type: string
          nullable: true
        url:
          type: string
          nullable: true
    UserSession:
      description: User session information including login time and activity.
      type: object
      required:
      - id
      - user_id
      - started_at
      - last_activity_at
      - is_active
      properties:
        ended_at:
          type: string
          format: date-time
          nullable: true
        id:
          type: string
          format: uuid
        ip_address:
          type: string
          nullable: true
        is_active:
          type: boolean
        last_activity_at:
          type: string
          format: date-time
        session_token:
          type: string
          nullable: true
        started_at:
          type: string
          format: date-time
        user_agent:
          type: string
          nullable: true
        user_id:
          type: string
          format: uuid
    VerificationHistoryResponse:
      description: History of verification attempts with timestamps and results.
      type: object
      required:
      - verifications
      - count
      properties:
        count:
          type: integer
          minimum: 0
        verifications:
          type: array
          items:
            $ref: '#/components/schemas/MerkleVerification'
    VerificationResponse:
      description: Result of cryptographic verification with validity status.
      type: object
      required:
      - is_valid
      - computed_root
      - expected_root
      properties:
        computed_root:
          type: string
        expected_root:
          type: string
        is_valid:
          type: boolean
    VerifyProofRequest:
      description: Request payload to verify cryptographic proof against data.
      type: object
      required:
      - leaf_hash
      - proof_path
      - proof_positions
      - expected_root
      properties:
        expected_root:
          type: string
        leaf_hash:
          type: string
        proof_path:
          type: array
          items:
            type: string
        proof_positions:
          type: array
          items:
            type: integer
            format: int32
    Webhook:
      description: HTTP callback configuration for receiving real-time event notifications.
      type: object
      required:
      - id
      - circuit_id
      - name
      - url
      - events
      - is_active
      - created_by
      - created_at
      - updated_at
      properties:
        circuit_id:
          type: string
          format: uuid
        created_at:
          type: string
          format: date-time
        created_by:
          type: string
          format: uuid
        events: {}
        headers:
          nullable: true
        id:
          type: string
          format: uuid
        is_active:
          type: boolean
        name:
          type: string
        retry_config:
          nullable: true
        secret:
          type: string
          nullable: true
        updated_at:
          type: string
          format: date-time
        url:
          type: string
    WebhookDelivery:
      description: Record of webhook delivery attempt including status, response,
        and retry count.
      type: object
      required:
      - id
      - webhook_id
      - event_id
      - attempt_number
      - status
      - request_body
      - created_at
      properties:
        attempt_number:
          type: integer
          format: int32
        created_at:
          type: string
          format: date-time
        delivered_at:
          type: string
          format: date-time
          nullable: true
        error_message:
          type: string
          nullable: true
        event_id:
          type: string
          format: uuid
        id:
          type: string
          format: uuid
        next_retry_at:
          type: string
          format: date-time
          nullable: true
        request_body: {}
        request_headers:
          nullable: true
        response_body:
          type: string
          nullable: true
        response_headers:
          nullable: true
        response_status_code:
          type: integer
          format: int32
          nullable: true
        status:
          type: string
        webhook_id:
          type: string
          format: uuid
    WebhookRetryConfig:
      description: Retry configuration for failed webhook deliveries (max attempts,
        backoff strategy).
      type: object
      required:
      - max_retries
      - retry_delay
      properties:
        max_retries:
          type: integer
          format: int32
        retry_delay:
          type: integer
          format: int32
    WebhookStats:
      description: Statistics for webhook deliveries including success rate and failure
        count.
      type: object
      required:
      - webhook_id
      - total_deliveries
      - successful_deliveries
      - failed_deliveries
      - updated_at
      properties:
        average_response_time_ms:
          type: integer
          format: int32
          nullable: true
        failed_deliveries:
          type: integer
          format: int64
        last_delivery_at:
          type: string
          format: date-time
          nullable: true
        last_failure_at:
          type: string
          format: date-time
          nullable: true
        last_success_at:
          type: string
          format: date-time
          nullable: true
        successful_deliveries:
          type: integer
          format: int64
        total_deliveries:
          type: integer
          format: int64
        updated_at:
          type: string
          format: date-time
        webhook_id:
          type: string
          format: uuid

    CircuitAdapter:
      type: object
      description: Circuit adapter configuration
      required:
      - id
      - circuit_id
      - adapter_config_id
      - adapter_name
      - adapter_type
      - is_enabled
      - auto_publish
      - trigger_events
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for this circuit adapter configuration
        circuit_id:
          type: string
          format: uuid
          description: ID of the circuit this adapter belongs to
        adapter_config_id:
          type: string
          format: uuid
          description: ID of the adapter configuration being used
        adapter_name:
          type: string
          description: Human-readable adapter name
          example: stellar_mainnet
        adapter_type:
          type: string
          description: Type of adapter
          enum:
          - stellar
          - ipfs
          - nft
          example: stellar
        is_enabled:
          type: boolean
          description: Whether this adapter is enabled for use
          example: true
        auto_publish:
          type: boolean
          description: Whether to automatically publish items when created/updated
          example: true
        trigger_events:
          type: array
          items:
            type: string
          description: Events that trigger auto-publish
          example:
          - item_created
          - item_updated
        rate_limit_per_hour:
          type: integer
          nullable: true
          description: Maximum requests per hour (null = use global default)
          example: 100
        rate_limit_per_day:
          type: integer
          nullable: true
          description: Maximum requests per day (null = use global default)
          example: 1000

    AddCircuitAdapterRequest:
      type: object
      description: Request to add adapter to circuit
      required:
      - adapter_config_id
      properties:
        adapter_config_id:
          type: string
          format: uuid
          description: ID of the adapter configuration to add
        auto_publish:
          type: boolean
          description: Whether to enable automatic publishing on item events
          default: false
          example: true
        trigger_events:
          type: array
          items:
            type: string
          description: Events that trigger auto-publish
          default:
          - item_created
          - item_updated
          example:
          - item_created
          - item_updated
        rate_limit_per_hour:
          type: integer
          nullable: true
          description: Optional custom rate limit per hour
          example: 50
        rate_limit_per_day:
          type: integer
          nullable: true
          description: Optional custom rate limit per day
          example: 500

    UpdateCircuitAdapterRequest:
      type: object
      description: Request to update circuit adapter
      properties:
        is_enabled:
          type: boolean
          description: Enable/disable this adapter completely
          example: true
        auto_publish:
          type: boolean
          description: Enable/disable automatic publishing
          example: false
        trigger_events:
          type: array
          items:
            type: string
          description: Update events that trigger auto-publish
          example:
          - item_created
        rate_limit_per_hour:
          type: integer
          description: Update rate limit per hour
          example: 100
        rate_limit_per_day:
          type: integer
          description: Update rate limit per day
          example: 1000

paths:
  /health:
    get:
      tags:
      - Health
      summary: Gateway health check
      description: Check if the gateway is running
      responses:
        '200':
          description: Gateway is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  service:
                    type: string
                    example: gateway-service
                  status:
                    type: string
                    example: healthy
                  timestamp:
                    type: string
                    format: date-time
  /auth/register:
    post:
      tags:
      - Authentication
      summary: Register a new user
      description: "Create a new user account in the DeFarm platform.\n\n**What it\
        \ does:**\n- Creates a new user with email/password credentials\n- Automatically\
        \ creates a default workspace for the user\n- Assigns the user as workspace\
        \ owner\n- Generates initial authentication tokens\n\n**Requirements:**\n\
        - Valid email address (must be unique)\n- Strong password (minimum 8 characters)\n\
        - Full name for identification\n\n**Response:**\n- User profile with workspace\
        \ information\n- Access token (JWT, expires in 15 minutes)\n- Refresh token\
        \ (expires in 30 days)\n\n**Use cases:**\n- New farmer/organization onboarding\n\
        - Team member registration\n- API client setup\n\n**Example:**\n```json\n\
        POST /auth/register\n{\n  \"email\": \"farmer@example.com\",\n  \"password\"\
        : \"SecurePass123!\",\n  \"full_name\": \"Jo\xE3o Silva\"\n}\n```\n"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - email
              - password
              - full_name
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  minLength: 8
                  example: SecurePassword123!
                full_name:
                  type: string
                  example: John Doe
                name:
                  type: string
                  deprecated: true
                  description: Deprecated alias for full_name
                workspace_slug:
                  type: string
                  nullable: true
                  description: Optional custom workspace slug
                workspace_name:
                  type: string
                  nullable: true
                  description: Optional custom workspace name
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /auth/login:
    post:
      tags:
      - Authentication
      summary: Login with email and password
      description: "Authenticate with email and password to obtain JWT tokens.\n\n\
        **What it does:**\n- Validates credentials against database\n- Generates fresh\
        \ access and refresh tokens\n- Returns user profile and workspace information\n\
        - Tracks login session for activity monitoring\n\n**Token Lifetimes:**\n-\
        \ **Access Token**: 15 minutes (use for API requests)\n- **Refresh Token**:\
        \ 30 days (use to get new access tokens)\n\n**Security:**\n- Passwords are\
        \ hashed with bcrypt\n- Failed login attempts are rate-limited\n- Tokens are\
        \ signed with HS256 (configurable to RS256)\n\n**Response includes:**\n- User\
        \ ID, email, full name, avatar\n- Workspace ID, name, slug, tier, and user's\
        \ role\n- Both access and refresh tokens\n\n**Example:**\n```json\nPOST /auth/login\n\
        {\n  \"email\": \"farmer@example.com\",\n  \"password\": \"SecurePass123!\"\
        \n}\n\nResponse:\n{\n  \"access_token\": \"eyJ0eXAiOiJKV1QiLCJhbGc...\",\n\
        \  \"refresh_token\": \"28214fc8c04cba687dc7...\",\n  \"token_type\": \"Bearer\"\
        ,\n  \"expires_in\": 900,\n  \"user\": {\n    \"id\": \"40a66997-b090-...\"\
        ,\n    \"email\": \"farmer@example.com\",\n    \"workspace\": { ... }\n  }\n\
        }\n```\n\n**Next step:** Add `Authorization: Bearer <access_token>` header\
        \ to all `/api/*` requests\n"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - email
              - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  example: SecurePassword123!
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /auth/refresh:
    post:
      tags:
      - Authentication
      summary: Refresh access token
      description: "Exchange a refresh token for a new access token.\n\n**When to\
        \ use:**\n- Access token expired (returns 401 Unauthorized)\n- Before token\
        \ expires (proactive refresh)\n- On app startup if refresh token is still\
        \ valid\n\n**How it works:**\n1. Send refresh token in request body\n2. Backend\
        \ validates refresh token signature and expiration\n3. If valid, generates\
        \ new access token (15 min lifetime)\n4. Optionally rotates refresh token\
        \ for enhanced security\n\n**Best practices:**\n- Store refresh token securely\
        \ (httpOnly cookie or encrypted storage)\n- Never send refresh token to third\
        \ parties\n- Refresh proactively before access token expires\n- Handle 401\
        \ errors by attempting refresh before re-login\n\n**Example:**\n```json\n\
        POST /auth/refresh\n{\n  \"refresh_token\": \"28214fc8c04cba687dc778e6d8a1e8e2...\"\
        \n}\n\nResponse:\n{\n  \"access_token\": \"eyJ0eXAiOiJKV1QiLCJhbGc...\",\n\
        \  \"expires_in\": 900\n}\n```\n\n**Error handling:**\n- 401: Refresh token\
        \ expired \u2192 redirect to login\n- 400: Invalid token format \u2192 redirect\
        \ to login\n"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - refresh_token
              properties:
                refresh_token:
                  type: string
                  example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
      responses:
        '200':
          description: New access token issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid or expired refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /auth/logout:
    post:
      tags:
      - Authentication
      summary: Logout (revoke refresh token)
      description: 'Invalidate current session and revoke tokens.


        **What it does:**

        - Marks refresh token as revoked in database

        - Ends current user session

        - Tracks logout event in activity log

        - Clears any server-side session data


        **Client responsibilities:**

        - Delete stored tokens from local storage

        - Clear any cached user data

        - Redirect to login page

        - Remove Authorization headers from future requests


        **Security notes:**

        - Access tokens remain valid until expiration (15 min)

        - Refresh token is immediately revoked and cannot be used

        - Use this for explicit user logout or security incidents


        **Example:**

        ```json

        POST /auth/logout

        Authorization: Bearer <access_token>

        ```


        **Response:** 204 No Content (success)

        '
      security:
      - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - refresh_token
              properties:
                refresh_token:
                  type: string
      responses:
        '204':
          description: Successfully logged out
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/circuits:
    get:
      tags:
      - circuits
      summary: GET /circuits?name=...&owner_id=...
      description: 'List circuits (permission-based data repositories) with optional
        filters.


        **What is a Circuit:**

        A circuit is a multi-tenant data repository that isolates data by organization/workspace.

        It serves as the primary permission boundary in DeFarm''s RBAC system.


        **What it does:**

        - Lists all circuits the authenticated user has access to

        - Supports filtering by owner, organization, type, and status

        - Returns paginated results (limit/offset)

        - Includes circuit metadata, member count, and permissions


        **RBAC Requirements:**

        - User must have `read_circuits` permission in at least one circuit

        - Only returns circuits where user is a member

        - Circuit owners see all fields, members see limited fields


        **Common filters:**

        - `owner_id`: Filter by circuit owner UUID

        - `organization_id`: Filter by organization

        - `circuit_type`: Filter by type (private, shared, public, enterprise)

        - `status`: Filter by status (active, inactive, archived)

        - `limit/offset`: Pagination (default: 50 per page)


        **Use cases:**

        - Dashboard: List user''s accessible circuits

        - Admin panel: Organization-wide circuit management

        - API integration: Discover available data repositories


        **Example:**

        ```

        GET /api/circuits?organization_id=abc123&status=active&limit=20

        Authorization: Bearer <access_token>

        ```

        '
      operationId: list_circuits
      parameters:
      - name: owner_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: organization_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: circuit_type
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: status
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: limit
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      - name: offset
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: List of circuits
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListCircuitsResponse'
        '400':
          description: Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    post:
      tags:
      - circuits
      summary: POST /circuits
      description: "Create a new circuit (permission-based data repository).\n\n**What\
        \ it does:**\n- Creates a new multi-tenant data isolation boundary\n- Automatically\
        \ assigns creator as circuit owner\n- Sets up default RBAC permissions\n-\
        \ Generates unique circuit ID\n- Creates audit trail for circuit creation\n\
        \n**Required fields:**\n- `name`: Human-readable circuit name (unique within\
        \ workspace)\n- `circuit_type`: Type of circuit (private, shared, public,\
        \ enterprise)\n- `visibility`: Circuit visibility (private, restricted, public)\n\
        - `owner_id`: Owner user UUID\n\n**Optional fields:**\n- `description`: Circuit\
        \ purpose and context\n- `metadata`: Custom JSON metadata (tags, categories,\
        \ etc.)\n- `settings`: Circuit-specific configuration\n\n**RBAC:**\n- User\
        \ must be workspace owner or admin\n- Creator automatically becomes circuit\
        \ owner with full permissions\n- Circuit owner can then invite members with\
        \ specific roles\n\n**After creation:**\n1. Add members via `POST /api/circuits/{id}/members`\n\
        2. Create items within circuit via `POST /api/items`\n3. Track events via\
        \ `POST /api/events`\n\n**Use cases:**\n- New private or shared circuit onboarding\n\
        - Public/enterprise circuit setup\n- Project-specific data isolation\n\n**Example:**\n\
        ```json\nPOST /api/circuits\n{\n  \"name\": \"Fazenda S\xE3o Jos\xE9 - Soja\
        \ 2025\",\n  \"circuit_type\": \"private\",\n  \"visibility\": \"private\"\
        ,\n  \"owner_id\": \"abc-123-...\",\n  \"description\": \"Safra de soja 2025\
        \ da Fazenda S\xE3o Jos\xE9\",\n  \"metadata\": {\n    \"crop\": \"soy\",\n\
        \    \"season\": \"2025\",\n    \"area_hectares\": 500\n  }\n}\n```\n"
      operationId: create_circuit
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCircuitRequest'
        required: true
      responses:
        '201':
          description: Circuit created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CircuitResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/items:
    get:
      tags:
      - items
      summary: GET /items?dfid=...&value_chain=...
      description: 'List items (physical/digital assets) with optional filters.


        **What is an Item:**

        An item represents a physical or digital asset in the supply chain, uniquely
        identified by a DFID.

        Items can be farm products, livestock, equipment, land parcels, or any trackable
        entity.


        **What it returns:**

        - List of items with DFID, status, metadata

        - Owner and circuit information

        - Current lifecycle stage

        - Relationship graph (parent/child items)

        - Pagination metadata


        **RBAC Requirements:**

        - User must have `read_items` permission in the circuit

        - Only returns items from circuits where user is a member

        - Filters automatically apply circuit boundaries


        **Common filters:**

        - `value_chain`: Filter by value chain (BEEF, SOY, CORN, etc.)

        - `country`: ISO 3166-1 alpha-2 country code (BR, US, etc.)

        - `year`: Item creation year

        - `status`: Item status (pending, active, inactive, archived, local, merged,
        split)

        - `circuit_id`: Filter by specific circuit (via many-to-many JOIN)

        - `limit/offset`: Pagination (default: 50 per page)


        **Use cases:**

        - Dashboard: View all items in a circuit

        - Search: Find items by DFID or metadata

        - Reporting: Filter items by value chain, year, status


        **Example:**

        ```

        GET /api/items?value_chain=BEEF&country=BR&year=2025&status=active&limit=20

        Authorization: Bearer <access_token>

        ```

        '
      operationId: list_items
      parameters:
      - name: value_chain
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: country
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: year
        in: query
        required: false
        schema:
          type: integer
          format: int32
          nullable: true
      - name: status
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: circuit_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: limit
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      - name: offset
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: List of items
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListItemsResponse'
        '400':
          description: Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    post:
      tags:
      - items
      summary: POST /items
      description: "Create a new item with automatic DFID generation.\n\n**What it\
        \ does:**\n- Generates unique DFID for the item\n- Creates item record in\
        \ specified circuit\n- If a canonical identifier already exists, enriches\
        \ the existing item\n- Sets up initial lifecycle stage\n- Creates audit trail\
        \ entry\n- Validates DFID checksum (BLAKE3)\n\n**Required fields:**\n- `value_chain`:\
        \ Value chain code (BEEF, SOY, CORN, etc.)\n- `country`: ISO 3166-1 alpha-2\
        \ country code\n- `circuit_id`: Target circuit UUID\n- `metadata`: Item-specific\
        \ data (weight, breed, location, etc.)\n- `identifiers` (optional): Canonical/contextual\
        \ identifiers (SISBOV, CPF, chip, etc.)\n\n**Optional fields:**\n- `parent_dfid`:\
        \ Parent item DFID (for derived items)\n- `status`: Initial status (default:\
        \ 'active')\n- `tags`: Searchable tags for categorization\n\n**DFID Format:**\n\
        Generated DFID follows: `DFID-{VC}-{CC}-{YYYY}-{NNNNNN}-{CS}`\n- Example:\
        \ `DFID-BEEF-BR-2025-000123-a3f2c1`\n\n**RBAC Requirements:**\n- User must\
        \ have `create_items` permission in the circuit\n- Circuit must be active\
        \ (not archived)\n- Workspace must have available DFID quota\n\n**After creation:**\n\
        1. System detects events from metadata and records them automatically\n2.\
        \ Create snapshots via `POST /api/snapshots`\n3. Establish relationships (merge/split\
        \ operations)\n\n**Use cases:**\n- Register new farm product (batch of soybeans)\n\
        - Add livestock to tracking system\n- Create land parcel record\n\n**Example:**\n\
        ```json\nPOST /api/items\n{\n  \"value_chain\": \"BEEF\",\n  \"country\":\
        \ \"BR\",\n  \"circuit_id\": \"abc-123-...\",\n  \"metadata\": {\n    \"breed\"\
        : \"Nelore\",\n    \"weight_kg\": 450,\n    \"birth_date\": \"2024-01-15\"\
        ,\n    \"farm_name\": \"Fazenda S\xE3o Jos\xE9\"\n  },\n  \"tags\": [\"cattle\"\
        , \"organic\", \"2025-batch\"]\n}\n\nResponse (when created):\n{\n  \"item\"\
        : {\n    \"id\": \"item-uuid-...\",\n    \"dfid\": \"DFID-BEEF-BR-2025-000789-f4e1a2\"\
        ,\n    \"status\": \"active\"\n  },\n  \"events\": [],\n  \"was_deduplicated\"\
        : false\n}\n```\n"
      operationId: create_item
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateItemRequest'
        required: true
      responses:
        '200':
          description: Item already existed and was enriched
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateItemResponse'
        '201':
          description: Item created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateItemResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/dfid/generate:
    post:
      tags:
      - DFID
      summary: Generate DFID
      description: Generate a new DeFarm Identifier
      security:
      - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - value_chain
              - country
              - year
              properties:
                value_chain:
                  type: string
                  example: BEEF
                country:
                  type: string
                  example: BR
                year:
                  type: integer
                  example: 2025
      responses:
        '200':
          description: DFID generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  dfid:
                    type: string
                    example: DFID-BEEF-BR-2025-000123-a3f2c1
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/dfid/validate:
    post:
      tags:
      - DFID
      summary: Validate DFID
      description: Check if a DFID is valid
      security:
      - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - dfid
              properties:
                dfid:
                  type: string
                  example: DFID-BEEF-BR-2025-000123-a3f2c1
      responses:
        '200':
          description: Validation result
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                  dfid:
                    type: string
                  components:
                    type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /swagger-ui:
    get:
      tags:
      - Documentation
      summary: API Documentation UI
      description: Interactive API documentation (Swagger UI)
      responses:
        '200':
          description: Swagger UI HTML
  /api-docs/openapi.json:
    get:
      tags:
      - Documentation
      summary: OpenAPI Specification
      description: Complete OpenAPI 3.0 specification for all endpoints
      responses:
        '200':
          description: OpenAPI JSON
          content:
            application/json:
              schema:
                type: object
  /api/activity/circuit/{circuit_id}:
    get:
      tags:
      - activity
      summary: Get circuit activity feed
      operationId: get_circuit_activity_feed
      parameters:
      - name: circuit_id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      - name: actor_id
        in: query
        description: Filter by actor
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: resource_type
        in: query
        description: Filter by resource type
        required: false
        schema:
          type: string
          nullable: true
      - name: action
        in: query
        description: Filter by action
        required: false
        schema:
          type: string
          nullable: true
      - name: limit
        in: query
        description: Maximum results
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      - name: offset
        in: query
        description: Results offset
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: Circuit activity feed retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ActivityFeed'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/activity/public:
    get:
      tags:
      - activity
      summary: Get public activity feed
      operationId: get_public_activity_feed
      parameters:
      - name: circuit_id
        in: query
        description: Filter by circuit
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: resource_type
        in: query
        description: Filter by resource type
        required: false
        schema:
          type: string
          nullable: true
      - name: action
        in: query
        description: Filter by action
        required: false
        schema:
          type: string
          nullable: true
      - name: limit
        in: query
        description: Maximum results
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      - name: offset
        in: query
        description: Results offset
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: Public activity feed retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ActivityFeed'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/activity/recent:
    get:
      tags:
      - activity
      summary: Get recent activity cache
      operationId: get_recent_activity
      parameters:
      - name: user_id
        in: query
        description: User ID
        required: true
        schema:
          type: string
          format: uuid
      - name: limit
        in: query
        description: 'Maximum results (default: 10)'
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: Recent activity retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/RecentActivity'
        '400':
          description: Missing user_id parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/activity/summaries:
    get:
      tags:
      - activity
      summary: Get activity summaries
      operationId: get_activity_summaries
      parameters:
      - name: circuit_id
        in: query
        description: Filter by circuit
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: user_id
        in: query
        description: Filter by user
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: start_date
        in: query
        description: Start date (YYYY-MM-DD)
        required: true
        schema:
          type: string
      - name: end_date
        in: query
        description: End date (YYYY-MM-DD)
        required: true
        schema:
          type: string
      - name: summary_type
        in: query
        description: Summary type (daily, weekly, monthly)
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Activity summaries retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ActivitySummary'
        '400':
          description: Invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/activity/user/{user_id}:
    get:
      tags:
      - activity
      summary: Get user activity feed
      operationId: get_user_activity_feed
      parameters:
      - name: user_id
        in: path
        description: User ID
        required: true
        schema:
          type: string
          format: uuid
      - name: circuit_id
        in: query
        description: Filter by circuit
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: resource_type
        in: query
        description: Filter by resource type
        required: false
        schema:
          type: string
          nullable: true
      - name: action
        in: query
        description: Filter by action
        required: false
        schema:
          type: string
          nullable: true
      - name: limit
        in: query
        description: Maximum results
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      - name: offset
        in: query
        description: Results offset
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: Activity feed retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ActivityFeed'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/admin/api-keys:
    post:
      tags:
      - admin
      summary: POST /admin/api-keys
      description: "Create a new API key for circuit access\n\n**\u26A0\uFE0F SECURITY**:\
        \ The API key is only returned once and cannot be retrieved later!"
      operationId: create_api_key
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateApiKeyRequest'
        required: true
      responses:
        '201':
          description: API key created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateApiKeyResponse'
        '500':
          description: Internal server error
  /api/admin/api-keys/{circuit_id}:
    get:
      tags:
      - admin
      summary: GET /admin/api-keys/:circuit_id
      description: 'List API keys for a circuit


        Returns metadata about API keys without revealing the actual key values.'
      operationId: list_api_keys
      parameters:
      - name: circuit_id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: List of API keys returned
        '500':
          description: Internal server error
  /api/admin/api-keys/{id}/metrics:
    get:
      tags:
      - admin
      summary: GET /admin/api-keys/{id}/metrics
      description: Get API key metrics (admin only)
      operationId: get_api_key_metrics
      parameters:
      - name: id
        in: path
        description: API key ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: API key metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiKeyMetricsResponse'
        '403':
          description: Admin key required
        '404':
          description: API key not found
        '500':
          description: Internal server error
  /api/admin/adapter/metrics:
    get:
      tags:
      - admin
      summary: GET /admin/adapter/metrics
      description: |
        Get Prometheus metrics from adapter service (admin only).

        Returns metrics in Prometheus text format for scraping by monitoring systems.

        **Use case**: Connect Prometheus to scrape this endpoint for monitoring.
      operationId: get_adapter_metrics
      responses:
        '200':
          description: Prometheus metrics in text format
          content:
            text/plain:
              schema:
                type: string
                example: |
                  # HELP adapter_jobs_processed_total Total number of publishing jobs processed
                  # TYPE adapter_jobs_processed_total counter
                  adapter_jobs_processed_total{status="completed",adapter_type="stellar"} 1234
                  adapter_jobs_processed_total{status="failed",adapter_type="stellar"} 5
                  adapter_queue_depth 10
                  adapter_active_workers 2
        '403':
          description: Admin authentication required
        '500':
          description: Internal server error
      security:
      - bearerAuth: []
  /api/admin/adapter/stats:
    get:
      tags:
      - admin
      summary: GET /admin/adapter/stats
      description: |
        Get adapter service statistics in JSON format (admin only).

        Returns human-readable statistics including:
        - Job completion rates
        - Queue depth and active workers
        - Adapter success/failure rates (Stellar, IPFS)
        - Cost tracking (Stellar XLM/USD, IPFS storage)
        - Rate limit rejections

        **Use case**: Display statistics in admin dashboard UI.
      operationId: get_adapter_stats
      responses:
        '200':
          description: Adapter statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdapterStatsResponse'
        '403':
          description: Admin authentication required
        '500':
          description: Internal server error
      security:
      - bearerAuth: []
  /api/admin/users:
    post:
      tags:
      - admin
      summary: POST /admin/users
      description: |
        Create/invite a new user (admin only).

        Creates a new user with specified role and workspace.
        If workspace_id is not provided, creates a new personal workspace.

        **Use case**: Admin invites new team members or partners.
      operationId: create_admin_user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - email
              - password
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 8
                full_name:
                  type: string
                  nullable: true
                role:
                  type: string
                  enum: [admin, partner, editor, viewer]
                  default: viewer
                workspace_id:
                  type: string
                  format: uuid
                  nullable: true
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  user_id:
                    type: string
                    format: uuid
                  workspace_id:
                    type: string
                    format: uuid
                  role:
                    type: string
        '400':
          description: Validation error
        '403':
          description: Admin authentication required
        '409':
          description: Email already registered
      security:
      - bearerAuth: []
    get:
      tags:
      - admin
      summary: GET /admin/users
      description: |
        List all users in the system (admin only).

        Returns complete user information including roles, status, and workspace.

        **Use case**: Admin dashboard user management.
      operationId: list_admin_users
      responses:
        '200':
          description: List of users
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                      format: uuid
                    email:
                      type: string
                    full_name:
                      type: string
                      nullable: true
                    role:
                      type: string
                    is_active:
                      type: boolean
                    workspace_id:
                      type: string
                      format: uuid
                    workspace_name:
                      type: string
                    created_at:
                      type: string
                      format: date-time
                    updated_at:
                      type: string
                      format: date-time
                    last_login_at:
                      type: string
                      format: date-time
                      nullable: true
        '403':
          description: Admin authentication required
      security:
      - bearerAuth: []
  /api/admin/users/{id}:
    delete:
      tags:
      - admin
      summary: DELETE /admin/users/{id}
      description: |
        Permanently delete a user (admin only).

         **WARNING**: This action cannot be undone.

        **Use case**: Remove user accounts.
      operationId: delete_admin_user
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: User deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  user_id:
                    type: string
                    format: uuid
        '403':
          description: Admin authentication required
        '404':
          description: User not found
      security:
      - bearerAuth: []
  /api/admin/users/{id}/role:
    patch:
      tags:
      - admin
      summary: PATCH /admin/users/{id}/role
      description: |
        Update user role (admin only).

        Changes a user's role within their workspace.

        **Use case**: Promote/demote users.
      operationId: update_user_role
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - role
              properties:
                role:
                  type: string
                  enum: [admin, partner, editor, viewer]
      responses:
        '200':
          description: Role updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  user_id:
                    type: string
                    format: uuid
                  role:
                    type: string
        '400':
          description: Validation error
        '403':
          description: Admin authentication required
        '404':
          description: User not found
      security:
      - bearerAuth: []
  /api/admin/users/{id}/status:
    patch:
      tags:
      - admin
      summary: PATCH /admin/users/{id}/status
      description: |
        Activate/deactivate user account (admin only).

        Deactivated users cannot log in.

        **Use case**: Temporarily disable user access.
      operationId: update_user_status
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - is_active
              properties:
                is_active:
                  type: boolean
      responses:
        '200':
          description: Status updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  user_id:
                    type: string
                    format: uuid
                  is_active:
                    type: boolean
        '403':
          description: Admin authentication required
        '404':
          description: User not found
      security:
      - bearerAuth: []
  /api/admin/canonical-identifiers:
    post:
      tags:
      - admin
      summary: POST /admin/canonical-identifiers
      description: Create or enable a canonical identifier type for a value chain
      operationId: create_canonical_identifier
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCanonicalIdentifierRequest'
        required: true
      responses:
        '201':
          description: Canonical identifier created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CanonicalIdentifierResponse'
        '403':
          description: Admin key required
        '500':
          description: Internal server error
  /api/admin/canonical-identifiers/value-chain/{value_chain}:
    get:
      tags:
      - admin
      summary: GET /admin/canonical-identifiers/value-chain/{value_chain}
      description: List canonical identifier types for a value chain
      operationId: list_canonical_identifiers
      parameters:
      - name: value_chain
        in: path
        description: Value chain code
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Canonical identifiers
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CanonicalIdentifierResponse'
        '403':
          description: Admin key required
        '500':
          description: Internal server error
  /api/admin/canonical-identifiers/{id}:
    patch:
      tags:
      - admin
      summary: PATCH /admin/canonical-identifiers/{id}
      description: Enable or disable a canonical identifier type
      operationId: update_canonical_identifier
      parameters:
      - name: id
        in: path
        description: Canonical identifier ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCanonicalIdentifierRequest'
        required: true
      responses:
        '200':
          description: Canonical identifier updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CanonicalIdentifierResponse'
        '403':
          description: Admin key required
        '500':
          description: Internal server error
  /api/partner/api-keys:
    post:
      tags:
      - partner-api-keys
      summary: POST /api/partner/api-keys
      description: 'Create a new API key for your circuit.


        The API key is only shown once at creation time.'
      operationId: create_partner_api_key
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePartnerApiKeyRequest'
        required: true
      responses:
        '201':
          description: API key created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreatePartnerApiKeyResponse'
        '400':
          description: Invalid request
        '401':
          description: Unauthorized - invalid or missing JWT token
        '403':
          description: Forbidden - insufficient permissions in circuit
        '500':
          description: Internal server error
      security:
      - bearerAuth: []
    get:
      tags:
      - partner-api-keys
      summary: GET /api/partner/api-keys
      description: List your API keys across all circuits
      operationId: list_partner_api_keys
      responses:
        '200':
          description: List of your API keys
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PartnerApiKeyResponse'
        '401':
          description: Unauthorized
        '500':
          description: Internal server error
      security:
      - bearerAuth: []
  /api/partner/api-keys/{id}:
    delete:
      tags:
      - partner-api-keys
      summary: DELETE /api/partner/api-keys/{id}
      description: Revoke (deactivate) an API key
      operationId: revoke_partner_api_key
      parameters:
      - name: id
        in: path
        description: API key ID to revoke
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '204':
          description: API key revoked successfully
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - you don't own this key
        '404':
          description: API key not found
        '500':
          description: Internal server error
      security:
      - bearerAuth: []
  /api/partner/api-keys/{id}/metrics:
    get:
      tags:
      - partner-api-keys
      summary: GET /api/partner/api-keys/{id}/metrics
      description: Get metrics for a specific API key
      operationId: get_partner_api_key_metrics
      parameters:
      - name: id
        in: path
        description: API key ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: API key metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiKeyMetricsResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - you don't own this key
        '404':
          description: API key not found
        '500':
          description: Internal server error
      security:
      - bearerAuth: []
  /api/audit:
    get:
      tags:
      - audit
      summary: GET /audit?user_id=...&action=...
      description: 'List immutable audit logs with optional filters.


        **What is the Audit System:**

        DeFarm uses a hash-chained audit trail to provide tamper-proof records of
        all operations.

        Each audit log entry is cryptographically linked to the previous entry, making
        it impossible

        to modify or delete past records without detection.


        **What it returns:**

        - Audit log entries with timestamps

        - Actor (user) who performed the action

        - Action type (CREATE, UPDATE, DELETE, etc.)

        - Resource affected (item, circuit, member, etc.)

        - Old and new values (for updates)

        - Hash chain linkage (previous_hash, current_hash)

        - Circuit context


        **RBAC Requirements:**

        - User must be a member of the circuit (any role)

        - Only returns audit logs from circuits where user has access

        - System-level audits visible only to workspace admins


        **Common filters:**

        - `user_id`: Filter by actor who performed actions

        - `action`: Filter by action type (CREATE, UPDATE, DELETE, etc.)

        - `resource_type`: Filter by resource (item, circuit, member, event, etc.)

        - `resource_id`: Filter by specific resource UUID

        - `circuit_id`: Filter by circuit

        - `limit/offset`: Pagination (default: 50 per page)


        **Use cases:**

        - Compliance and regulatory reporting

        - Security investigation and forensics

        - Data lineage and provenance tracking

        - Verify data integrity


        **Example:**

        ```

        GET /api/audit?action=UPDATE&resource_type=item&circuit_id=abc-123&limit=20

        Authorization: Bearer <access_token>

        ```

        '
      operationId: list_audit_logs
      parameters:
      - name: user_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: action
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: resource_type
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: resource_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: circuit_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: limit
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      - name: offset
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: List of audit logs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListAuditLogsResponse'
        '400':
          description: Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/audit/verify:
    get:
      tags:
      - audit
      summary: GET /audit/verify?limit=...
      description: "Verify cryptographic hash chain integrity of audit logs.\n\n**What\
        \ it does:**\n- Validates hash chain linkage between audit log entries\n-\
        \ Detects any tampering or data corruption\n- Reports broken links and inconsistencies\n\
        - Verifies each entry's hash against computed hash\n\n**How hash chain works:**\n\
        ```\nEntry 1: hash = BLAKE3(timestamp + action + data + \"genesis\")\nEntry\
        \ 2: hash = BLAKE3(timestamp + action + data + Entry1.hash)\nEntry 3: hash\
        \ = BLAKE3(timestamp + action + data + Entry2.hash)\n...\n```\n\n**RBAC Requirements:**\n\
        - User must have `read_audit` permission\n- Only verifies audit logs from\
        \ accessible circuits\n- System-level verification requires admin privileges\n\
        \n**Verification process:**\n1. Fetches audit log entries (most recent N or\
        \ all)\n2. Recomputes hash for each entry\n3. Compares computed hash with\
        \ stored hash\n4. Validates linkage (entry.previous_hash == previous_entry.hash)\n\
        5. Reports any mismatches or gaps\n\n**Query parameters:**\n- `limit`: Maximum\
        \ number of logs to verify (default: all accessible)\n\n**Response includes:**\n\
        - Total logs verified\n- Verification status (valid, invalid, partial)\n-\
        \ List of broken links (if any)\n- First and last verified entry\n- Verification\
        \ timestamp\n\n**Use cases:**\n- Compliance audit requirements\n- Detect data\
        \ tampering attempts\n- Verify system integrity\n- Forensic investigation\n\
        \n**Example:**\n```\nGET /api/audit/verify?limit=1000\nAuthorization: Bearer\
        \ <access_token>\n\nResponse:\n{\n  \"status\": \"valid\",\n  \"total_verified\"\
        : 1000,\n  \"broken_links\": [],\n  \"first_entry\": \"2025-01-01T00:00:00Z\"\
        ,\n  \"last_entry\": \"2025-02-08T15:30:00Z\"\n}\n```\n"
      operationId: verify_hash_chain
      parameters:
      - name: limit
        in: query
        description: Maximum number of logs to verify
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: Hash chain verification result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HashChainVerificationResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/audit/{id}:
    get:
      tags:
      - audit
      summary: GET /audit/:id
      description: "Retrieve detailed information about a specific audit log entry.\n\
        \n**What it returns:**\n- Audit log UUID and timestamp\n- Actor (user) who\
        \ performed the action\n- Action type (CREATE, UPDATE, DELETE, etc.)\n- Resource\
        \ type and ID (item, circuit, member, etc.)\n- Old and new values (for updates)\n\
        - Context and metadata\n- Hash chain information:\n  - `current_hash`: BLAKE3\
        \ hash of this entry\n  - `previous_hash`: Hash of previous entry (linkage)\n\
        - Circuit context\n\n**RBAC Requirements:**\n- User must have `read_audit`\
        \ permission\n- User must be a member of the circuit where audit log belongs\n\
        - Returns 403 if user lacks access\n\n**Audit log fields:**\n- `id`: UUID\
        \ of audit log entry\n- `timestamp`: When action occurred (UTC)\n- `user_id`:\
        \ Actor who performed action\n- `action`: Action type (CREATE, UPDATE, DELETE,\
        \ etc.)\n- `resource_type`: Type of resource (item, circuit, etc.)\n- `resource_id`:\
        \ UUID of affected resource\n- `old_value`: State before action (JSON)\n-\
        \ `new_value`: State after action (JSON)\n- `metadata`: Additional context\n\
        - `current_hash`: BLAKE3 hash for integrity\n- `previous_hash`: Link to previous\
        \ entry\n\n**Use cases:**\n- Audit log detail page\n- Investigate specific\
        \ data change\n- Verify hash chain linkage\n- Forensic analysis\n\n**Example:**\n\
        ```\nGET /api/audit/550e8400-e29b-41d4-a716-446655440000\nAuthorization: Bearer\
        \ <access_token>\n```\n"
      operationId: get_audit_log
      parameters:
      - name: id
        in: path
        description: Audit log ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Audit log found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditLogResponse'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Audit log not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/circuits/{id}:
    get:
      tags:
      - circuits
      summary: GET /circuits/:id
      description: 'Retrieve detailed information about a specific circuit.


        **What it returns:**

        - Circuit metadata (name, type, description, status)

        - Owner and organization information

        - Member count and your role/permissions

        - Circuit settings and configuration

        - Creation and update timestamps


        **RBAC Requirements:**

        - User must be a member of the circuit (any role)

        - Requires `read_circuits` permission

        - Different roles see different levels of detail


        **Visibility by role:**

        - **Owner/Admin**: Full details including all metadata and settings

        - **Editor/Member**: Basic info and operational fields

        - **Viewer**: Read-only fields only


        **Use cases:**

        - Circuit dashboard page

        - Permission checks before operations

        - Audit trail and compliance reports


        **Example:**

        ```

        GET /api/circuits/abc-123-def-456

        Authorization: Bearer <access_token>

        ```

        '
      operationId: get_circuit
      parameters:
      - name: id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Circuit found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CircuitResponse'
        '404':
          description: Circuit not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    put:
      tags:
      - circuits
      summary: PUT /circuits/:id
      description: "Update circuit details and configuration.\n\n**What you can update:**\n\
        - Circuit name (must remain unique within workspace)\n- Description and metadata\n\
        - Circuit type (with restrictions)\n- Settings and configuration\n- Status\
        \ (active \u2192 archived, etc.)\n\n**RBAC Requirements:**\n- User must have\
        \ `admin` permission in the circuit\n- Only circuit owners/admins can update\n\
        - Some fields require owner-level access\n\n**Restricted fields:**\n- `workspace_id`:\
        \ Cannot be changed (permanent association)\n- `created_at`: Immutable timestamp\n\
        - `owner_id`: Use transfer ownership endpoint instead\n\n**Audit trail:**\n\
        - All updates are logged in audit trail\n- Includes actor, timestamp, old/new\
        \ values\n- Immutable record for compliance\n\n**Use cases:**\n- Update circuit\
        \ metadata as project evolves\n- Archive completed supply chains\n- Adjust\
        \ settings and configuration\n\n**Example:**\n```json\nPUT /api/circuits/abc-123-def-456\n\
        {\n  \"name\": \"Fazenda S\xE3o Jos\xE9 - Soja 2025 (Atualizado)\",\n  \"\
        description\": \"Safra expandida com \xE1rea adicional\",\n  \"metadata\"\
        : {\n    \"crop\": \"soy\",\n    \"season\": \"2025\",\n    \"area_hectares\"\
        : 750\n  },\n  \"status\": \"active\"\n}\n```\n"
      operationId: update_circuit
      parameters:
      - name: id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCircuitRequest'
        required: true
      responses:
        '200':
          description: Circuit updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CircuitResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Circuit not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      tags:
      - circuits
      summary: DELETE /circuits/:id
      description: 'Soft delete a circuit (archive it, but preserve data).


        **What it does:**

        - Marks circuit as archived (status = ''archived'')

        - Preserves all data for audit/compliance

        - Removes from active circuit lists

        - Maintains data integrity for related items/events

        - Creates audit log entry


        **RBAC Requirements:**

        - User must be circuit owner

        - Requires workspace owner approval for production circuits

        - Cannot delete circuits with active workflows


        **Data preservation:**

        - Circuit data remains in database

        - Items within circuit are preserved

        - Audit trail remains accessible

        - Can be restored by system admin


        **Cascade behavior:**

        - Does NOT delete items (items remain accessible)

        - Does NOT delete events or audit logs

        - Member access is revoked immediately

        - Webhooks are disabled


        **Use cases:**

        - Decommission completed supply chains

        - Remove test/demo circuits

        - Compliance with data retention policies


        **Important:**

        This is a soft delete. For hard delete (permanent data removal), contact support.


        **Example:**

        ```

        DELETE /api/circuits/abc-123-def-456

        Authorization: Bearer <access_token>

        ```

        '
      operationId: delete_circuit
      parameters:
      - name: id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '204':
          description: Circuit archived successfully
        '404':
          description: Circuit not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/circuits/{id}/members:
    get:
      tags:
      - circuits
      summary: GET /circuits/:id/members
      description: 'List all members of a circuit with their roles and permissions.


        **What it returns:**

        For each member:

        - User ID, email, name, avatar

        - Role (owner, admin, editor, member, viewer)

        - Permissions object (read, write, admin, manage_members, etc.)

        - Custom permissions (if overriding role defaults)

        - Join date and last activity


        **RBAC Requirements:**

        - User must be a member of the circuit

        - All members can see member list (transparency)

        - Permission details visible only to admins


        **Member roles:**

        - **Owner**: Full control, cannot be removed, typically 1 per circuit

        - **Admin**: Can manage members and settings

        - **Editor**: Can create/edit items and events

        - **Member**: Can create items within scope

        - **Viewer**: Read-only access


        **Use cases:**

        - Member management dashboard

        - Permission audit and compliance

        - Team collaboration views


        **Example:**

        ```

        GET /api/circuits/abc-123-def-456/members

        Authorization: Bearer <access_token>

        ```

        '
      operationId: list_members
      parameters:
      - name: id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: List of circuit members
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListMembersResponse'
        '404':
          description: Circuit not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    post:
      tags:
      - circuits
      summary: POST /circuits/:id/members
      description: "Add a new member to a circuit with specified role and permissions.\n\
        \n**What it does:**\n- Adds user to circuit with specified role\n- Grants\
        \ standard permissions for that role\n- Optionally sets custom permissions\n\
        - Creates audit log entry\n- Sends notification to added user\n\n**Required\
        \ fields:**\n- `user_id`: UUID of user to add (must exist in workspace)\n\
        - `role`: One of: owner, admin, editor, member, viewer\n\n**Optional fields:**\n\
        - `custom_permissions`: Override standard role permissions\n- `notify`: Send\
        \ invitation email (default: true)\n\n**RBAC Requirements:**\n- User must\
        \ have `manage_members` permission\n- Only admins/owners can add members\n\
        - Cannot add duplicate members (409 Conflict)\n\n**Standard permissions by\
        \ role:**\n- **Admin**: Full permissions except ownership transfer\n- **Editor**:\
        \ Create/edit items, create events, read all\n- **Member**: Create items,\
        \ read circuits/items\n- **Viewer**: Read-only access to circuits and items\n\
        \n**Use cases:**\n- Onboard new team members\n- Grant external auditors view\
        \ access\n- Add suppliers/farmers to supply chain\n\n**Example:**\n```json\n\
        POST /api/circuits/abc-123-def-456/members\n{\n  \"user_id\": \"user-uuid-123\"\
        ,\n  \"role\": \"editor\",\n  \"notify\": true\n}\n```\n"
      operationId: add_member
      parameters:
      - name: id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddMemberRequest'
        required: true
      responses:
        '201':
          description: Member added successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CircuitMemberResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Circuit not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Member already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/circuits/{id}/members/{user_id}:
    get:
      tags:
      - circuits
      summary: GET /circuits/:id/members/:user_id
      description: 'Get detailed information about a specific circuit member.


        **What it returns:**

        - User profile (ID, email, name, avatar)

        - Current role in the circuit

        - Standard permissions from role

        - Custom permissions (if any overrides exist)

        - Join date and activity timestamps

        - Invitation details (invited_by, accepted_at)


        **RBAC Requirements:**

        - User must be a member of the circuit

        - All members can view other member details

        - Custom permissions visible only to admins


        **Use cases:**

        - Member profile page

        - Permission verification before operations

        - Activity tracking and auditing


        **Example:**

        ```

        GET /api/circuits/abc-123/members/user-456

        Authorization: Bearer <access_token>

        ```

        '
      operationId: get_member
      parameters:
      - name: id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      - name: user_id
        in: path
        description: User ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Member found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CircuitMemberResponse'
        '404':
          description: Member not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    put:
      tags:
      - circuits
      summary: PUT /circuits/:id/members/:user_id
      description: "Update a circuit member's role or permissions.\n\n**What you can\
        \ update:**\n- Role (promote/demote between roles)\n- Custom permissions (override\
        \ role defaults)\n- Member status (active, suspended)\n\n**RBAC Requirements:**\n\
        - User must have `manage_members` permission\n- Only admins/owners can update\
        \ members\n- Cannot demote circuit owner\n- Cannot modify your own permissions\n\
        \n**Role changes:**\n- Viewer \u2192 Member \u2192 Editor \u2192 Admin \u2192\
        \ Owner\n- Role change updates standard permissions automatically\n- Custom\
        \ permissions are preserved unless explicitly cleared\n\n**Permission overrides:**\n\
        - Can grant/revoke specific permissions\n- Custom permissions take precedence\
        \ over role defaults\n- Use carefully - prefer standard roles for clarity\n\
        \n**Audit trail:**\n- All permission changes are logged\n- Includes actor,\
        \ timestamp, old/new values\n- Visible in audit log\n\n**Use cases:**\n- Promote\
        \ trusted members to admin\n- Grant temporary elevated access\n- Revoke specific\
        \ permissions without changing role\n\n**Example:**\n```json\nPUT /api/circuits/abc-123/members/user-456\n\
        {\n  \"role\": \"admin\",\n  \"custom_permissions\": null\n}\n```\n"
      operationId: update_member
      parameters:
      - name: id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      - name: user_id
        in: path
        description: User ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateMemberRequest'
        required: true
      responses:
        '200':
          description: Member updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CircuitMemberResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Member not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      tags:
      - circuits
      summary: DELETE /circuits/:id/members/:user_id
      description: 'Remove a member from a circuit (revoke all access).


        **What it does:**

        - Immediately revokes all circuit access

        - Removes user from circuit member list

        - Preserves audit trail of member''s past actions

        - Creates audit log entry for removal

        - Sends notification to removed user


        **RBAC Requirements:**

        - User must have `manage_members` permission

        - Only admins/owners can remove members

        - Cannot remove circuit owner

        - Cannot remove yourself (use leave endpoint)


        **Data preservation:**

        - Member''s past actions remain in audit trail

        - Items created by member are NOT deleted

        - Events created by member are preserved

        - Attribution remains for compliance


        **Cascade behavior:**

        - Access revoked immediately (active sessions invalidated)

        - Member cannot access circuit via API or UI

        - Pending invitations are cancelled

        - Webhooks for this user are disabled


        **Use cases:**

        - Remove team members who left organization

        - Revoke access after contract ends

        - Remove users who violated policies


        **Query parameters:**

        - `removed_by`: UUID of user performing removal (for audit)


        **Example:**

        ```

        DELETE /api/circuits/abc-123/members/user-456?removed_by=admin-789

        Authorization: Bearer <access_token>

        ```

        '
      operationId: remove_member
      parameters:
      - name: id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      - name: user_id
        in: path
        description: User ID
        required: true
        schema:
          type: string
          format: uuid
      - name: removed_by
        in: query
        description: User performing the removal
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      responses:
        '204':
          description: Member removed successfully
        '404':
          description: Member not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/circuits/{id}/items/{item_id}:
    delete:
      tags:
      - circuits
      summary: DELETE /circuits/:id/items/:item_id - Remove item from circuit
      description: |
        **Protected endpoint** - Requires JWT authentication + `delete_items` permission.

        Removes the association between an item and a circuit **without deleting the item**.

        **What happens:**
        - Item removed from circuit (circuit_items junction table entry deleted)
        - Item continues to exist globally with its DFID
        - Item remains in other circuits (if multi-circuit item)
        - Item metadata unchanged

        **Use cases:**
        - Remove incorrectly added item
        - Clean up old/inactive items from circuit
        - Reorganize circuit membership

        **Example:**
        ```
        DELETE /api/circuits/550e8400-e29b-41d4-a716-446655440000/items/123e4567-e89b-12d3-a456-426614174000
        Authorization: Bearer <access_token>
        ```

        **Note:** Requires owner or admin role in the circuit.
      operationId: remove_item_from_circuit
      parameters:
      - name: id
        in: path
        description: Circuit UUID
        required: true
        schema:
          type: string
          format: uuid
      - name: item_id
        in: path
        description: Item UUID to remove
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '204':
          description: Item removed from circuit successfully (no content)
        '401':
          description: Unauthorized - JWT required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - requires delete_items permission (owner/admin only)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Item not found or not in circuit
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      security:
      - bearer_auth: []
  /api/circuits/public:
    get:
      tags:
      - circuits
      summary: GET /circuits/public - List public circuits for discovery
      description: '**Public endpoint** - No authentication required.


        Discover public circuits available for joining.


        **Use cases:**

        - Browse available circuits in your region/industry

        - Search for circuits by name or type

        - View featured circuits


        **Example:**

        ```

        GET /api/circuits/public?search=soja&circuit_type=producer&featured=true

        ```

        '
      operationId: list_public_circuits
      parameters:
      - name: search
        in: query
        description: Search by circuit name or description
        required: false
        schema:
          type: string
      - name: circuit_type
        in: query
        description: Filter by circuit type
        required: false
        schema:
          type: string
          enum:
          - producer
          - processor
          - distributor
          - marketplace
      - name: featured
        in: query
        description: Show only featured circuits
        required: false
        schema:
          type: boolean
      - name: limit
        in: query
        description: Maximum results (max 100)
        required: false
        schema:
          type: integer
          default: 50
          maximum: 100
      - name: offset
        in: query
        description: Pagination offset
        required: false
        schema:
          type: integer
          default: 0
      responses:
        '200':
          description: List of public circuits
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublicCircuitsResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/circuits/{id}/public:
    get:
      tags:
      - circuits
      summary: GET /circuits/:id/public - Public circuit portfolio
      description: '**Public endpoint** - No authentication required.


        View a circuit''s public portfolio including stats, recent items, and info.


        **What it returns:**

        - Circuit name, description, banner, logo

        - Member and item counts

        - Statistics (value chains, countries, recent activity)

        - Recent items (last 10 DFIDs)


        **Use cases:**

        - Share circuit portfolio via public URL

        - Showcase circuit activity to potential members

        - Public transparency for supply chain


        **Example:**

        ```

        GET /api/circuits/550e8400-e29b-41d4-a716-446655440000/public

        ```

        '
      operationId: get_public_portfolio
      parameters:
      - name: id
        in: path
        description: Circuit UUID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Circuit public portfolio
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublicCircuitPortfolio'
        '404':
          description: Circuit not found or not public
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/circuits/{id}/join-requests:
    post:
      tags:
      - circuits
      summary: POST /circuits/:id/join-requests - Request to join circuit
      description: "**Protected endpoint** - Requires JWT authentication.\n\nSubmit\
        \ a request to join a public circuit. The circuit admins will review and approve/reject.\n\
        \n**Requirements:**\n- Circuit must be public\n- Circuit must allow join requests\n\
        - User must not already be a member\n- User cannot have a pending request\n\
        \n**Example:**\n```json\nPOST /api/circuits/550e8400-e29b-41d4-a716-446655440000/join-requests\n\
        Authorization: Bearer <access_token>\n\n{\n  \"message\": \"Sou produtor de\
        \ soja em Dourados/MS e gostaria de participar\",\n  \"user_metadata\": {\n\
        \    \"company\": \"Fazenda S\xE3o Jo\xE3o\",\n    \"location\": \"Dourados,\
        \ MS\"\n  }\n}\n```\n"
      operationId: create_join_request
      parameters:
      - name: id
        in: path
        description: Circuit UUID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateJoinRequestPayload'
      responses:
        '201':
          description: Join request created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CircuitJoinRequest'
        '400':
          description: Invalid request or circuit not accepting requests
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized - JWT required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: User already member or has pending request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      security:
      - bearer_auth: []
    get:
      tags:
      - circuits
      summary: GET /circuits/:id/join-requests - List join requests (admin)
      description: '**Protected endpoint** - Requires JWT authentication + `manage_members`
        permission.


        List all join requests for a circuit. Only circuit owners/admins can access.


        **Example:**

        ```

        GET /api/circuits/550e8400-e29b-41d4-a716-446655440000/join-requests?status=pending

        Authorization: Bearer <access_token>

        ```

        '
      operationId: list_join_requests
      parameters:
      - name: id
        in: path
        description: Circuit UUID
        required: true
        schema:
          type: string
          format: uuid
      - name: status
        in: query
        description: Filter by status
        required: false
        schema:
          type: string
          enum:
          - pending
          - approved
          - rejected
      responses:
        '200':
          description: List of join requests
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CircuitJoinRequest'
        '401':
          description: Unauthorized - JWT required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - requires manage_members permission
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      security:
      - bearer_auth: []
  /api/circuits/{id}/join-requests/{request_id}:
    put:
      tags:
      - circuits
      summary: PUT /circuits/:id/join-requests/:request_id - Review request (admin)
      description: "**Protected endpoint** - Requires JWT authentication + `manage_members`\
        \ permission.\n\nApprove or reject a join request. If approved, user is automatically\
        \ added as circuit member.\n\n**What happens on approval:**\n- Request status\
        \ \u2192 `approved`\n- User added to `circuit_members` with specified role\n\
        - User receives notification (future)\n\n**What happens on rejection:**\n\
        - Request status \u2192 `rejected`\n- Optional rejection reason recorded\n\
        - User receives notification (future)\n\n**Example (approve):**\n```json\n\
        PUT /api/circuits/550e8400.../join-requests/abc-123...\nAuthorization: Bearer\
        \ <access_token>\n\n{\n  \"action\": \"approve\",\n  \"role\": \"member\"\n\
        }\n```\n\n**Example (reject):**\n```json\nPUT /api/circuits/550e8400.../join-requests/abc-123...\n\
        Authorization: Bearer <access_token>\n\n{\n  \"action\": \"reject\",\n  \"\
        rejection_reason\": \"Circuit is full\"\n}\n```\n"
      operationId: review_join_request
      parameters:
      - name: id
        in: path
        description: Circuit UUID
        required: true
        schema:
          type: string
          format: uuid
      - name: request_id
        in: path
        description: Join request UUID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReviewJoinRequestInput'
      responses:
        '200':
          description: Join request reviewed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CircuitJoinRequest'
        '400':
          description: Invalid action or request already reviewed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized - JWT required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - requires manage_members permission
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Join request not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      security:
      - bearer_auth: []
  /api/items/{dfid}/public:
    get:
      tags:
      - items
      summary: GET /items/:dfid/public - Public item details
      description: |
        **Public endpoint** - No authentication required.

        View item details for items that belong to public circuits.

        **What it returns:**
        - Item DFID, value chain, country, year
        - Metadata (breed, weight, etc.)
        - Status (active, sold, etc.)
        - Created/updated timestamps

        **Use cases:**
        - Share item information via public URL
        - Display item details on public circuit portfolio
        - External verification of item data

        **Example:**
        ```
        GET /api/items/DFID-BEEF-BR-2025-000123-a3f2c1/public
        ```

        **Note:** Only returns items from public circuits. Private circuit items return 404.
      operationId: get_item_public
      parameters:
      - name: dfid
        in: path
        description: Item DFID
        required: true
        schema:
          type: string
          example: DFID-BEEF-BR-2025-000123-a3f2c1
      responses:
        '200':
          description: Public item details
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  dfid:
                    type: string
                    example: DFID-BEEF-BR-2025-000123-a3f2c1
                  value_chain:
                    type: string
                    example: BEEF
                  country:
                    type: string
                    example: BR
                  year:
                    type: integer
                    example: 2025
                  status:
                    type: string
                    example: active
                  metadata:
                    type: object
                    example:
                      breed: Nelore
                      weight_kg: 450
                      birth_date: "2023-01-15"
                  created_at:
                    type: string
                    format: date-time
                  updated_at:
                    type: string
                    format: date-time
        '404':
          description: Item not found or not in any public circuit
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/items/{dfid}/events/public:
    get:
      tags:
      - items
      summary: GET /items/:dfid/events/public - Public item events
      description: |
        **Public endpoint** - No authentication required.

        View events for an item that belong to public circuits.

        **What it returns:**
        - Event type (weight_measurement, location_change, etc.)
        - Timestamp
        - Event metadata/payload
        - Circuit context (only from public circuits)

        **Use cases:**
        - Display item history on public pages
        - Transparency for supply chain tracking
        - External audit trail

        **Example:**
        ```
        GET /api/items/DFID-BEEF-BR-2025-000123-a3f2c1/events/public?limit=10
        ```

        **Note:** Only returns events from public circuits. Private circuit events are filtered out.
      operationId: get_item_events_public
      parameters:
      - name: dfid
        in: path
        description: Item DFID
        required: true
        schema:
          type: string
          example: DFID-BEEF-BR-2025-000123-a3f2c1
      - name: event_type
        in: query
        description: Filter by event type
        required: false
        schema:
          type: string
          example: weight_measurement
      - name: limit
        in: query
        description: Limit number of results (default 50, max 100)
        required: false
        schema:
          type: integer
          default: 50
          maximum: 100
      - name: offset
        in: query
        description: Offset for pagination
        required: false
        schema:
          type: integer
          default: 0
      responses:
        '200':
          description: List of public events
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                      format: uuid
                    event_type:
                      type: string
                      example: weight_measurement
                    item_id:
                      type: string
                      format: uuid
                    circuit_id:
                      type: string
                      format: uuid
                    payload:
                      type: object
                      example:
                        weight_kg: 450
                        date: "2025-02-12"
                    created_at:
                      type: string
                      format: date-time
        '404':
          description: Item not found or not in any public circuit
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/events:
    get:
      tags:
      - events
      summary: GET /events?event_type=...&circuit_id=...
      description: 'List lifecycle events for items with optional filters.


        **What is an Event:**

        Events capture state changes and actions in the item lifecycle (created, updated,
        transferred, certified, etc.).

        They provide an immutable audit trail of all operations on items.


        **What it returns:**

        - Event type and timestamp

        - Associated item (DFID and UUID)

        - Circuit and user who triggered event

        - Event-specific metadata

        - Processing status (pending, completed, failed)


        **RBAC Requirements:**

        - User must have `read_events` permission in the circuit

        - Only returns events from circuits where user is a member

        - Filters automatically apply circuit boundaries


        **Common event types:**

        - `item_created`: Item registered in system

        - `item_updated`: Metadata changed

        - `item_transferred`: Ownership or custody changed

        - `item_certified`: Quality certification recorded

        - `item_merged`: Item merged with another

        - `item_split`: Item divided into multiple items

        - `snapshot_created`: Data snapshot created


        **Common filters:**

        - `event_type`: Filter by specific event type

        - `source_type`: Filter by source (item, circuit, user, system)

        - `circuit_id`: Events in specific circuit

        - `item_id`: Events for specific item

        - `user_id`: Events triggered by specific user

        - `status`: Processing status (pending, completed, failed)

        - `limit/offset`: Pagination (default: 50 per page)


        **Use cases:**

        - Audit trail and compliance reporting

        - Track item lifecycle from creation to disposal

        - Investigate data changes and anomalies


        **Example:**

        ```

        GET /api/events?event_type=item_transferred&circuit_id=abc-123&limit=20

        Authorization: Bearer <access_token>

        ```

        '
      operationId: list_events
      parameters:
      - name: event_type
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: source_type
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: circuit_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: item_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: user_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: status
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: limit
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      - name: offset
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: List of events
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListEventsResponse'
        '400':
          description: Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/events/{id}:
    get:
      tags:
      - events
      summary: GET /events/:id
      description: 'Retrieve detailed information about a specific lifecycle event.


        **What it returns:**

        - Event UUID and timestamp

        - Event type and source type

        - Associated item (DFID, UUID, name)

        - Circuit and user who triggered event

        - Full event payload/metadata

        - Processing status and error details (if failed)

        - Audit trail information


        **RBAC Requirements:**

        - User must have `read_events` permission in the circuit

        - User must be a member of the circuit where event occurred


        **Event metadata includes:**

        - Old and new values (for update events)

        - Actor information (who performed the action)

        - Context and reason (if provided)

        - Validation results

        - Related events (parent/child operations)


        **Use cases:**

        - Event detail page

        - Investigate failed processing

        - Audit trail analysis

        - Compliance verification


        **Example:**

        ```

        GET /api/events/550e8400-e29b-41d4-a716-446655440000

        Authorization: Bearer <access_token>

        ```

        '
      operationId: get_event
      parameters:
      - name: id
        in: path
        description: Event ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Event found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventResponse'
        '404':
          description: Event not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/events/{id}/status:
    put:
      tags:
      - events
      summary: PUT /events/:id/status
      description: "Update event processing status (typically for async workflows).\n\
        \n**What it does:**\n- Updates event processing status\n- Records processing\
        \ results or errors\n- Triggers downstream workflows\n- Updates audit trail\n\
        \n**Valid status transitions:**\n- `pending` \u2192 `processing`: Event being\
        \ processed\n- `pending` \u2192 `failed`: Failure before processing completes\n\
        - `processing` \u2192 `completed`: Successfully completed\n- `processing`\
        \ \u2192 `failed`: Processing error occurred\n\n**RBAC Requirements:**\n-\
        \ User must have `manage_events` permission (admin only)\n- Typically used\
        \ by system/worker processes\n- Not commonly used by end users\n\n**Request\
        \ body includes:**\n- `status`: New status value\n- `error_message`: Error\
        \ details (if failed)\n- `processed_at`: Timestamp (optional)\n\n**Use cases:**\n\
        - Async event processing workflows\n- Webhook delivery status updates\n- External\
        \ integration callbacks\n- Retry failed operations\n\n**Example:**\n```json\n\
        PUT /api/events/550e8400-e29b-41d4-a716-446655440000/status\n{\n  \"status\"\
        : \"completed\",\n  \"processed_at\": \"2025-02-08T15:30:00Z\"\n}\n```\n\n\
        **Error example:**\n```json\n{\n  \"status\": \"failed\",\n  \"error_message\"\
        : \"External API timeout after 30s\"\n}\n```\n"
      operationId: update_event_status
      parameters:
      - name: id
        in: path
        description: Event ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateEventStatusRequest'
        required: true
      responses:
        '204':
          description: Event status updated successfully
        '400':
          description: Invalid status value
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Event not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/items/bulk:
    post:
      tags:
      - items
      summary: Bulk ingest items from CSV file
      description: 'Create multiple items at once from CSV file upload.


        **What it does:**

        - Parses CSV file with item data

        - Generates DFID for each item automatically

        - Creates all items in a single transaction

        - Validates data and enforces schema

        - Returns detailed receipt with success/failure counts


        **CSV Format:**

        - Required multipart fields: `file` (CSV) and `circuit_id` (UUID)

        - Required CSV columns: value_chain, country

        - Optional columns: metadata.*, tags, status

        - Header row must match expected field names

        - UTF-8 encoding required


        **RBAC Requirements:**

        - User must have `create_items` permission in target circuit(s)

        - All items must belong to circuits where user is a member

        - Workspace must have sufficient DFID quota


        **Processing:**

        - Validates all rows before inserting any

        - Atomic transaction (all succeed or all fail)

        - Returns detailed error report for failed rows

        - Generates audit trail for bulk operation


        **Use cases:**

        - Migrate items from legacy system

        - Import harvest/production data

        - Bulk onboarding for large farms


        **Example CSV:**

        ```csv

        value_chain,country,circuit_id,metadata.breed,metadata.weight_kg

        BEEF,BR,abc-123,Nelore,450

        BEEF,BR,abc-123,Angus,520

        ```

        '
      operationId: bulk_ingest
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
              - file
              - circuit_id
              properties:
                file:
                  type: string
                  format: binary
                circuit_id:
                  type: string
                  format: uuid
      responses:
        '201':
          description: Ingestion completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestionReceipt'
        '400':
          description: Invalid CSV or missing fields
        '401':
          description: Missing or invalid authentication
        '403':
          description: Permission denied
        '500':
          description: Internal server error
  /api/items/{dfid}/merge:
    post:
      tags:
      - workflows
      summary: POST /items/{dfid}/merge
      description: "Merge two items together (deduplication or consolidation).\n\n\
        **What it does:**\n- Combines two items into one (primary remains, secondary\
        \ archived)\n- Merges metadata based on strategy (append, override, keep_primary)\n\
        - Preserves audit trail for both items\n- Updates relationships (parent/child\
        \ items)\n- Creates \"merged\" event in lifecycle\n\n**Merge strategies:**\n\
        - `append`: Concatenate arrays, keep all fields\n- `override`: Secondary values\
        \ override primary\n- `keep_primary`: Keep primary values, discard secondary\n\
        - `custom`: Provide field-by-field merge rules\n\n**RBAC Requirements:**\n\
        - User must have `update_items` permission in both circuits\n- Items must\
        \ be in same workspace (cross-workspace not allowed)\n- Cannot merge already-merged\
        \ items\n\n**What happens to secondary item:**\n- Status changed to 'merged'\n\
        - DFID preserved for audit trail\n- Relationship created: secondary \u2192\
        \ merged_into \u2192 primary\n- Data remains accessible (read-only)\n\n**Use\
        \ cases:**\n- Deduplicate accidentally created items\n- Consolidate batches\
        \ from same source\n- Combine split shipments\n\n**Example:**\n```json\nPOST\
        \ /api/items/DFID-BEEF-BR-2025-000123-abc/merge\n{\n  \"secondary_dfid\":\
        \ \"DFID-BEEF-BR-2025-000456-def\",\n  \"strategy\": \"append\",\n  \"user_id\"\
        : \"550e8400-e29b-41d4-a716-446655440000\"\n}\n```\n"
      operationId: merge_items
      parameters:
      - name: dfid
        in: path
        description: Primary item DFID (master)
        required: true
        schema:
          type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MergeItemsRequest'
        required: true
      responses:
        '200':
          description: Items merged successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MergeItemsResponse'
        '400':
          description: Invalid request or merge not possible
        '404':
          description: Item not found
        '500':
          description: Internal server error
  /api/items/{dfid}/relationships:
    get:
      tags:
      - workflows
      summary: GET /items/{dfid}/relationships
      description: "Get all relationships for an item (parent/child, merges, splits).\n\
        \n**What it returns:**\n- Parent items (source/origin)\n- Child items (derived\
        \ products)\n- Merged items (consolidated duplicates)\n- Split items (divided\
        \ portions)\n- Related items (linked for traceability)\n\n**Relationship types:**\n\
        - `parent_of`: This item is source for child items\n- `child_of`: This item\
        \ derived from parent\n- `merged_into`: This item was merged into another\n\
        - `split_from`: This item was split from source\n- `related_to`: Linked for\
        \ traceability (e.g., same batch)\n\n**RBAC Requirements:**\n- User must have\
        \ `read_items` permission\n- Only returns relationships where user has access\
        \ to both items\n- Relationships cross circuit boundaries (within workspace)\n\
        \n**Use cases:**\n- Build supply chain graph/tree\n- Trace item origins and\
        \ destinations\n- Audit data integrity and lineage\n\n**Example response:**\n\
        ```json\n[\n  {\n    \"relationship_type\": \"child_of\",\n    \"related_dfid\"\
        : \"DFID-BEEF-BR-2025-000123-abc\",\n    \"created_at\": \"2025-02-08T10:30:00Z\"\
        \n  },\n  {\n    \"relationship_type\": \"split_from\",\n    \"related_dfid\"\
        : \"DFID-BEEF-BR-2025-000456-def\",\n    \"created_at\": \"2025-02-10T14:22:00Z\"\
        \n  }\n]\n```\n"
      operationId: get_item_relationships
      parameters:
      - name: dfid
        in: path
        description: Item DFID
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Relationships retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ItemRelationshipRecord'
        '404':
          description: Item not found
        '500':
          description: Internal server error
  /api/items/{dfid}/split:
    post:
      tags:
      - workflows
      summary: POST /items/{dfid}/split
      description: "Split an item into two separate items (division/transfer).\n\n\
        **What it does:**\n- Creates new item with new DFID\n- Both items remain active\
        \ (original + new)\n- Establishes parent-child relationship\n- Updates metadata\
        \ based on split parameters\n- Creates \"split\" event in lifecycle\n\n**Required\
        \ fields:**\n- `value_chain`: Value chain for new item (typically same as\
        \ original)\n- `country`: Country code for new item\n- `year`: Year for DFID\
        \ generation\n- `metadata`: Metadata for new item\n\n**RBAC Requirements:**\n\
        - User must have `update_items` permission in source circuit\n- User must\
        \ have `create_items` permission in target circuit\n- Items can be split across\
        \ circuits (within same workspace)\n\n**Use cases:**\n- Divide batch for different\
        \ buyers\n- Transfer portion to another farm\n- Separate products from same\
        \ source\n\n**What happens:**\n- Original item status remains 'active'\n-\
        \ New item created with `split_from` relationship\n- Metadata copied to new\
        \ item (can be overridden)\n- Audit trail records split operation\n\n**Example:**\n\
        ```json\nPOST /api/items/DFID-BEEF-BR-2025-000123-abc/split\n{\n  \"value_chain\"\
        : \"BEEF\",\n  \"country\": \"BR\",\n  \"year\": 2025,\n  \"metadata\": {\n\
        \    \"note\": \"Split for transfer to Buyer X\",\n    \"weight_kg\": 225\n\
        \  },\n  \"user_id\": \"550e8400-e29b-41d4-a716-446655440000\"\n}\n\nResponse:\n\
        {\n  \"original_dfid\": \"DFID-BEEF-BR-2025-000123-abc\",\n  \"new_dfid\"\
        : \"DFID-BEEF-BR-2025-000789-xyz\"\n}\n```\n"
      operationId: split_item
      parameters:
      - name: dfid
        in: path
        description: Source item DFID to split
        required: true
        schema:
          type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SplitItemRequest'
        required: true
      responses:
        '201':
          description: Item split successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SplitItemResponse'
        '400':
          description: Invalid request
        '404':
          description: Item not found
        '500':
          description: Internal server error
  /api/items/{dfid}/unmerge:
    post:
      tags:
      - workflows
      summary: POST /items/{dfid}/unmerge
      description: "Unmerge a previously merged item (restore both original items).\n\
        \n**What it does:**\n- Restores secondary item to 'active' status\n- Removes\
        \ 'merged_into' relationship\n- Reverts metadata changes from merge\n- Creates\
        \ \"unmerged\" event in lifecycle\n- Preserves audit trail of original merge\n\
        \n**RBAC Requirements:**\n- User must have `update_items` permission in both\
        \ circuits\n- Only merged items can be unmerged (status = 'merged')\n- Cannot\
        \ unmerge if primary item was subsequently merged/archived\n\n**What gets\
        \ restored:**\n- Secondary item status: merged \u2192 active\n- Secondary\
        \ item metadata (pre-merge snapshot)\n- Independent access to both items\n\
        \n**When unmerge is blocked:**\n- Primary item was archived\n- Primary item\
        \ was merged into another\n- More than 90 days elapsed since merge (configurable)\n\
        \n**Use cases:**\n- Undo accidental merge\n- Restore items mistakenly deduplicated\n\
        - Correct data entry errors\n\n**Example:**\n```json\nPOST /api/items/DFID-BEEF-BR-2025-000456-def/unmerge\n\
        {\n  \"user_id\": \"550e8400-e29b-41d4-a716-446655440000\"\n}\n\nResponse:\n\
        {\n  \"primary_dfid\": \"DFID-BEEF-BR-2025-000123-abc\",\n  \"restored_dfid\"\
        : \"DFID-BEEF-BR-2025-000456-def\",\n  \"status\": \"unmerged\"\n}\n```\n"
      operationId: unmerge_item
      parameters:
      - name: dfid
        in: path
        description: Merged item DFID to restore
        required: true
        schema:
          type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UnmergeItemRequest'
        required: true
      responses:
        '200':
          description: Item unmerged successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnmergeItemResponse'
        '400':
          description: Item is not merged
        '404':
          description: Item not found
        '500':
          description: Internal server error
  /api/items/{id}:
    get:
      tags:
      - items
      summary: GET /items/:id
      description: 'Retrieve detailed information about a specific item by UUID.


        **What it returns:**

        - DFID (unique identifier)

        - Status (pending, active, inactive, archived, local, merged, split)

        - Metadata (item-specific data)

        - Identifiers (canonical + contextual)

        - Circuit ID and ownership

        - Lifecycle events (creation, updates, state changes)

        - Relationships (parent/child items)


        **RBAC Requirements:**

        - User must have `read_items` permission in the circuit

        - User must be a member of the item''s circuit


        **Note:**

        This endpoint uses UUID (internal database ID), not DFID.

        To query by DFID, use `GET /api/items?dfid=DFID-...` instead.


        **Use cases:**

        - Item detail page

        - Verify item existence before operations

        - Audit trail review


        **Example:**

        ```

        GET /api/items/550e8400-e29b-41d4-a716-446655440000

        Authorization: Bearer <access_token>

        ```

        '
      operationId: get_item
      parameters:
      - name: id
        in: path
        description: Item ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Item found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ItemDetailsResponse'
        '404':
          description: Item not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    put:
      tags:
      - items
      summary: PUT /items/:id
      description: "Update item metadata and properties.\n\n**What you can update:**\n\
        - Metadata fields (weight, location, notes, etc.)\n- Tags for categorization\n\
        - Status (active, archived, etc.)\n- Custom properties\n\n**Immutable fields:**\n\
        - `dfid`: Cannot be changed (permanent identifier)\n- `circuit_id`: Cannot\
        \ be moved between circuits\n- `created_at`: Immutable timestamp\n- Value\
        \ chain, country, year (embedded in DFID)\n\n**RBAC Requirements:**\n- User\
        \ must have `update_items` permission in the circuit\n- Only item owner or\
        \ circuit admin can update\n\n**Audit trail:**\n- All updates are logged with\
        \ old/new values\n- Tracks actor, timestamp, and change reason\n- Immutable\
        \ record for compliance\n\n**Use cases:**\n- Update item properties as data\
        \ becomes available\n- Correct data entry errors\n- Add notes and observations\n\
        \n**Example:**\n```json\nPUT /api/items/550e8400-e29b-41d4-a716-446655440000\n\
        {\n  \"metadata\": {\n    \"weight_kg\": 475,\n    \"location\": \"Warehouse\
        \ B\",\n    \"quality_grade\": \"A\"\n  },\n  \"tags\": [\"certified\", \"\
        organic\", \"2025-Q1\"]\n}\n```\n"
      operationId: update_item
      parameters:
      - name: id
        in: path
        description: Item ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateItemRequest'
        required: true
      responses:
        '200':
          description: Item updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ItemResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Item not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      tags:
      - items
      summary: DELETE /items/:id
      description: 'Soft delete an item (archive it, but preserve data).


        **What it does:**

        - Changes item status to ''archived''

        - Preserves all data for audit/compliance

        - Removes from active item lists

        - Maintains DFID and relationships

        - Creates audit log entry


        **RBAC Requirements:**

        - User must have `delete_items` permission in the circuit

        - Only item owner or circuit admin can delete

        - Cannot delete items with active dependencies


        **Data preservation:**

        - Item data remains in database

        - DFID remains valid and cannot be reused

        - Audit trail remains accessible

        - Relationships are preserved

        - Can be restored by system admin


        **Cascade behavior:**

        - Child items are NOT deleted (remain active)

        - Events remain accessible

        - Snapshots remain accessible

        - Merkle tree verification still works


        **When deletion is blocked:**

        - Item has active child items that depend on it

        - Item is referenced in active workflows

        - Circuit is archived


        **Use cases:**

        - Remove test/demo data

        - Decommission deprecated items

        - Compliance with data retention policies


        **Important:**

        This is a soft delete. For hard delete (permanent removal), contact support.


        **Example:**

        ```

        DELETE /api/items/550e8400-e29b-41d4-a716-446655440000?user_id=admin-uuid

        Authorization: Bearer <access_token>

        ```

        '
      operationId: delete_item
      parameters:
      - name: id
        in: path
        description: Item ID
        required: true
        schema:
          type: string
          format: uuid
      - name: user_id
        in: query
        description: User performing the deletion
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      responses:
        '204':
          description: Item archived successfully
        '404':
          description: Item not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/items/{id}/status:
    put:
      tags:
      - items
      summary: PUT /items/:id/status
      description: Update item status
      operationId: update_item_status
      parameters:
      - name: id
        in: path
        description: Item ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateItemStatusRequest'
        required: true
      responses:
        '200':
          description: Item status updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ItemResponse'
        '400':
          description: Invalid status value
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Item not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/merkle-trees:
    get:
      tags:
      - merkle
      summary: GET /merkle-trees
      description: List Merkle trees with optional filters
      operationId: list_merkle_trees
      parameters:
      - name: tree_type
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: resource_type
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: resource_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: circuit_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: snapshot_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: limit
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      - name: offset
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: List of Merkle trees
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListMerkleTreesResponse'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    post:
      tags:
      - merkle
      summary: POST /merkle-trees
      description: Create a new Merkle tree
      operationId: create_merkle_tree
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateMerkleTreeRequest'
        required: true
      responses:
        '201':
          description: Merkle tree created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MerkleTreeResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/merkle-trees/{id}:
    get:
      tags:
      - merkle
      summary: GET /merkle-trees/:id
      description: Get a Merkle tree by ID
      operationId: get_merkle_tree
      parameters:
      - name: id
        in: path
        description: Merkle tree ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Merkle tree found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MerkleTreeResponse'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Merkle tree not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      tags:
      - merkle
      summary: DELETE /merkle-trees/:id
      description: Delete a Merkle tree
      operationId: delete_merkle_tree
      parameters:
      - name: id
        in: path
        description: Merkle tree ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '204':
          description: Merkle tree deleted successfully
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Merkle tree not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/merkle-trees/{id}/generate-proof:
    post:
      tags:
      - merkle
      summary: POST /merkle-trees/:id/generate-proof
      description: Generate a Merkle proof for a leaf
      operationId: generate_proof
      parameters:
      - name: id
        in: path
        description: Merkle tree ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateProofRequest'
        required: true
      responses:
        '201':
          description: Proof generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProofResponse'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Tree or leaf not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/merkle-trees/{id}/verifications:
    get:
      tags:
      - merkle
      summary: GET /merkle-trees/:id/verifications
      description: Get verification history for a tree
      operationId: get_verifications
      parameters:
      - name: id
        in: path
        description: Merkle tree ID
        required: true
        schema:
          type: string
          format: uuid
      - name: limit
        in: query
        description: Maximum number of verifications to return
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: Verification history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerificationHistoryResponse'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Tree not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/merkle-trees/{id}/verify:
    post:
      tags:
      - merkle
      summary: POST /merkle-trees/:id/verify
      description: Verify the entire Merkle tree structure
      operationId: verify_tree
      parameters:
      - name: id
        in: path
        description: Merkle tree ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Tree verification result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerificationResponse'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Tree not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/merkle-trees/{id}/verify-proof:
    post:
      tags:
      - merkle
      summary: POST /merkle-trees/:id/verify-proof
      description: Verify a Merkle proof
      operationId: verify_proof
      parameters:
      - name: id
        in: path
        description: Merkle tree ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerifyProofRequest'
        required: true
      responses:
        '200':
          description: Proof verified
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerificationResponse'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Tree not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/sessions:
    get:
      tags:
      - activity
      summary: Get active sessions for a user
      operationId: get_active_sessions
      parameters:
      - name: user_id
        in: query
        description: User ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Active sessions retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserSession'
        '400':
          description: Missing user_id parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Permission denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/snapshots:
    get:
      tags:
      - snapshots
      summary: GET /snapshots - List snapshots with filtering
      description: 'List all snapshots from circuits in your workspace with optional
        filtering.


        **Filters**: resource_type, resource_id, circuit_id, snapshot_type, created_by,
        is_archived, limit, offset


        Results include snapshots from all circuits in your workspace that you have
        access to.


        **Example**: `GET /snapshots?snapshot_type=full&is_archived=false&limit=50`


        **Permissions Required**: Access to at least one circuit in your workspace'
      operationId: list_snapshots
      parameters:
      - name: resource_type
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: resource_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: circuit_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: snapshot_type
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: created_by
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: is_archived
        in: query
        required: false
        schema:
          type: boolean
          nullable: true
      - name: limit
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      - name: offset
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: List of snapshots
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListSnapshotsResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    post:
      tags:
      - snapshots
      summary: POST /snapshots - Create a point-in-time snapshot
      description: 'Create a point-in-time snapshot of circuit or item state.


        Snapshots are immutable records of state at a specific moment, useful for:

        - **Version Control**: Track changes over time

        - **Compliance**: Maintain audit trail for regulatory requirements

        - **Disaster Recovery**: Restore to previous known-good state

        - **Data Analysis**: Compare state changes between time periods


        Each snapshot includes:

        - Complete state data (JSON)

        - BLAKE3 checksum for integrity verification

        - Optional expiration date for automatic cleanup

        - Circuit association for access control


        **Permissions Required**: `ManageSnapshots` permission in the target circuit'
      operationId: create_snapshot
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSnapshotRequest'
        required: true
      responses:
        '201':
          description: Snapshot created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SnapshotResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/snapshots/comparisons/{id}:
    get:
      tags:
      - snapshots
      summary: GET /snapshots/comparisons/:id
      description: Get a snapshot comparison by ID
      operationId: get_comparison
      parameters:
      - name: id
        in: path
        description: Comparison ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Comparison found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ComparisonResponse'
        '404':
          description: Comparison not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/snapshots/restorations/{id}/status:
    put:
      tags:
      - snapshots
      summary: PUT /snapshots/restorations/:id/status
      description: Update restoration status
      operationId: update_restoration_status
      parameters:
      - name: id
        in: path
        description: Restoration ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateRestorationStatusRequest'
        required: true
      responses:
        '200':
          description: Restoration status updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestorationResponse'
        '404':
          description: Restoration not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/snapshots/retention-policies:
    get:
      tags:
      - snapshots
      summary: GET /snapshots/retention-policies
      description: Get retention policies for a circuit
      operationId: get_retention_policies
      parameters:
      - name: circuit_id
        in: query
        description: Circuit ID (optional, null for global policies)
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      responses:
        '200':
          description: List of retention policies
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/RetentionPolicyResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/snapshots/retention-policies/{id}/apply:
    post:
      tags:
      - snapshots
      summary: POST /snapshots/retention-policies/:id/apply
      description: Manually apply a retention policy
      operationId: apply_retention_policy
      parameters:
      - name: id
        in: path
        description: Retention policy ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Retention policy applied successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApplyRetentionResponse'
        '404':
          description: Retention policy not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/snapshots/{id}:
    get:
      tags:
      - snapshots
      summary: GET /snapshots/:id - Retrieve a specific snapshot
      description: 'Retrieve a specific snapshot by its unique identifier.


        Returns complete snapshot details including:

        - Snapshot metadata (name, type, timestamps)

        - Complete state data (JSON)

        - BLAKE3 checksum for integrity verification

        - Archival status

        - Expiration date (if set)


        **Use Cases**: Verify integrity, review history, download backup, check metadata


        **Permissions Required**: `ReadCircuits` permission in the snapshot''s circuit'
      operationId: get_snapshot
      parameters:
      - name: id
        in: path
        description: Snapshot ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Snapshot found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SnapshotResponse'
        '404':
          description: Snapshot not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      tags:
      - snapshots
      summary: DELETE /snapshots/:id
      description: Delete a snapshot
      operationId: delete_snapshot
      parameters:
      - name: id
        in: path
        description: Snapshot ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '204':
          description: Snapshot deleted successfully
        '404':
          description: Snapshot not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/snapshots/{id}/archive:
    post:
      tags:
      - snapshots
      summary: POST /snapshots/:id/archive
      description: Archive a snapshot
      operationId: archive_snapshot
      parameters:
      - name: id
        in: path
        description: Snapshot ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Snapshot archived successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SnapshotResponse'
        '404':
          description: Snapshot not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/snapshots/{id}/compare:
    post:
      tags:
      - snapshots
      summary: POST /snapshots/:id/compare - Compare two snapshots
      description: 'Compare two snapshots to analyze changes over time.


        Creates a detailed comparison showing added, removed, and modified data with
        summary statistics.


        **Use Cases**: Audit compliance, change detection, data analysis, quality
        control


        **Note**: Both snapshots must belong to the same circuit.


        **Permissions Required**: `ReadCircuits` permission in the circuit containing
        both snapshots'
      operationId: create_comparison
      parameters:
      - name: id
        in: path
        description: First snapshot ID (snapshot A)
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateComparisonRequest'
        required: true
      responses:
        '201':
          description: Comparison created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ComparisonResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/snapshots/{id}/restore:
    post:
      tags:
      - snapshots
      summary: POST /snapshots/:id/restore - Restore from snapshot (CRITICAL OPERATION)
      description: "Initiate a restoration operation to rollback to a previous snapshot\
        \ state.\n\n**\u26A0\uFE0F WARNING**: This operation will modify current circuit/item\
        \ state.\n\n**Process**: Auto-creates pre-restore snapshot \u2192 Validates\
        \ integrity \u2192 Applies changes \u2192 Tracks status\n\n**Restoration Types**:\
        \ full (complete replacement), partial (selective), merge (combine with current)\n\
        \n**Safety Features**: Pre-restore backup, rollback on failure, integrity\
        \ verification, async processing\n\n**Permissions Required**: `ManageSnapshots`\
        \ permission in the snapshot's circuit"
      operationId: create_restoration
      parameters:
      - name: id
        in: path
        description: Snapshot ID to restore from
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRestorationRequest'
        required: true
      responses:
        '201':
          description: Restoration created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestorationResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/webhooks:
    get:
      tags:
      - webhooks
      summary: List webhooks
      operationId: list_webhooks
      parameters:
      - name: circuit_id
        in: query
        description: Filter by circuit ID
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: is_active
        in: query
        description: Filter by active status
        required: false
        schema:
          type: boolean
          nullable: true
      responses:
        '200':
          description: Webhooks retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Webhook'
        '403':
          description: Permission denied
        '500':
          description: Internal server error
    post:
      tags:
      - webhooks
      summary: Create a new webhook
      operationId: create_webhook
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWebhookInput'
        required: true
      responses:
        '201':
          description: Webhook created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Webhook'
        '400':
          description: Invalid input
        '403':
          description: Permission denied
        '500':
          description: Internal server error
  /api/webhooks/{id}:
    get:
      tags:
      - webhooks
      summary: Get webhook by ID
      operationId: get_webhook
      parameters:
      - name: id
        in: path
        description: Webhook ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Webhook found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Webhook'
        '403':
          description: Permission denied
        '404':
          description: Webhook not found
        '500':
          description: Internal server error
    put:
      tags:
      - webhooks
      summary: Update webhook
      operationId: update_webhook
      parameters:
      - name: id
        in: path
        description: Webhook ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateWebhookInput'
        required: true
      responses:
        '200':
          description: Webhook updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Webhook'
        '400':
          description: Invalid input
        '403':
          description: Permission denied
        '404':
          description: Webhook not found
        '500':
          description: Internal server error
    delete:
      tags:
      - webhooks
      summary: Delete webhook
      operationId: delete_webhook
      parameters:
      - name: id
        in: path
        description: Webhook ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '204':
          description: Webhook deleted successfully
        '403':
          description: Permission denied
        '404':
          description: Webhook not found
        '500':
          description: Internal server error
  /api/webhooks/{id}/deliveries:
    get:
      tags:
      - webhooks
      summary: Get webhook delivery history
      operationId: get_webhook_deliveries
      parameters:
      - name: id
        in: path
        description: Webhook ID
        required: true
        schema:
          type: string
          format: uuid
      - name: limit
        in: query
        description: Maximum number of deliveries to return
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: Delivery history retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/WebhookDelivery'
        '403':
          description: Permission denied
        '404':
          description: Webhook not found
        '500':
          description: Internal server error
  /api/webhooks/{id}/retry:
    post:
      tags:
      - webhooks
      summary: Trigger manual delivery retry
      operationId: retry_webhook
      parameters:
      - name: id
        in: path
        description: Webhook ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '202':
          description: Retry scheduled
        '403':
          description: Permission denied
        '404':
          description: Webhook not found
        '500':
          description: Internal server error
  /api/webhooks/{id}/stats:
    get:
      tags:
      - webhooks
      summary: Get webhook statistics
      operationId: get_webhook_stats
      parameters:
      - name: id
        in: path
        description: Webhook ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Webhook statistics retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookStats'
        '403':
          description: Permission denied
        '404':
          description: Webhook not found
        '500':
          description: Internal server error
  /api/compliance/check:
    post:
      tags:
      - compliance
      summary: Submit a compliance check
      operationId: submitComplianceCheck
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
      responses:
        '200':
          description: Compliance check accepted
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        '400':
          description: Invalid request
        '401':
          description: Unauthorized
  /api/compliance/car/{carNumber}:
    get:
      tags:
      - compliance
      summary: Get CAR details by number (public)
      operationId: getComplianceCar
      security: []
      parameters:
      - name: carNumber
        in: path
        required: true
        schema:
          type: string
        description: CAR number (Cadastro Ambiental Rural)
      responses:
        '200':
          description: CAR details
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        '400':
          description: Invalid CAR number
        '404':
          description: Not found
  /api/compliance/car/{carNumber}/geojson:
    get:
      tags:
      - compliance
      summary: Get CAR geometry as GeoJSON (public)
      operationId: getComplianceCarGeojson
      security: []
      parameters:
      - name: carNumber
        in: path
        required: true
        schema:
          type: string
        description: CAR number (Cadastro Ambiental Rural)
      responses:
        '200':
          description: CAR geometry as GeoJSON
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        '400':
          description: Invalid CAR number
        '404':
          description: Not found
  /api/compliance/checks/{id}:
    get:
      tags:
      - compliance
      summary: Get compliance check status by ID
      operationId: getComplianceCheck
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Compliance check status
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        '401':
          description: Unauthorized
        '404':
          description: Not found
  /api/compliance/sources:
    get:
      tags:
      - compliance
      summary: List compliance data sources
      operationId: listComplianceSources
      responses:
        '200':
          description: Sources list
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        '401':
          description: Unauthorized
  /api/circuits/{circuit_id}/adapters:
    get:
      tags:
      - Circuit Adapters
      summary: List circuit adapters
      description: |
        Get all adapters (Stellar, IPFS, NFT) configured for a specific circuit.

        **What it does:**
        - Returns all adapter configurations for the circuit
        - Includes auto-publish settings and rate limits
        - Shows whether each adapter is enabled/disabled

        **Response includes:**
        - Adapter name and type (stellar, ipfs, nft)
        - Auto-publish status (on/off)
        - Trigger events (item_created, item_updated)
        - Rate limits (per hour and per day)

        **Use cases:**
        - Check which adapters are active for a circuit
        - Verify auto-publish settings
        - Monitor adapter configurations
      operationId: list_circuit_adapters
      parameters:
      - name: circuit_id
        in: path
        description: Circuit UUID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: List of adapters
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CircuitAdapter'
        '401':
          description: Unauthorized
        '404':
          description: Circuit not found
        '500':
          description: Internal server error
      security:
      - bearerAuth: []

    post:
      tags:
      - Circuit Adapters
      summary: Add adapter to circuit
      description: |
        Add a specific adapter (Stellar, IPFS, NFT) to a circuit with custom configuration.

        **What it does:**
        - Adds an adapter to the circuit
        - Configures auto-publish settings
        - Sets custom rate limits (optional)
        - If adapter already exists, updates it instead

        **Parameters:**
        - `adapter_config_id`: ID of the adapter to add (get from /adapter-configs)
        - `auto_publish`: Enable automatic publishing on item events (default: false)
        - `trigger_events`: Events that trigger auto-publish (default: item_created, item_updated)
        - `rate_limit_per_hour`: Custom hourly rate limit (optional)
        - `rate_limit_per_day`: Custom daily rate limit (optional)

        **Use cases:**
        - Manually add a specific adapter to a circuit
        - Configure custom rate limits for a circuit
        - Enable auto-publish for specific events only
      operationId: add_circuit_adapter
      parameters:
      - name: circuit_id
        in: path
        description: Circuit UUID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddCircuitAdapterRequest'
      responses:
        '201':
          description: Adapter added successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CircuitAdapter'
        '400':
          description: Invalid request
        '401':
          description: Unauthorized
        '404':
          description: Adapter config not found
        '500':
          description: Internal server error
      security:
      - bearerAuth: []

  /api/circuits/{circuit_id}/adapters/setup-defaults:
    post:
      tags:
      - Circuit Adapters
      summary: Setup default adapters
      description: |
        Automatically configure Stellar and IPFS adapters with auto-publish enabled.
        This is the recommended way to enable publishing for new circuits.

        **What it does:**
        - Adds Stellar mainnet adapter with auto-publish ON
        - Adds IPFS (Pinata) adapter with auto-publish ON
        - Uses default rate limits from adapter configs
        - Idempotent - safe to call multiple times

        **Adapters configured:**
        - **stellar_mainnet**: Blockchain anchoring (100 req/hour, 1000 req/day)
        - **ipfs_pinata**: Distributed storage (500 req/hour, 5000 req/day)

        **Auto-publish behavior:**
        - Items created in this circuit will automatically be published to Stellar + IPFS
        - Items updated in this circuit will also be republished

        **Use cases:**
        - Quick setup for new circuits
        - Enable decentralized publishing in one API call
        - Recommended for production circuits
      operationId: setup_default_adapters
      parameters:
      - name: circuit_id
        in: path
        description: Circuit UUID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Default adapters configured
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CircuitAdapter'
        '401':
          description: Unauthorized
        '404':
          description: Circuit not found
        '500':
          description: Internal server error
      security:
      - bearerAuth: []

  /api/circuits/{circuit_id}/adapters/{adapter_id}:
    patch:
      tags:
      - Circuit Adapters
      summary: Update adapter configuration
      description: |
        Update settings for a specific adapter. Use this to enable/disable auto-publish,
        enable/disable the adapter entirely, or adjust rate limits.

        **What it does:**
        - Updates adapter settings (all fields optional)
        - Changes take effect immediately
        - Does not affect already-queued jobs

        **Common use cases:**

        **Turn off auto-publish (manual publishing only):**
        ```json
        { "auto_publish": false }
        ```

        **Turn on auto-publish:**
        ```json
        { "auto_publish": true }
        ```

        **Disable adapter completely:**
        ```json
        { "is_enabled": false }
        ```

        **Re-enable adapter:**
        ```json
        { "is_enabled": true, "auto_publish": true }
        ```

        **Adjust rate limits:**
        ```json
        {
          "rate_limit_per_hour": 50,
          "rate_limit_per_day": 500
        }
        ```

        **Difference between is_enabled and auto_publish:**
        - `is_enabled=false`: Adapter completely disabled (auto + manual blocked)
        - `auto_publish=false`: Only disables auto-publish (manual `/publish` still works)
      operationId: update_circuit_adapter
      parameters:
      - name: circuit_id
        in: path
        description: Circuit UUID
        required: true
        schema:
          type: string
          format: uuid
      - name: adapter_id
        in: path
        description: Adapter UUID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCircuitAdapterRequest'
      responses:
        '200':
          description: Adapter updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CircuitAdapter'
        '400':
          description: Invalid request (no fields to update)
        '401':
          description: Unauthorized
        '404':
          description: Adapter not found
        '500':
          description: Internal server error
      security:
      - bearerAuth: []

    delete:
      tags:
      - Circuit Adapters
      summary: Remove adapter from circuit
      description: |
        Removes an adapter from a circuit. Items will no longer be published to this adapter.

        **What it does:**
        - Deletes adapter configuration from circuit
        - Stops all future auto-publishing to this adapter
        - Does not affect already-published data
        - Does not affect other circuits using the same adapter

        **Important:**
        - This operation is irreversible
        - Already-published data on Stellar/IPFS remains unchanged
        - To temporarily disable, use PATCH with `is_enabled: false` instead

        **Use cases:**
        - Circuit no longer needs this adapter
        - Switching to different adapter configuration
        - Testing/development cleanup
      operationId: delete_circuit_adapter
      parameters:
      - name: circuit_id
        in: path
        description: Circuit UUID
        required: true
        schema:
          type: string
          format: uuid
      - name: adapter_id
        in: path
        description: Adapter UUID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '204':
          description: Adapter deleted successfully
        '401':
          description: Unauthorized
        '404':
          description: Adapter not found
        '500':
          description: Internal server error
      security:
      - bearerAuth: []
