openapi: 3.0.3
info:
  title: DeFarm Item Registry API
  description: "\n# DeFarm Item Registry API\n\n**Layer 2 Registry Service** - Core\
    \ registry for items, circuits, events, and collaboration in the DeFarm ecosystem.\n\
    \n## Overview\n\nThe Item Registry is a production-ready service providing comprehensive\
    \ tracking, verification, and collaboration\nfeatures for agricultural supply\
    \ chains. It integrates with the DFID service (Layer 1) for unique identifier\
    \ generation.\n\n## Core Features\n\n### \U0001F3AF Item Management (10 endpoints)\n\
    - **CRUD Operations**: Create, read, update, delete items with DFIDs\n- **Bulk\
    \ Import**: CSV ingestion with automatic DFID generation and identifier resolution\n\
    - **Workflows**: Merge/split items, track relationships and provenance\n- **Status\
    \ Tracking**: Update item status, archive items\n\n### \U0001F504 Circuit Collaboration\
    \ (10 endpoints)\n- **Circuit Management**: Create collaborative data-sharing\
    \ circuits\n- **Member Management**: Add/remove members, manage roles and permissions\n\
    - **Access Control**: Public/private circuits, organization-based access\n\n###\
    \ \U0001F4CA Event Tracking (3 endpoints)\n- **Event Recording**: Track lifecycle\
    \ events (birth, weight, transfers, etc.)\n- **Status Updates**: Modify event\
    \ status (pending, verified, disputed)\n- **Event Queries**: Filter and retrieve\
    \ event history\n\n### \U0001F50D Audit & Verification (3 endpoints)\n- **Immutable\
    \ Audit Trail**: Hash-chained audit logs for tamper detection\n- **Hash Chain\
    \ Verification**: Verify integrity of audit logs\n- **Complete History**: Track\
    \ all system changes with user attribution\n\n### \U0001F514 Webhooks & Notifications\
    \ (8 endpoints)\n- **Webhook Management**: Create, update, delete webhooks for\
    \ real-time notifications\n- **Event Subscriptions**: Subscribe to item, circuit,\
    \ and event changes\n- **Delivery Tracking**: Monitor webhook delivery status,\
    \ retries, and failures\n- **Statistics**: View webhook performance metrics\n\n\
    ### \U0001F4C8 Activity Tracking (6 endpoints)\n- **Activity Feeds**: User, circuit,\
    \ and public activity streams\n- **Session Management**: Track active user sessions\n\
    - **Recent Activity**: Quick access to latest actions\n- **Activity Summaries**:\
    \ Aggregated statistics by day/week/month\n\n### \U0001F4BE State Management (11\
    \ endpoints)\n- **Snapshots**: Create point-in-time snapshots of circuit/item\
    \ state\n- **Comparisons**: Compare snapshots to track changes over time\n- **Restoration**:\
    \ Rollback to previous states\n- **Retention Policies**: Automatic cleanup of\
    \ old snapshots\n\n### \U0001F333 Merkle Tree Verification (8 endpoints)\n- **Tree\
    \ Building**: Create Merkle trees from batches of data\n- **Proof Generation**:\
    \ Generate cryptographic inclusion proofs\n- **Proof Verification**: Verify data\
    \ integrity efficiently\n- **Verification Logs**: Track all verification operations\n\
    \n### \U0001F511 Admin & Monitoring (3 endpoints)\n- **API Key Management**: Create\
    \ and manage circuit-scoped API keys\n- **Health Checks**: Service health and\
    \ database connectivity\n- **Metrics**: Prometheus-compatible metrics for monitoring\n\
    \n## Architecture\n\n**Technology Stack:**\n- **Language**: Rust 1.75+\n- **Framework**:\
    \ Axum 0.7 (async)\n- **Database**: PostgreSQL 15+ (39 tables)\n- **Cache**: Redis\
    \ 7+ (sequences, caching)\n- **Hashing**: BLAKE3 (checksums, Merkle trees)\n\n\
    **Integration:**\n- **DFID Service**: Calls Layer 1 for unique identifier generation\n\
    - **External Systems**: Webhooks for event notifications\n- **Blockchain Ready**:\
    \ Merkle trees and audit trails for immutability\n\n## Authentication\n\n**Current**:\
    \ API key authentication for bulk ingestion endpoints\n**Planned**: JWT tokens,\
    \ OAuth2, role-based access control (RBAC)\n\n## Base URLs\n- **Development**:\
    \ http://localhost:8080\n- **Production**: https://item-registry.railway.app\n\
    \n## Response Codes\n\n- `200 OK` - Successful request\n- `201 Created` - Resource\
    \ created successfully\n- `204 No Content` - Successful deletion\n- `400 Bad Request`\
    \ - Invalid input or validation error\n- `404 Not Found` - Resource not found\n\
    - `409 Conflict` - Duplicate resource or conflict\n- `500 Internal Server Error`\
    \ - Server error\n- `501 Not Implemented` - Feature not yet available\n\n## Rate\
    \ Limiting\n\nNot currently enforced. Future versions will implement per-API-key\
    \ rate limits.\n\n## Pagination\n\nList endpoints support pagination via `limit`\
    \ and `offset` query parameters:\n- `limit`: Maximum number of results (default:\
    \ 50, max: 1000)\n- `offset`: Number of results to skip (default: 0)\n\n## Error\
    \ Response Format\n\nAll errors return a consistent JSON structure:\n```json\n\
    {\n  \"error\": \"error_type\",\n  \"message\": \"Human-readable message\",\n\
    \  \"details\": \"Optional detailed information\"\n}\n```\n\n## Total Endpoints:\
    \ 64\n\nGrouped by category for easy navigation. See tags below for detailed documentation.\n"
  contact:
    name: DeFarm Team
    email: api@defarm.com
  license:
    name: Proprietary
  version: 0.1.0
servers:
- url: http://localhost:8080
  description: Local development
- url: https://item-registry.railway.app
  description: Production
paths:
  /activity/circuit/{circuit_id}:
    get:
      tags:
      - activity
      summary: Get circuit activity feed
      operationId: get_circuit_activity_feed
      parameters:
      - name: circuit_id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      - name: actor_id
        in: query
        description: Filter by actor
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: resource_type
        in: query
        description: Filter by resource type
        required: false
        schema:
          type: string
          nullable: true
      - name: action
        in: query
        description: Filter by action
        required: false
        schema:
          type: string
          nullable: true
      - name: limit
        in: query
        description: Maximum results
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      - name: offset
        in: query
        description: Results offset
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: Circuit activity feed retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ActivityFeed'
        '500':
          description: Internal server error
  /activity/public:
    get:
      tags:
      - activity
      summary: Get public activity feed
      operationId: get_public_activity_feed
      parameters:
      - name: circuit_id
        in: query
        description: Filter by circuit
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: resource_type
        in: query
        description: Filter by resource type
        required: false
        schema:
          type: string
          nullable: true
      - name: action
        in: query
        description: Filter by action
        required: false
        schema:
          type: string
          nullable: true
      - name: limit
        in: query
        description: Maximum results
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      - name: offset
        in: query
        description: Results offset
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: Public activity feed retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ActivityFeed'
        '500':
          description: Internal server error
  /activity/recent:
    get:
      tags:
      - activity
      summary: Get recent activity cache
      operationId: get_recent_activity
      parameters:
      - name: user_id
        in: query
        description: User ID
        required: true
        schema:
          type: string
          format: uuid
      - name: limit
        in: query
        description: 'Maximum results (default: 10)'
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: Recent activity retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/RecentActivity'
        '400':
          description: Missing user_id parameter
        '500':
          description: Internal server error
  /activity/summaries:
    get:
      tags:
      - activity
      summary: Get activity summaries
      operationId: get_activity_summaries
      parameters:
      - name: circuit_id
        in: query
        description: Filter by circuit
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: user_id
        in: query
        description: Filter by user
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: start_date
        in: query
        description: Start date (YYYY-MM-DD)
        required: true
        schema:
          type: string
      - name: end_date
        in: query
        description: End date (YYYY-MM-DD)
        required: true
        schema:
          type: string
      - name: summary_type
        in: query
        description: Summary type (daily, weekly, monthly)
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Activity summaries retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ActivitySummary'
        '400':
          description: Invalid parameters
        '500':
          description: Internal server error
  /activity/user/{user_id}:
    get:
      tags:
      - activity
      summary: Get user activity feed
      operationId: get_user_activity_feed
      parameters:
      - name: user_id
        in: path
        description: User ID
        required: true
        schema:
          type: string
          format: uuid
      - name: circuit_id
        in: query
        description: Filter by circuit
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: resource_type
        in: query
        description: Filter by resource type
        required: false
        schema:
          type: string
          nullable: true
      - name: action
        in: query
        description: Filter by action
        required: false
        schema:
          type: string
          nullable: true
      - name: limit
        in: query
        description: Maximum results
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      - name: offset
        in: query
        description: Results offset
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: Activity feed retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ActivityFeed'
        '500':
          description: Internal server error
  /admin/api-keys:
    post:
      tags:
      - admin
      summary: POST /admin/api-keys
      description: 'Create a new API key for circuit access


        **⚠️ SECURITY**: The API key is only returned once and cannot be retrieved
        later!'
      operationId: create_api_key
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateApiKeyRequest'
        required: true
      responses:
        '201':
          description: API key created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateApiKeyResponse'
        '500':
          description: Internal server error
  /admin/api-keys/{circuit_id}:
    get:
      tags:
      - admin
      summary: GET /admin/api-keys/:circuit_id
      description: 'List API keys for a circuit


        Returns metadata about API keys without revealing the actual key values.'
      operationId: list_api_keys
      parameters:
      - name: circuit_id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: List of API keys returned
        '500':
          description: Internal server error
  /audit:
    get:
      tags:
      - audit
      summary: GET /audit?user_id=...&action=...
      description: List audit logs with optional filters
      operationId: list_audit_logs
      parameters:
      - name: user_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: action
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: resource_type
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: resource_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: circuit_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: limit
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      - name: offset
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: List of audit logs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListAuditLogsResponse'
        '400':
          description: Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /audit/verify:
    get:
      tags:
      - audit
      summary: GET /audit/verify?limit=...
      description: Verify hash chain integrity
      operationId: verify_hash_chain
      parameters:
      - name: limit
        in: query
        description: Maximum number of logs to verify
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: Hash chain verification result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HashChainVerificationResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /audit/{id}:
    get:
      tags:
      - audit
      summary: GET /audit/:id
      description: Get a single audit log by ID
      operationId: get_audit_log
      parameters:
      - name: id
        in: path
        description: Audit log ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Audit log found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditLogResponse'
        '404':
          description: Audit log not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /circuits:
    get:
      tags:
      - circuits
      summary: GET /circuits?name=...&owner_id=...
      description: List circuits with optional filters
      operationId: list_circuits
      parameters:
      - name: owner_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: organization_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: circuit_type
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: status
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: limit
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      - name: offset
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: List of circuits
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListCircuitsResponse'
        '400':
          description: Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
    post:
      tags:
      - circuits
      summary: POST /circuits
      description: Create a new circuit
      operationId: create_circuit
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCircuitRequest'
        required: true
      responses:
        '201':
          description: Circuit created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CircuitResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /circuits/{id}:
    get:
      tags:
      - circuits
      summary: GET /circuits/:id
      description: Get a single circuit by ID
      operationId: get_circuit
      parameters:
      - name: id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Circuit found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CircuitResponse'
        '404':
          description: Circuit not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
    put:
      tags:
      - circuits
      summary: PUT /circuits/:id
      description: Update circuit details
      operationId: update_circuit
      parameters:
      - name: id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCircuitRequest'
        required: true
      responses:
        '200':
          description: Circuit updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CircuitResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '404':
          description: Circuit not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
    delete:
      tags:
      - circuits
      summary: DELETE /circuits/:id
      description: Soft delete a circuit
      operationId: delete_circuit
      parameters:
      - name: id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '204':
          description: Circuit deleted successfully
        '404':
          description: Circuit not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /circuits/{id}/members:
    get:
      tags:
      - circuits
      summary: GET /circuits/:id/members
      description: List all members of a circuit
      operationId: list_members
      parameters:
      - name: id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: List of circuit members
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListMembersResponse'
        '404':
          description: Circuit not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
    post:
      tags:
      - circuits
      summary: POST /circuits/:id/members
      description: Add a member to a circuit
      operationId: add_member
      parameters:
      - name: id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddMemberRequest'
        required: true
      responses:
        '201':
          description: Member added successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CircuitMemberResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '404':
          description: Circuit not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '409':
          description: Member already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /circuits/{id}/members/{user_id}:
    get:
      tags:
      - circuits
      summary: GET /circuits/:id/members/:user_id
      description: Get a specific circuit member
      operationId: get_member
      parameters:
      - name: id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      - name: user_id
        in: path
        description: User ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Member found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CircuitMemberResponse'
        '404':
          description: Member not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
    put:
      tags:
      - circuits
      summary: PUT /circuits/:id/members/:user_id
      description: Update a circuit member
      operationId: update_member
      parameters:
      - name: id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      - name: user_id
        in: path
        description: User ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateMemberRequest'
        required: true
      responses:
        '200':
          description: Member updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CircuitMemberResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '404':
          description: Member not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
    delete:
      tags:
      - circuits
      summary: DELETE /circuits/:id/members/:user_id
      description: Remove a member from a circuit
      operationId: remove_member
      parameters:
      - name: id
        in: path
        description: Circuit ID
        required: true
        schema:
          type: string
          format: uuid
      - name: user_id
        in: path
        description: User ID
        required: true
        schema:
          type: string
          format: uuid
      - name: removed_by
        in: query
        description: User performing the removal
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      responses:
        '204':
          description: Member removed successfully
        '404':
          description: Member not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /events:
    get:
      tags:
      - events
      summary: GET /events?event_type=...&circuit_id=...
      description: List events with optional filters
      operationId: list_events
      parameters:
      - name: event_type
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: source_type
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: circuit_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: item_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: user_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: status
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: limit
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      - name: offset
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: List of events
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListEventsResponse'
        '400':
          description: Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /events/{id}:
    get:
      tags:
      - events
      summary: GET /events/:id
      description: Get a single event by ID
      operationId: get_event
      parameters:
      - name: id
        in: path
        description: Event ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Event found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventResponse'
        '404':
          description: Event not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /events/{id}/status:
    put:
      tags:
      - events
      summary: PUT /events/:id/status
      description: Update event status (for processing workflow)
      operationId: update_event_status
      parameters:
      - name: id
        in: path
        description: Event ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateEventStatusRequest'
        required: true
      responses:
        '204':
          description: Event status updated successfully
        '400':
          description: Invalid status value
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '404':
          description: Event not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /health:
    get:
      tags:
      - health
      summary: Health check endpoint
      description: Returns the health status of the service including database and
        Redis connectivity
      operationId: health_check
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '503':
          description: Service is degraded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
  /items:
    get:
      tags:
      - items
      summary: GET /items?dfid=...&value_chain=...
      description: List items with optional filters
      operationId: list_items
      parameters:
      - name: value_chain
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: country
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: year
        in: query
        required: false
        schema:
          type: integer
          format: int32
          nullable: true
      - name: status
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: circuit_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: owner_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: limit
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      - name: offset
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: List of items
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListItemsResponse'
        '400':
          description: Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
    post:
      tags:
      - items
      summary: POST /items
      description: Create a new item with DFID generation
      operationId: create_item
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateItemRequest'
        required: true
      responses:
        '201':
          description: Item created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ItemResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /items/bulk:
    post:
      tags:
      - items
      summary: POST /items/bulk
      description: 'Bulk ingest items from CSV or JSON file


        Accepts CSV or JSON format. Format is auto-detected from content.


        CSV format: Standard CSV with headers

        JSON format: Array of objects or {"data": [objects]}'
      operationId: bulk_ingest
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: string
        required: true
      responses:
        '201':
          description: Bulk ingestion completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestionReceipt'
        '400':
          description: Invalid file format or missing parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /items/{dfid}/merge:
    post:
      tags:
      - workflows
      summary: POST /items/{dfid}/merge
      description: 'Merge two items together


        # Example Request

        ```json

        {

        "secondary_dfid": "DFID-BEEF-BR-2025-000456-abc123",

        "strategy": "append",

        "user_id": "550e8400-e29b-41d4-a716-446655440000"

        }

        ```'
      operationId: merge_items
      parameters:
      - name: dfid
        in: path
        description: Primary item DFID (master)
        required: true
        schema:
          type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MergeItemsRequest'
        required: true
      responses:
        '200':
          description: Items merged successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MergeItemsResponse'
        '400':
          description: Invalid request or merge not possible
        '404':
          description: Item not found
        '500':
          description: Internal server error
  /items/{dfid}/relationships:
    get:
      tags:
      - workflows
      summary: GET /items/{dfid}/relationships
      description: 'Get all relationships for an item


        Returns items that are linked as duplicates, derived, or related'
      operationId: get_item_relationships
      parameters:
      - name: dfid
        in: path
        description: Item DFID
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Relationships retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/crate.engines.workflows.deduplication.ItemRelationshipRecord'
        '404':
          description: Item not found
        '500':
          description: Internal server error
  /items/{dfid}/split:
    post:
      tags:
      - workflows
      summary: POST /items/{dfid}/split
      description: 'Split an item into two items


        # Example Request

        ```json

        {

        "value_chain": "BEEF",

        "country": "BR",

        "year": 2025,

        "metadata": {"note": "Split for transfer"},

        "user_id": "550e8400-e29b-41d4-a716-446655440000"

        }

        ```'
      operationId: split_item
      parameters:
      - name: dfid
        in: path
        description: Source item DFID to split
        required: true
        schema:
          type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SplitItemRequest'
        required: true
      responses:
        '201':
          description: Item split successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SplitItemResponse'
        '400':
          description: Invalid request
        '404':
          description: Item not found
        '500':
          description: Internal server error
  /items/{dfid}/unmerge:
    post:
      tags:
      - workflows
      summary: POST /items/{dfid}/unmerge
      description: 'Unmerge a previously merged item


        # Example Request

        ```json

        {

        "user_id": "550e8400-e29b-41d4-a716-446655440000"

        }

        ```'
      operationId: unmerge_item
      parameters:
      - name: dfid
        in: path
        description: Merged item DFID to restore
        required: true
        schema:
          type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UnmergeItemRequest'
        required: true
      responses:
        '200':
          description: Item unmerged successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnmergeItemResponse'
        '400':
          description: Item is not merged
        '404':
          description: Item not found
        '500':
          description: Internal server error
  /items/{id}:
    get:
      tags:
      - items
      summary: GET /items/:id
      description: Get a single item by ID
      operationId: get_item
      parameters:
      - name: id
        in: path
        description: Item ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Item found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ItemResponse'
        '404':
          description: Item not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
    put:
      tags:
      - items
      summary: PUT /items/:id
      description: Update item metadata
      operationId: update_item
      parameters:
      - name: id
        in: path
        description: Item ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateItemRequest'
        required: true
      responses:
        '200':
          description: Item updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ItemResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '404':
          description: Item not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
    delete:
      tags:
      - items
      summary: DELETE /items/:id
      description: Soft delete an item
      operationId: delete_item
      parameters:
      - name: id
        in: path
        description: Item ID
        required: true
        schema:
          type: string
          format: uuid
      - name: user_id
        in: query
        description: User performing the deletion
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      responses:
        '204':
          description: Item deleted successfully
        '404':
          description: Item not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /items/{id}/status:
    put:
      tags:
      - items
      summary: PUT /items/:id/status
      description: Update item status
      operationId: update_item_status
      parameters:
      - name: id
        in: path
        description: Item ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateItemStatusRequest'
        required: true
      responses:
        '200':
          description: Item status updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ItemResponse'
        '400':
          description: Invalid status value
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '404':
          description: Item not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /merkle-trees:
    get:
      tags:
      - merkle
      summary: GET /merkle-trees
      description: List Merkle trees with optional filters
      operationId: list_merkle_trees
      parameters:
      - name: tree_type
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: resource_type
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: resource_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: circuit_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: snapshot_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: limit
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      - name: offset
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: List of Merkle trees
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListMerkleTreesResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
    post:
      tags:
      - merkle
      summary: POST /merkle-trees
      description: Create a new Merkle tree
      operationId: create_merkle_tree
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateMerkleTreeRequest'
        required: true
      responses:
        '201':
          description: Merkle tree created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MerkleTreeResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /merkle-trees/{id}:
    get:
      tags:
      - merkle
      summary: GET /merkle-trees/:id
      description: Get a Merkle tree by ID
      operationId: get_merkle_tree
      parameters:
      - name: id
        in: path
        description: Merkle tree ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Merkle tree found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MerkleTreeResponse'
        '404':
          description: Merkle tree not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
    delete:
      tags:
      - merkle
      summary: DELETE /merkle-trees/:id
      description: Delete a Merkle tree
      operationId: delete_merkle_tree
      parameters:
      - name: id
        in: path
        description: Merkle tree ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '204':
          description: Merkle tree deleted successfully
        '404':
          description: Merkle tree not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /merkle-trees/{id}/generate-proof:
    post:
      tags:
      - merkle
      summary: POST /merkle-trees/:id/generate-proof
      description: Generate a Merkle proof for a leaf
      operationId: generate_proof
      parameters:
      - name: id
        in: path
        description: Merkle tree ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateProofRequest'
        required: true
      responses:
        '201':
          description: Proof generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProofResponse'
        '404':
          description: Tree or leaf not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /merkle-trees/{id}/verifications:
    get:
      tags:
      - merkle
      summary: GET /merkle-trees/:id/verifications
      description: Get verification history for a tree
      operationId: get_verifications
      parameters:
      - name: id
        in: path
        description: Merkle tree ID
        required: true
        schema:
          type: string
          format: uuid
      - name: limit
        in: query
        description: Maximum number of verifications to return
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: Verification history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerificationHistoryResponse'
        '404':
          description: Tree not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /merkle-trees/{id}/verify:
    post:
      tags:
      - merkle
      summary: POST /merkle-trees/:id/verify
      description: Verify the entire Merkle tree structure
      operationId: verify_tree
      parameters:
      - name: id
        in: path
        description: Merkle tree ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Tree verification result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerificationResponse'
        '404':
          description: Tree not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /merkle-trees/{id}/verify-proof:
    post:
      tags:
      - merkle
      summary: POST /merkle-trees/:id/verify-proof
      description: Verify a Merkle proof
      operationId: verify_proof
      parameters:
      - name: id
        in: path
        description: Merkle tree ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerifyProofRequest'
        required: true
      responses:
        '200':
          description: Proof verified
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerificationResponse'
        '404':
          description: Tree not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /sessions:
    get:
      tags:
      - activity
      summary: Get active sessions for a user
      operationId: get_active_sessions
      parameters:
      - name: user_id
        in: query
        description: User ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Active sessions retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserSession'
        '400':
          description: Missing user_id parameter
        '500':
          description: Internal server error
  /snapshots:
    get:
      tags:
      - snapshots
      summary: GET /snapshots
      description: List snapshots with optional filters
      operationId: list_snapshots
      parameters:
      - name: resource_type
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: resource_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: circuit_id
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: snapshot_type
        in: query
        required: false
        schema:
          type: string
          nullable: true
      - name: created_by
        in: query
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: is_archived
        in: query
        required: false
        schema:
          type: boolean
          nullable: true
      - name: limit
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      - name: offset
        in: query
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: List of snapshots
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListSnapshotsResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
    post:
      tags:
      - snapshots
      summary: POST /snapshots
      description: Create a new snapshot
      operationId: create_snapshot
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSnapshotRequest'
        required: true
      responses:
        '201':
          description: Snapshot created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SnapshotResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /snapshots/comparisons/{id}:
    get:
      tags:
      - snapshots
      summary: GET /snapshots/comparisons/:id
      description: Get a snapshot comparison by ID
      operationId: get_comparison
      parameters:
      - name: id
        in: path
        description: Comparison ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Comparison found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ComparisonResponse'
        '404':
          description: Comparison not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /snapshots/restorations/{id}/status:
    put:
      tags:
      - snapshots
      summary: PUT /snapshots/restorations/:id/status
      description: Update restoration status
      operationId: update_restoration_status
      parameters:
      - name: id
        in: path
        description: Restoration ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateRestorationStatusRequest'
        required: true
      responses:
        '200':
          description: Restoration status updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestorationResponse'
        '404':
          description: Restoration not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /snapshots/retention-policies:
    get:
      tags:
      - snapshots
      summary: GET /snapshots/retention-policies
      description: Get retention policies for a circuit
      operationId: get_retention_policies
      parameters:
      - name: circuit_id
        in: query
        description: Circuit ID (optional, null for global policies)
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      responses:
        '200':
          description: List of retention policies
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/RetentionPolicyResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /snapshots/retention-policies/{id}/apply:
    post:
      tags:
      - snapshots
      summary: POST /snapshots/retention-policies/:id/apply
      description: Manually apply a retention policy
      operationId: apply_retention_policy
      parameters:
      - name: id
        in: path
        description: Retention policy ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Retention policy applied successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApplyRetentionResponse'
        '404':
          description: Retention policy not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /snapshots/{id}:
    get:
      tags:
      - snapshots
      summary: GET /snapshots/:id
      description: Get a snapshot by ID
      operationId: get_snapshot
      parameters:
      - name: id
        in: path
        description: Snapshot ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Snapshot found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SnapshotResponse'
        '404':
          description: Snapshot not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
    delete:
      tags:
      - snapshots
      summary: DELETE /snapshots/:id
      description: Delete a snapshot
      operationId: delete_snapshot
      parameters:
      - name: id
        in: path
        description: Snapshot ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '204':
          description: Snapshot deleted successfully
        '404':
          description: Snapshot not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /snapshots/{id}/archive:
    post:
      tags:
      - snapshots
      summary: POST /snapshots/:id/archive
      description: Archive a snapshot
      operationId: archive_snapshot
      parameters:
      - name: id
        in: path
        description: Snapshot ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Snapshot archived successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SnapshotResponse'
        '404':
          description: Snapshot not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /snapshots/{id}/compare:
    post:
      tags:
      - snapshots
      summary: POST /snapshots/:id/compare
      description: Create a comparison between two snapshots
      operationId: create_comparison
      parameters:
      - name: id
        in: path
        description: First snapshot ID (snapshot A)
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateComparisonRequest'
        required: true
      responses:
        '201':
          description: Comparison created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ComparisonResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /snapshots/{id}/restore:
    post:
      tags:
      - snapshots
      summary: POST /snapshots/:id/restore
      description: Create a restoration from a snapshot
      operationId: create_restoration
      parameters:
      - name: id
        in: path
        description: Snapshot ID to restore from
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRestorationRequest'
        required: true
      responses:
        '201':
          description: Restoration created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestorationResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/crate.error.ErrorResponse'
  /webhooks:
    get:
      tags:
      - webhooks
      summary: List webhooks
      operationId: list_webhooks
      parameters:
      - name: circuit_id
        in: query
        description: Filter by circuit ID
        required: false
        schema:
          type: string
          format: uuid
          nullable: true
      - name: is_active
        in: query
        description: Filter by active status
        required: false
        schema:
          type: boolean
          nullable: true
      responses:
        '200':
          description: Webhooks retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Webhook'
        '500':
          description: Internal server error
    post:
      tags:
      - webhooks
      summary: Create a new webhook
      operationId: create_webhook
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWebhookInput'
        required: true
      responses:
        '201':
          description: Webhook created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Webhook'
        '400':
          description: Invalid input
        '500':
          description: Internal server error
  /webhooks/{id}:
    get:
      tags:
      - webhooks
      summary: Get webhook by ID
      operationId: get_webhook
      parameters:
      - name: id
        in: path
        description: Webhook ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Webhook found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Webhook'
        '404':
          description: Webhook not found
        '500':
          description: Internal server error
    put:
      tags:
      - webhooks
      summary: Update webhook
      operationId: update_webhook
      parameters:
      - name: id
        in: path
        description: Webhook ID
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateWebhookInput'
        required: true
      responses:
        '200':
          description: Webhook updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Webhook'
        '400':
          description: Invalid input
        '404':
          description: Webhook not found
        '500':
          description: Internal server error
    delete:
      tags:
      - webhooks
      summary: Delete webhook
      operationId: delete_webhook
      parameters:
      - name: id
        in: path
        description: Webhook ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '204':
          description: Webhook deleted successfully
        '404':
          description: Webhook not found
        '500':
          description: Internal server error
  /webhooks/{id}/deliveries:
    get:
      tags:
      - webhooks
      summary: Get webhook delivery history
      operationId: get_webhook_deliveries
      parameters:
      - name: id
        in: path
        description: Webhook ID
        required: true
        schema:
          type: string
          format: uuid
      - name: limit
        in: query
        description: Maximum number of deliveries to return
        required: false
        schema:
          type: integer
          format: int64
          nullable: true
      responses:
        '200':
          description: Delivery history retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/WebhookDelivery'
        '404':
          description: Webhook not found
        '500':
          description: Internal server error
  /webhooks/{id}/retry:
    post:
      tags:
      - webhooks
      summary: Trigger manual delivery retry
      operationId: retry_webhook
      parameters:
      - name: id
        in: path
        description: Webhook ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '202':
          description: Retry scheduled
        '404':
          description: Webhook not found
        '500':
          description: Internal server error
  /webhooks/{id}/stats:
    get:
      tags:
      - webhooks
      summary: Get webhook statistics
      operationId: get_webhook_stats
      parameters:
      - name: id
        in: path
        description: Webhook ID
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Webhook statistics retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookStats'
        '404':
          description: Webhook not found
        '500':
          description: Internal server error
components:
  schemas:
    ActivityFeed:
      type: object
      required:
      - id
      - actor_id
      - action
      - resource_type
      - description
      - is_public
      - created_at
      properties:
        action:
          type: string
        actor_id:
          type: string
          format: uuid
        actor_name:
          type: string
          nullable: true
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        description:
          type: string
        id:
          type: string
          format: uuid
        is_public:
          type: boolean
        metadata:
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_name:
          type: string
          nullable: true
        resource_type:
          type: string
    ActivitySummary:
      type: object
      required:
      - id
      - summary_date
      - summary_type
      - action_counts
      - resource_counts
      - created_at
      properties:
        action_counts: {}
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        id:
          type: string
          format: uuid
        resource_counts: {}
        summary_date:
          type: string
          format: date
        summary_type:
          type: string
        user_id:
          type: string
          format: uuid
          nullable: true
    AddMemberRequest:
      type: object
      required:
      - user_id
      - role
      properties:
        added_by:
          type: string
          format: uuid
          nullable: true
        permissions:
          nullable: true
        role:
          type: string
        user_id:
          type: string
          format: uuid
    ApplyRetentionResponse:
      type: object
      required:
      - policy_id
      - snapshots_affected
      properties:
        policy_id:
          type: string
          format: uuid
        snapshots_affected:
          type: integer
          format: int64
          minimum: 0
    AuditLog:
      type: object
      required:
      - id
      - action
      - resource_type
      - created_at
      properties:
        action:
          type: string
        changes:
          nullable: true
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        hash:
          type: string
          nullable: true
        id:
          type: string
          format: uuid
        ip_address:
          type: string
          nullable: true
        metadata:
          nullable: true
        previous_hash:
          type: string
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_type:
          type: string
        user_agent:
          type: string
          nullable: true
        user_id:
          type: string
          format: uuid
          nullable: true
    AuditLogResponse:
      type: object
      required:
      - id
      - action
      - resource_type
      - created_at
      properties:
        action:
          type: string
        changes:
          nullable: true
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        hash:
          type: string
          nullable: true
        id:
          type: string
          format: uuid
        ip_address:
          type: string
          nullable: true
        metadata:
          nullable: true
        previous_hash:
          type: string
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_type:
          type: string
        user_agent:
          type: string
          nullable: true
        user_id:
          type: string
          format: uuid
          nullable: true
    Circuit:
      type: object
      required:
      - id
      - name
      - circuit_type
      - visibility
      - owner_id
      - status
      - is_archived
      - created_at
      - updated_at
      - is_published
      - discovery_enabled
      - searchable
      - featured
      - view_count
      properties:
        archived_at:
          type: string
          format: date-time
          nullable: true
        circuit_type:
          type: string
        created_at:
          type: string
          format: date-time
        description:
          type: string
          nullable: true
        discovery_enabled:
          type: boolean
        featured:
          type: boolean
        id:
          type: string
          format: uuid
        is_archived:
          type: boolean
        is_published:
          type: boolean
        metadata:
          nullable: true
        name:
          type: string
        organization_id:
          type: string
          format: uuid
          nullable: true
        owner_id:
          type: string
          format: uuid
        public_banner_url:
          type: string
          nullable: true
        public_contact_email:
          type: string
          nullable: true
        public_description:
          type: string
          nullable: true
        public_logo_url:
          type: string
          nullable: true
        public_website:
          type: string
          nullable: true
        published_at:
          type: string
          format: date-time
          nullable: true
        published_by:
          type: string
          format: uuid
          nullable: true
        searchable:
          type: boolean
        settings:
          nullable: true
        slug:
          type: string
          nullable: true
        status:
          type: string
        unpublished_at:
          type: string
          format: date-time
          nullable: true
        updated_at:
          type: string
          format: date-time
        view_count:
          type: integer
          format: int64
        visibility:
          type: string
    CircuitMember:
      type: object
      required:
      - id
      - circuit_id
      - user_id
      - role
      - status
      - joined_at
      - created_at
      - updated_at
      properties:
        circuit_id:
          type: string
          format: uuid
        created_at:
          type: string
          format: date-time
        custom_permissions:
          nullable: true
        id:
          type: string
          format: uuid
        joined_at:
          type: string
          format: date-time
        permissions:
          nullable: true
        removed_at:
          type: string
          format: date-time
          nullable: true
        role:
          type: string
        status:
          type: string
        updated_at:
          type: string
          format: date-time
        user_id:
          type: string
          format: uuid
    CircuitMemberResponse:
      type: object
      required:
      - circuit_id
      - user_id
      - role
      - joined_at
      - updated_at
      properties:
        circuit_id:
          type: string
          format: uuid
        joined_at:
          type: string
          format: date-time
        permissions:
          nullable: true
        role:
          type: string
        updated_at:
          type: string
          format: date-time
        user_id:
          type: string
          format: uuid
    CircuitResponse:
      type: object
      required:
      - id
      - name
      - circuit_type
      - visibility
      - owner_id
      - status
      - is_archived
      - created_at
      - updated_at
      properties:
        circuit_type:
          type: string
        created_at:
          type: string
          format: date-time
        description:
          type: string
          nullable: true
        id:
          type: string
          format: uuid
        is_archived:
          type: boolean
        metadata:
          nullable: true
        name:
          type: string
        organization_id:
          type: string
          format: uuid
          nullable: true
        owner_id:
          type: string
          format: uuid
        settings:
          nullable: true
        status:
          type: string
        updated_at:
          type: string
          format: date-time
        visibility:
          type: string
    ComparisonResponse:
      type: object
      required:
      - id
      - snapshot_a_id
      - snapshot_b_id
      - comparison_type
      - diff_data
      - created_at
      properties:
        comparison_type:
          type: string
        created_at:
          type: string
          format: date-time
        diff_data: {}
        id:
          type: string
          format: uuid
        snapshot_a_id:
          type: string
          format: uuid
        snapshot_b_id:
          type: string
          format: uuid
        summary:
          nullable: true
    CreateActivityInput:
      type: object
      required:
      - actor_id
      - action
      - resource_type
      - description
      - is_public
      properties:
        action:
          type: string
        actor_id:
          type: string
          format: uuid
        actor_name:
          type: string
          nullable: true
        circuit_id:
          type: string
          format: uuid
          nullable: true
        description:
          type: string
        is_public:
          type: boolean
        metadata:
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_name:
          type: string
          nullable: true
        resource_type:
          type: string
    CreateApiKeyRequest:
      type: object
      required:
      - key_name
      - circuit_id
      properties:
        circuit_id:
          type: string
          format: uuid
          description: Circuit ID this key grants access to
        description:
          type: string
          description: Optional description of key purpose
          nullable: true
        expires_in_days:
          type: integer
          format: int64
          description: 'Number of days until expiration (default: never expires)'
          nullable: true
        key_name:
          type: string
          description: Human-readable name for the API key
    CreateApiKeyResponse:
      type: object
      required:
      - id
      - key_name
      - circuit_id
      - api_key
      - created_at
      - message
      properties:
        api_key:
          type: string
          description: The actual API key (ONLY shown once!)
        circuit_id:
          type: string
          format: uuid
          description: Circuit this key grants access to
        created_at:
          type: string
          description: Creation timestamp (RFC3339)
        expires_at:
          type: string
          description: Expiration timestamp (RFC3339)
          nullable: true
        id:
          type: string
          format: uuid
          description: Unique identifier for this API key record
        key_name:
          type: string
          description: Name of the API key
        message:
          type: string
          description: Important message about saving the key
    CreateCircuitRequest:
      type: object
      required:
      - name
      - circuit_type
      - visibility
      - owner_id
      properties:
        circuit_type:
          type: string
        description:
          type: string
          nullable: true
        ip_address:
          type: string
          nullable: true
        metadata:
          nullable: true
        name:
          type: string
        organization_id:
          type: string
          format: uuid
          nullable: true
        owner_id:
          type: string
          format: uuid
        settings:
          nullable: true
        user_id:
          type: string
          format: uuid
          nullable: true
        visibility:
          type: string
    CreateComparisonRequest:
      type: object
      required:
      - snapshot_b_id
      - comparison_type
      properties:
        comparison_type:
          type: string
        snapshot_b_id:
          type: string
          format: uuid
    CreateItemRequest:
      type: object
      required:
      - value_chain
      - country
      - year
      properties:
        circuit_id:
          type: string
          format: uuid
          nullable: true
        country:
          type: string
        ip_address:
          type: string
          nullable: true
        metadata:
          nullable: true
        owner_id:
          type: string
          format: uuid
          nullable: true
        user_id:
          type: string
          format: uuid
          nullable: true
        value_chain:
          type: string
        year:
          type: integer
          format: int32
    CreateMerkleTreeRequest:
      type: object
      required:
      - tree_type
      - resource_type
      - leaf_data
      properties:
        circuit_id:
          type: string
          format: uuid
          nullable: true
        leaf_data:
          type: array
          items: {}
        metadata:
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_type:
          type: string
        snapshot_id:
          type: string
          format: uuid
          nullable: true
        tree_type:
          type: string
    CreateRestorationRequest:
      type: object
      required:
      - restored_by
      - restoration_type
      properties:
        pre_restore_snapshot_id:
          type: string
          format: uuid
          nullable: true
        restoration_type:
          type: string
        restore_metadata:
          nullable: true
        restored_by:
          type: string
          format: uuid
        target_resource_id:
          type: string
          format: uuid
          nullable: true
    CreateSnapshotRequest:
      type: object
      required:
      - snapshot_type
      - resource_type
      - snapshot_name
      - snapshot_data
      - created_by
      properties:
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_by:
          type: string
          format: uuid
        description:
          type: string
          nullable: true
        expires_at:
          type: string
          format: date-time
          nullable: true
        metadata:
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_type:
          type: string
        snapshot_data: {}
        snapshot_name:
          type: string
        snapshot_type:
          type: string
    CreateWebhookInput:
      type: object
      required:
      - circuit_id
      - name
      - url
      - events
      - created_by
      properties:
        circuit_id:
          type: string
          format: uuid
        created_by:
          type: string
          format: uuid
        events:
          type: array
          items:
            type: string
        headers:
          nullable: true
        name:
          type: string
        retry_config:
          allOf:
          - $ref: '#/components/schemas/WebhookRetryConfig'
          nullable: true
        secret:
          type: string
          nullable: true
        url:
          type: string
    ErrorResponse:
      type: object
      required:
      - error
      - message
      properties:
        details:
          type: string
          nullable: true
        error:
          type: string
        message:
          type: string
    Event:
      type: object
      required:
      - id
      - event_type
      - source_type
      - source_id
      - payload
      - status
      - created_at
      - visibility
      - is_duplicate
      properties:
        circuit_id:
          type: string
          format: uuid
          nullable: true
        content_hash:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        encrypted_payload:
          type: string
          format: binary
          nullable: true
        encryption_key_id:
          type: string
          nullable: true
        error_message:
          type: string
          nullable: true
        event_type:
          type: string
        id:
          type: string
          format: uuid
        is_duplicate:
          type: boolean
        item_id:
          type: string
          format: uuid
          nullable: true
        metadata:
          nullable: true
        original_event_id:
          type: string
          format: uuid
          nullable: true
        payload: {}
        processed_at:
          type: string
          format: date-time
          nullable: true
        source_id:
          type: string
          format: uuid
        source_type:
          type: string
        status:
          type: string
        user_id:
          type: string
          format: uuid
          nullable: true
        visibility:
          type: string
        visible_to_roles:
          nullable: true
    EventResponse:
      type: object
      required:
      - id
      - event_type
      - source_type
      - source_id
      - payload
      - status
      - created_at
      properties:
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        error_message:
          type: string
          nullable: true
        event_type:
          type: string
        id:
          type: string
          format: uuid
        item_id:
          type: string
          format: uuid
          nullable: true
        metadata:
          nullable: true
        payload: {}
        processed_at:
          type: string
          format: date-time
          nullable: true
        source_id:
          type: string
          format: uuid
        source_type:
          type: string
        status:
          type: string
        user_id:
          type: string
          format: uuid
          nullable: true
    GenerateProofRequest:
      type: object
      required:
      - leaf_data
      properties:
        leaf_data: {}
    HashChainVerificationResponse:
      type: object
      required:
      - valid
      - logs_checked
      - message
      properties:
        logs_checked:
          type: integer
          minimum: 0
        message:
          type: string
        valid:
          type: boolean
    HealthResponse:
      type: object
      required:
      - status
      - database
      - redis
      - timestamp
      properties:
        database:
          $ref: '#/components/schemas/HealthStatus'
        redis:
          $ref: '#/components/schemas/HealthStatus'
        status:
          type: string
        timestamp:
          type: string
    HealthStatus:
      type: object
      required:
      - connected
      - latency_ms
      properties:
        connected:
          type: boolean
        latency_ms:
          type: integer
          format: int64
          minimum: 0
    IngestionReceipt:
      type: object
      description: Ingestion receipt returned to the client
      required:
      - receipt_id
      - status
      - processing_time_ms
      - summary
      properties:
        processing_time_ms:
          type: integer
          format: int64
          description: Processing time in milliseconds
          minimum: 0
        receipt_id:
          type: string
          format: uuid
          description: Unique receipt ID
        status:
          type: string
          description: Processing status
        summary:
          $ref: '#/components/schemas/IngestionSummary'
    IngestionSummary:
      type: object
      description: Summary statistics for ingestion operation
      required:
      - rows_total
      - items_created
      - items_updated
      - events_created
      - identifiers_resolved
      - unclassified_fields
      properties:
        events_created:
          type: integer
          description: Number of events created
          minimum: 0
        identifiers_resolved:
          type: object
          description: Count of identifiers resolved by type
          additionalProperties:
            type: integer
            minimum: 0
        items_created:
          type: integer
          description: Number of new items created
          minimum: 0
        items_updated:
          type: integer
          description: Number of existing items updated
          minimum: 0
        rows_total:
          type: integer
          description: Total rows in CSV
          minimum: 0
        unclassified_fields:
          type: array
          items:
            type: string
          description: CSV fields that couldn't be classified
    Item:
      type: object
      required:
      - id
      - dfid
      - value_chain
      - country
      - year
      - status
      - registered_at
      - last_updated_at
      - created_at
      - updated_at
      properties:
        archived_at:
          type: string
          format: date-time
          nullable: true
        circuit_id:
          type: string
          format: uuid
          nullable: true
        country:
          type: string
        created_at:
          type: string
          format: date-time
        dfid:
          type: string
        id:
          type: string
          format: uuid
        last_updated_at:
          type: string
          format: date-time
        local_id:
          type: string
          format: uuid
          nullable: true
        merged_into:
          type: string
          nullable: true
        metadata:
          nullable: true
        owner_id:
          type: string
          format: uuid
          nullable: true
        registered_at:
          type: string
          format: date-time
        split_from:
          type: string
          nullable: true
        status:
          type: string
        updated_at:
          type: string
          format: date-time
        value_chain:
          type: string
        year:
          type: integer
          format: int32
    ItemResponse:
      type: object
      required:
      - id
      - dfid
      - value_chain
      - country
      - year
      - status
      - registered_at
      - updated_at
      properties:
        circuit_id:
          type: string
          format: uuid
          nullable: true
        country:
          type: string
        dfid:
          type: string
        id:
          type: string
          format: uuid
        metadata:
          nullable: true
        owner_id:
          type: string
          format: uuid
          nullable: true
        registered_at:
          type: string
          format: date-time
        status:
          type: string
        updated_at:
          type: string
          format: date-time
        value_chain:
          type: string
        year:
          type: integer
          format: int32
    ListAuditLogsResponse:
      type: object
      required:
      - logs
      - count
      properties:
        count:
          type: integer
          minimum: 0
        logs:
          type: array
          items:
            $ref: '#/components/schemas/AuditLogResponse'
    ListCircuitsResponse:
      type: object
      required:
      - circuits
      - count
      properties:
        circuits:
          type: array
          items:
            $ref: '#/components/schemas/CircuitResponse'
        count:
          type: integer
          minimum: 0
    ListEventsResponse:
      type: object
      required:
      - events
      - count
      properties:
        count:
          type: integer
          minimum: 0
        events:
          type: array
          items:
            $ref: '#/components/schemas/EventResponse'
    ListItemsResponse:
      type: object
      required:
      - items
      - count
      properties:
        count:
          type: integer
          minimum: 0
        items:
          type: array
          items:
            $ref: '#/components/schemas/ItemResponse'
    ListMembersResponse:
      type: object
      required:
      - members
      - count
      properties:
        count:
          type: integer
          minimum: 0
        members:
          type: array
          items:
            $ref: '#/components/schemas/CircuitMemberResponse'
    ListMerkleTreesResponse:
      type: object
      required:
      - trees
      - count
      properties:
        count:
          type: integer
          minimum: 0
        trees:
          type: array
          items:
            $ref: '#/components/schemas/MerkleTreeResponse'
    ListSnapshotsResponse:
      type: object
      required:
      - snapshots
      - count
      properties:
        count:
          type: integer
          minimum: 0
        snapshots:
          type: array
          items:
            $ref: '#/components/schemas/SnapshotResponse'
    MergeItemsRequest:
      type: object
      required:
      - secondary_dfid
      - strategy
      properties:
        secondary_dfid:
          type: string
          description: DFID of the secondary item to merge into the primary
        strategy:
          type: string
          description: 'Merge strategy: "append", "keep_first", or "overwrite"'
        user_id:
          type: string
          format: uuid
          description: User performing the merge operation
          nullable: true
    MergeItemsResponse:
      type: object
      required:
      - merged_item
      - message
      properties:
        merged_item:
          $ref: '#/components/schemas/Item'
        message:
          type: string
          description: Success message
    MerkleNode:
      type: object
      required:
      - id
      - tree_id
      - node_hash
      - node_type
      - level
      - position
      - created_at
      properties:
        created_at:
          type: string
          format: date-time
        data_hash:
          type: string
          nullable: true
        data_reference:
          nullable: true
        id:
          type: string
          format: uuid
        left_child_id:
          type: string
          format: uuid
          nullable: true
        level:
          type: integer
          format: int32
        node_hash:
          type: string
        node_type:
          type: string
        parent_id:
          type: string
          format: uuid
          nullable: true
        position:
          type: integer
          format: int32
        right_child_id:
          type: string
          format: uuid
          nullable: true
        tree_id:
          type: string
          format: uuid
    MerkleProof:
      type: object
      required:
      - id
      - tree_id
      - leaf_hash
      - leaf_data
      - proof_path
      - proof_positions
      - root_hash
      - is_valid
      - created_at
      properties:
        created_at:
          type: string
          format: date-time
        id:
          type: string
          format: uuid
        is_valid:
          type: boolean
        leaf_data: {}
        leaf_hash:
          type: string
        proof_path: {}
        proof_positions: {}
        root_hash:
          type: string
        tree_id:
          type: string
          format: uuid
        verified_at:
          type: string
          format: date-time
          nullable: true
    MerkleTree:
      type: object
      required:
      - id
      - tree_type
      - resource_type
      - root_hash
      - height
      - leaf_count
      - hash_algorithm
      - created_at
      - updated_at
      properties:
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        hash_algorithm:
          type: string
        height:
          type: integer
          format: int32
        id:
          type: string
          format: uuid
        leaf_count:
          type: integer
          format: int32
        metadata:
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_type:
          type: string
        root_hash:
          type: string
        snapshot_id:
          type: string
          format: uuid
          nullable: true
        tree_type:
          type: string
        updated_at:
          type: string
          format: date-time
    MerkleTreeResponse:
      type: object
      required:
      - id
      - tree_type
      - resource_type
      - root_hash
      - height
      - leaf_count
      - hash_algorithm
      - created_at
      - updated_at
      properties:
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        hash_algorithm:
          type: string
        height:
          type: integer
          format: int32
        id:
          type: string
          format: uuid
        leaf_count:
          type: integer
          format: int32
        metadata:
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_type:
          type: string
        root_hash:
          type: string
        snapshot_id:
          type: string
          format: uuid
          nullable: true
        tree_type:
          type: string
        updated_at:
          type: string
          format: date-time
    MerkleVerification:
      type: object
      required:
      - id
      - tree_id
      - verification_type
      - leaf_hash
      - expected_root
      - actual_root
      - is_valid
      - created_at
      properties:
        actual_root:
          type: string
        created_at:
          type: string
          format: date-time
        error_message:
          type: string
          nullable: true
        expected_root:
          type: string
        id:
          type: string
          format: uuid
        is_valid:
          type: boolean
        leaf_hash:
          type: string
        proof_id:
          type: string
          format: uuid
          nullable: true
        tree_id:
          type: string
          format: uuid
        verification_time_ms:
          type: integer
          format: int32
          nullable: true
        verification_type:
          type: string
        verified_by:
          type: string
          format: uuid
          nullable: true
    ProofResponse:
      type: object
      required:
      - id
      - tree_id
      - leaf_hash
      - leaf_data
      - proof_path
      - proof_positions
      - root_hash
      - is_valid
      - created_at
      properties:
        created_at:
          type: string
          format: date-time
        id:
          type: string
          format: uuid
        is_valid:
          type: boolean
        leaf_data: {}
        leaf_hash:
          type: string
        proof_path: {}
        proof_positions: {}
        root_hash:
          type: string
        tree_id:
          type: string
          format: uuid
        verified_at:
          type: string
          format: date-time
          nullable: true
    RecentActivity:
      type: object
      required:
      - id
      - user_id
      - activity_type
      - activity_count
      - last_activity_at
      - created_at
      properties:
        activity_count:
          type: integer
          format: int32
        activity_type:
          type: string
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        id:
          type: string
          format: uuid
        last_activity_at:
          type: string
          format: date-time
        user_id:
          type: string
          format: uuid
    RestorationResponse:
      type: object
      required:
      - id
      - snapshot_id
      - restored_by
      - restoration_type
      - status
      - created_at
      properties:
        completed_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        error_message:
          type: string
          nullable: true
        id:
          type: string
          format: uuid
        pre_restore_snapshot_id:
          type: string
          format: uuid
          nullable: true
        restoration_type:
          type: string
        restore_metadata:
          nullable: true
        restored_by:
          type: string
          format: uuid
        snapshot_id:
          type: string
          format: uuid
        status:
          type: string
        target_resource_id:
          type: string
          format: uuid
          nullable: true
    RetentionPolicyResponse:
      type: object
      required:
      - id
      - snapshot_type
      - retention_days
      - auto_archive
      - is_active
      - created_at
      - updated_at
      properties:
        auto_archive:
          type: boolean
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        id:
          type: string
          format: uuid
        is_active:
          type: boolean
        max_snapshots:
          type: integer
          format: int32
          nullable: true
        resource_type:
          type: string
          nullable: true
        retention_days:
          type: integer
          format: int32
        snapshot_type:
          type: string
        updated_at:
          type: string
          format: date-time
    Snapshot:
      type: object
      required:
      - id
      - snapshot_type
      - resource_type
      - snapshot_name
      - snapshot_data
      - created_by
      - created_at
      - is_archived
      - checksum
      properties:
        archived_at:
          type: string
          format: date-time
          nullable: true
        checksum:
          type: string
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        created_by:
          type: string
          format: uuid
        description:
          type: string
          nullable: true
        expires_at:
          type: string
          format: date-time
          nullable: true
        id:
          type: string
          format: uuid
        is_archived:
          type: boolean
        metadata:
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_type:
          type: string
        snapshot_data: {}
        snapshot_name:
          type: string
        snapshot_type:
          type: string
    SnapshotComparison:
      type: object
      required:
      - id
      - snapshot_a_id
      - snapshot_b_id
      - comparison_type
      - diff_data
      - created_at
      properties:
        comparison_type:
          type: string
        created_at:
          type: string
          format: date-time
        diff_data: {}
        id:
          type: string
          format: uuid
        snapshot_a_id:
          type: string
          format: uuid
        snapshot_b_id:
          type: string
          format: uuid
        summary:
          nullable: true
    SnapshotResponse:
      type: object
      required:
      - id
      - snapshot_type
      - resource_type
      - snapshot_name
      - snapshot_data
      - created_by
      - created_at
      - is_archived
      - checksum
      properties:
        archived_at:
          type: string
          format: date-time
          nullable: true
        checksum:
          type: string
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        created_by:
          type: string
          format: uuid
        description:
          type: string
          nullable: true
        expires_at:
          type: string
          format: date-time
          nullable: true
        id:
          type: string
          format: uuid
        is_archived:
          type: boolean
        metadata:
          nullable: true
        resource_id:
          type: string
          format: uuid
          nullable: true
        resource_type:
          type: string
        snapshot_data: {}
        snapshot_name:
          type: string
        snapshot_type:
          type: string
    SnapshotRestoration:
      type: object
      required:
      - id
      - snapshot_id
      - restored_by
      - restoration_type
      - status
      - created_at
      properties:
        completed_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        error_message:
          type: string
          nullable: true
        id:
          type: string
          format: uuid
        pre_restore_snapshot_id:
          type: string
          format: uuid
          nullable: true
        restoration_type:
          type: string
        restore_metadata:
          nullable: true
        restored_by:
          type: string
          format: uuid
        snapshot_id:
          type: string
          format: uuid
        status:
          type: string
        target_resource_id:
          type: string
          format: uuid
          nullable: true
    SnapshotRetentionPolicy:
      type: object
      required:
      - id
      - snapshot_type
      - retention_days
      - auto_archive
      - is_active
      - created_at
      - updated_at
      properties:
        auto_archive:
          type: boolean
        circuit_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        id:
          type: string
          format: uuid
        is_active:
          type: boolean
        max_snapshots:
          type: integer
          format: int32
          nullable: true
        resource_type:
          type: string
          nullable: true
        retention_days:
          type: integer
          format: int32
        snapshot_type:
          type: string
        updated_at:
          type: string
          format: date-time
    SplitItemRequest:
      type: object
      required:
      - value_chain
      - country
      - year
      - metadata
      properties:
        country:
          type: string
          description: Country code for the new item
        metadata:
          description: Metadata for the new item
        user_id:
          type: string
          format: uuid
          description: User performing the split operation
          nullable: true
        value_chain:
          type: string
          description: Value chain for the new item
        year:
          type: integer
          format: int32
          description: Year for the new item
    SplitItemResponse:
      type: object
      required:
      - source_item
      - new_item
      - message
      properties:
        message:
          type: string
          description: Success message
        new_item:
          $ref: '#/components/schemas/Item'
        source_item:
          $ref: '#/components/schemas/Item'
    TrustLevel:
      type: string
      description: Trust level enum for conflict resolution
      enum:
      - SanitaryAgency
      - Certifier
      - Processor
      - Producer
      - Unknown
    UnmergeItemRequest:
      type: object
      properties:
        user_id:
          type: string
          format: uuid
          description: User performing the unmerge operation
          nullable: true
    UnmergeItemResponse:
      type: object
      required:
      - restored_item
      - message
      properties:
        message:
          type: string
          description: Success message
        restored_item:
          $ref: '#/components/schemas/Item'
    UpdateCircuitRequest:
      type: object
      properties:
        description:
          type: string
          nullable: true
        ip_address:
          type: string
          nullable: true
        metadata:
          nullable: true
        name:
          type: string
          nullable: true
        settings:
          nullable: true
        status:
          type: string
          nullable: true
        user_id:
          type: string
          format: uuid
          nullable: true
        visibility:
          type: string
          nullable: true
    UpdateEventStatusRequest:
      type: object
      required:
      - status
      properties:
        error_message:
          type: string
          nullable: true
        status:
          type: string
    UpdateItemRequest:
      type: object
      required:
      - metadata
      properties:
        ip_address:
          type: string
          nullable: true
        metadata: {}
        user_id:
          type: string
          format: uuid
          nullable: true
    UpdateItemStatusRequest:
      type: object
      required:
      - status
      properties:
        ip_address:
          type: string
          nullable: true
        status:
          type: string
        user_id:
          type: string
          format: uuid
          nullable: true
    UpdateMemberRequest:
      type: object
      properties:
        permissions:
          nullable: true
        role:
          type: string
          nullable: true
        updated_by:
          type: string
          format: uuid
          nullable: true
    UpdateRestorationStatusRequest:
      type: object
      required:
      - status
      properties:
        error_message:
          type: string
          nullable: true
        status:
          type: string
    UpdateWebhookInput:
      type: object
      properties:
        events:
          type: array
          items:
            type: string
          nullable: true
        headers:
          nullable: true
        is_active:
          type: boolean
          nullable: true
        name:
          type: string
          nullable: true
        retry_config:
          allOf:
          - $ref: '#/components/schemas/WebhookRetryConfig'
          nullable: true
        secret:
          type: string
          nullable: true
        url:
          type: string
          nullable: true
    UserSession:
      type: object
      required:
      - id
      - user_id
      - started_at
      - last_activity_at
      - is_active
      properties:
        ended_at:
          type: string
          format: date-time
          nullable: true
        id:
          type: string
          format: uuid
        ip_address:
          type: string
          nullable: true
        is_active:
          type: boolean
        last_activity_at:
          type: string
          format: date-time
        session_token:
          type: string
          nullable: true
        started_at:
          type: string
          format: date-time
        user_agent:
          type: string
          nullable: true
        user_id:
          type: string
          format: uuid
    VerificationHistoryResponse:
      type: object
      required:
      - verifications
      - count
      properties:
        count:
          type: integer
          minimum: 0
        verifications:
          type: array
          items:
            $ref: '#/components/schemas/MerkleVerification'
    VerificationResponse:
      type: object
      required:
      - is_valid
      - computed_root
      - expected_root
      properties:
        computed_root:
          type: string
        expected_root:
          type: string
        is_valid:
          type: boolean
    VerifyProofRequest:
      type: object
      required:
      - leaf_hash
      - proof_path
      - proof_positions
      - expected_root
      properties:
        expected_root:
          type: string
        leaf_hash:
          type: string
        proof_path:
          type: array
          items:
            type: string
        proof_positions:
          type: array
          items:
            type: integer
            format: int32
    Webhook:
      type: object
      required:
      - id
      - circuit_id
      - name
      - url
      - events
      - is_active
      - created_by
      - created_at
      - updated_at
      properties:
        circuit_id:
          type: string
          format: uuid
        created_at:
          type: string
          format: date-time
        created_by:
          type: string
          format: uuid
        events: {}
        headers:
          nullable: true
        id:
          type: string
          format: uuid
        is_active:
          type: boolean
        name:
          type: string
        retry_config:
          nullable: true
        secret:
          type: string
          nullable: true
        updated_at:
          type: string
          format: date-time
        url:
          type: string
    WebhookDelivery:
      type: object
      required:
      - id
      - webhook_id
      - event_id
      - attempt_number
      - status
      - request_body
      - created_at
      properties:
        attempt_number:
          type: integer
          format: int32
        created_at:
          type: string
          format: date-time
        delivered_at:
          type: string
          format: date-time
          nullable: true
        error_message:
          type: string
          nullable: true
        event_id:
          type: string
          format: uuid
        id:
          type: string
          format: uuid
        next_retry_at:
          type: string
          format: date-time
          nullable: true
        request_body: {}
        request_headers:
          nullable: true
        response_body:
          type: string
          nullable: true
        response_headers:
          nullable: true
        response_status_code:
          type: integer
          format: int32
          nullable: true
        status:
          type: string
        webhook_id:
          type: string
          format: uuid
    WebhookRetryConfig:
      type: object
      required:
      - max_retries
      - retry_delay
      properties:
        max_retries:
          type: integer
          format: int32
        retry_delay:
          type: integer
          format: int32
    WebhookStats:
      type: object
      required:
      - webhook_id
      - total_deliveries
      - successful_deliveries
      - failed_deliveries
      - updated_at
      properties:
        average_response_time_ms:
          type: integer
          format: int32
          nullable: true
        failed_deliveries:
          type: integer
          format: int64
        last_delivery_at:
          type: string
          format: date-time
          nullable: true
        last_failure_at:
          type: string
          format: date-time
          nullable: true
        last_success_at:
          type: string
          format: date-time
          nullable: true
        successful_deliveries:
          type: integer
          format: int64
        total_deliveries:
          type: integer
          format: int64
        updated_at:
          type: string
          format: date-time
        webhook_id:
          type: string
          format: uuid
tags:
- name: health
  description: Health check and monitoring endpoints
- name: items
  description: Item registry CRUD operations and bulk import
- name: workflows
  description: Item merge, split, unmerge, and relationship tracking
- name: circuits
  description: Circuit and member management
- name: events
  description: Event tracking and lifecycle management
- name: audit
  description: Immutable audit logs with hash chain verification
- name: admin
  description: Administrative operations and API key management
- name: webhooks
  description: Webhook subscriptions and delivery tracking
- name: activity
  description: Activity feeds, sessions, and user tracking
- name: snapshots
  description: Point-in-time snapshots with restore capabilities
- name: merkle
  description: Merkle tree construction and cryptographic verification

