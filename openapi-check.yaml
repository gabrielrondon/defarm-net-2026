openapi: 3.0.3
info:
  title: DeFarm Check API
  description: |
    API de verifica√ß√£o de compliance socioambiental para o agroneg√≥cio brasileiro.

    Agrega m√∫ltiplas fontes de dados p√∫blicos governamentais para validar conformidade
    de produtores, propriedades e produtos rurais.

    **Fontes de dados:**
    - Lista Suja do Trabalho Escravo (MTE) - 678 registros
    - Embargos Ambientais (IBAMA) - 65,953 documentos
    - Desmatamento Hist√≥rico (PRODES/INPE) - Dados geoespaciais anuais
    - Alertas de Desmatamento em Tempo Real (DETER/INPE) - Alertas di√°rios √∫ltimos 90 dias
    - Terras Ind√≠genas (FUNAI) - Todas TIs demarcadas no Brasil
    - Unidades de Conserva√ß√£o (ICMBio) - Todas UCs federais, estaduais e municipais
    - Cadastro Ambiental Rural (CAR/SICAR) - Cobertura nacional 27 estados

    **Documenta√ß√£o completa:** https://github.com/gabrielrondon/defarm-check-api
  version: 2.1.0
  contact:
    name: DeFarm Support
    email: suporte@defarm.com
    url: https://defarm.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://defarm-check-api-production.up.railway.app
    description: Production server
  - url: http://localhost:3000
    description: Local development server

tags:
  - name: check
    description: Compliance check operations
  - name: sources
    description: Data source information
  - name: samples
    description: Sample data for testing
  - name: health
    description: Health check endpoints

security:
  - ApiKeyAuth: []

paths:
  /check:
    post:
      tags:
        - check
      summary: Execute compliance check
      description: |
        Executa verifica√ß√£o de compliance socioambiental para um input (CNPJ, CPF, CAR, coordenadas ou endere√ßo).

        A API consulta m√∫ltiplas fontes em paralelo e retorna um veredito agregado com score de 0-100.

        **Tipos de Input:**
        - **CNPJ/CPF**: Documentos de pessoa f√≠sica ou jur√≠dica (com ou sem formata√ß√£o)
        - **CAR**: N√∫mero do Cadastro Ambiental Rural (formato: UF-MUNIC√çPIO-C√ìDIGO)
        - **COORDINATES**: Coordenadas GPS (lat/lon em decimal WGS84)
        - **ADDRESS**: Endere√ßo brasileiro em texto livre (geocodificado automaticamente)

        ---

        ## üîç Checkers Executados Automaticamente

        A API executa at√© **13 checkers** em paralelo, dependendo do tipo de input:

        ### Social & Legal (CNPJ/CPF)
        - **Slave Labor Registry**: Lista Suja do Trabalho Escravo (MTE)
        - **CGU Sanctions**: San√ß√µes federais (CEIS, CNEP, CEAF)

        ### Environmental - Document-based (CNPJ/CPF)
        - **IBAMA Embargoes**: Embargos ambientais por documento

        ### Environmental - CAR-based
        - **CAR Registry**: Status do CAR (ativo/cancelado/suspenso)
        - **üîÑ CAR x PRODES Intersection**: Cruza geometria do CAR com pol√≠gonos PRODES para detectar desmatamento DENTRO da propriedade ‚≠ê
        - **MapBiomas Validated Deforestation**: Desmatamento validado por analistas dentro do CAR
        - **INPE Fire Hotspots**: Focos de calor/queimadas dentro do CAR (√∫ltimos 90 dias)
        - **ANA Water Use Permits**: Outorgas de uso de √°gua pr√≥ximas ao CAR

        ### Environmental - Spatial (COORDINATES/ADDRESS)
        - **PRODES Deforestation**: Verifica se coordenadas caem em pol√≠gono de desmatamento hist√≥rico
        - **DETER Real-Time Alerts**: Alertas de desmatamento em tempo real (√∫ltimos 90 dias)
        - **Indigenous Lands**: Verifica sobreposi√ß√£o com Terras Ind√≠genas (FUNAI)
        - **Conservation Units**: Verifica sobreposi√ß√£o com UCs (ICMBio)
        - **IBAMA Embargoes (Spatial)**: Embargos em buffer de 5km das coordenadas
        - **MapBiomas Validated Deforestation**: Desmatamento validado pr√≥ximo √†s coordenadas
        - **INPE Fire Hotspots**: Focos de calor pr√≥ximos √†s coordenadas
        - **ANA Water Use Permits**: Outorgas pr√≥ximas √†s coordenadas

        ### Positive/Certification (CNPJ)
        - **MAPA Organic Certification**: Certifica√ß√£o org√¢nica (quando dispon√≠vel)

        ---

        ## üîÑ Intersec√ß√µes Espaciais (Spatial Crosses)

        **O que s√£o?** Alguns checkers fazem intersec√ß√µes geom√©tricas (PostGIS) para detectar problemas dentro de √°reas:

        1. **CAR x PRODES Intersection** ‚≠ê (Mais importante)
           - Input: CAR number
           - Cruza: Geometria do CAR (propriedade) com pol√≠gonos PRODES (desmatamento)
           - Retorna: √Årea desmatada dentro da propriedade, anos, n√∫mero de pol√≠gonos
           - Severity: CRITICAL se desmatamento recente (‚â§2 anos) ou √°rea grande (‚â•100 ha)

        2. **CAR x MapBiomas Alerta**
           - Input: CAR number
           - Cruza: Geometria do CAR com alertas validados MapBiomas
           - Retorna: Alertas de desmatamento dentro da propriedade

        3. **CAR x Queimadas**
           - Input: CAR number
           - Cruza: Geometria do CAR com focos de calor (√∫ltimos 90 dias)
           - Retorna: N√∫mero de focos dentro da propriedade

        4. **CAR x ANA Outorgas**
           - Input: CAR number
           - Cruza: Geometria do CAR com pontos de outorga
           - Retorna: Outorgas dentro ou pr√≥ximas √† propriedade

        5. **COORDINATES x PRODES/TIs/UCs/etc**
           - Input: COORDINATES ou ADDRESS (geocoded)
           - Verifica: Se ponto cai dentro de pol√≠gonos de restri√ß√£o

        **Tecnologia:** PostGIS `ST_Intersects()`, `ST_Contains()`, `ST_Within()`

        ---

        ## üåç Geocoding (ADDRESS)

        - Endere√ßos s√£o convertidos automaticamente para coordenadas
        - Provider: OpenStreetMap Nominatim (gratuito)
        - Suporta abrevia√ß√µes de estado (PA ‚Üí Par√°, SP ‚Üí S√£o Paulo, etc.)
        - Cache de 1 ano (requisi√ß√µes subsequentes: <100ms)
        - Rate limit: 1 req/s para geocoding (Nominatim policy)

        ---

        ## ‚ö° Performance

        - Primeira requisi√ß√£o: ~200ms (CNPJ/CPF/CAR), ~1-2s (ADDRESS c/ geocoding)
        - Com cache: ~10ms (checkers), ~100ms (ADDRESS cached)
        - Cache TTL: 7 dias (checkers), 1 ano (geocoding)
        - **Checkers executam em paralelo** (n√£o sequencial)

        **Rate limit:** 10,000 requisi√ß√µes/minuto por API key
      operationId: executeCheck
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CheckRequest'
            examples:
              cnpj:
                summary: Verificar CNPJ
                value:
                  input:
                    type: CNPJ
                    value: "12345678000190"
              cnpj_formatted:
                summary: CNPJ com formata√ß√£o
                value:
                  input:
                    type: CNPJ
                    value: "12.345.678/0001-90"
              cpf:
                summary: Verificar CPF
                value:
                  input:
                    type: CPF
                    value: "12345678900"
              coordinates:
                summary: Verificar coordenadas (desmatamento)
                value:
                  input:
                    type: COORDINATES
                    value:
                      lat: -7.0945
                      lon: -61.089
              address:
                summary: Verificar por endere√ßo (geocoding autom√°tico)
                value:
                  input:
                    type: ADDRESS
                    value: "Altamira, Par√°"
              address_full:
                summary: Endere√ßo completo
                value:
                  input:
                    type: ADDRESS
                    value: "S√£o Paulo, SP"
              with_options:
                summary: Com op√ß√µes customizadas
                value:
                  input:
                    type: CNPJ
                    value: "12345678000190"
                  options:
                    useCache: true
                    includeEvidence: true
                    timeout: 30000
      responses:
        '200':
          description: Check executado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckResponse'
              examples:
                compliant:
                  summary: Produtor conforme (100%)
                  value:
                    checkId: "a84b07fb-8142-4cc3-bcf4-a59e368be37c"
                    input:
                      type: "CNPJ"
                      value: "11222333000144"
                    timestamp: "2026-01-29T10:30:00.000Z"
                    verdict: "COMPLIANT"
                    score: 100
                    sources:
                      - name: "Slave Labor Registry"
                        category: "social"
                        status: "PASS"
                        message: "Not found in slave labor registry"
                        executionTimeMs: 15
                        cached: false
                      - name: "IBAMA Embargoes"
                        category: "environmental"
                        status: "PASS"
                        message: "No active IBAMA embargoes found"
                        executionTimeMs: 18
                        cached: false
                    summary:
                      totalCheckers: 2
                      passed: 2
                      failed: 0
                      warnings: 0
                      errors: 0
                      notApplicable: 0
                    metadata:
                      processingTimeMs: 185
                      cacheHitRate: 0
                      apiVersion: "1.0.0"
                      timestamp: "2026-01-29T10:30:00.000Z"
                non_compliant:
                  summary: Produtor n√£o conforme (Lista Suja)
                  value:
                    checkId: "b1c2d3e4-f5g6-h7i8-j9k0-l1m2n3o4p5q6"
                    verdict: "NON_COMPLIANT"
                    score: 50
                    sources:
                      - name: "Slave Labor Registry"
                        category: "social"
                        status: "FAIL"
                        severity: "CRITICAL"
                        message: "Found in slave labor registry: 41.297.068 GILBERTO ELENO BATISTA DOS SANTOS"
                        details:
                          employerName: "41.297.068 GILBERTO ELENO BATISTA DOS SANTOS"
                          type: "CNPJ"
                          state: "SP"
                          address: "ROD. PREFEITO JOAQUIM SIM√ÉO, KM 735, CENTRO, IGARAT√Å/SP"
                          year: 2024
                          workersAffected: 2
                          cnae: "4399-1/03"
                          inclusionDate: "06/10/2025"
                          recommendation: "CRITICAL: Immediate compliance review required."
                        evidence:
                          dataSource: "Minist√©rio do Trabalho e Emprego - Cadastro de Empregadores"
                          url: "https://www.gov.br/trabalho-e-emprego/pt-br/assuntos/inspecao-do-trabalho/areas-de-atuacao/cadastro_empregadores.xlsx"
                          lastUpdate: "2026-01-28"
                        executionTimeMs: 22
                        cached: false
                    summary:
                      totalCheckers: 2
                      passed: 1
                      failed: 1
                      warnings: 0
                    metadata:
                      processingTimeMs: 210
                      cacheHitRate: 0
                deforestation:
                  summary: √Årea com desmatamento detectado
                  value:
                    verdict: "NON_COMPLIANT"
                    score: 0
                    sources:
                      - name: "PRODES Deforestation"
                        category: "environmental"
                        status: "FAIL"
                        severity: "HIGH"
                        message: "Deforestation detected: 15ha in 2024"
                        details:
                          area_ha: 15
                          year: 2024
                          municipality: "Novo Aripuan√£"
                          state: "AM"
                          path_row: "231/066"
                          coordinates:
                            lat: -7.0945
                            lon: -61.089
                          recommendation: "HIGH: Deforestation detected at this location."
                        evidence:
                          dataSource: "INPE PRODES - Programa de Monitoramento do Desmatamento"
                          url: "http://terrabrasilis.dpi.inpe.br/"
                          lastUpdate: "2025-12-01"
                deter_alert:
                  summary: Alerta recente de desmatamento (DETER)
                  value:
                    verdict: "NON_COMPLIANT"
                    score: 0
                    sources:
                      - name: "DETER Real-Time Alerts"
                        category: "environmental"
                        status: "FAIL"
                        severity: "CRITICAL"
                        message: "Recent deforestation alert detected: DESMATAMENTO_VEG (3 days ago)"
                        details:
                          alertDate: "2026-01-26"
                          daysAgo: 3
                          areaHa: 42.5
                          municipality: "L√°brea"
                          state: "AM"
                          classname: "DESMATAMENTO_VEG"
                          sensor: "WFI"
                          pathRow: "231/066"
                          coordinates:
                            lat: -7.0945
                            lon: -61.089
                          recommendation: "CRITICAL: Recent deforestation detected. This location has been flagged for illegal deforestation in the last week."
                        evidence:
                          dataSource: "INPE DETER-B - Sistema de Detec√ß√£o de Desmatamento em Tempo Real"
                          url: "http://terrabrasilis.dpi.inpe.br/"
                          lastUpdate: "2026-01-29"
                indigenous_land:
                  summary: Sobreposi√ß√£o com Terra Ind√≠gena
                  value:
                    verdict: "NON_COMPLIANT"
                    score: 0
                    sources:
                      - name: "Indigenous Lands"
                        category: "environmental"
                        status: "FAIL"
                        severity: "CRITICAL"
                        message: "Location overlaps with Indigenous Land: Yanomami"
                        details:
                          terraIndigena: "Yanomami"
                          etnia: "Yanomami"
                          phase: "Homologada"
                          phaseDescription: "officially recognized by Presidential decree"
                          areaHa: 9664975
                          municipality: "Alto Alegre"
                          state: "RR"
                          coordinates:
                            lat: 2.5
                            lon: -63.8
                          recommendation: "CRITICAL: This location is within Indigenous Land. Economic activities strictly prohibited by law."
                        evidence:
                          dataSource: "FUNAI - Funda√ß√£o Nacional dos Povos Ind√≠genas"
                          url: "https://www.gov.br/funai/pt-br/atuacao/terras-indigenas"
                          lastUpdate: "2026-01-29"
                conservation_unit:
                  summary: Sobreposi√ß√£o com Unidade de Conserva√ß√£o
                  value:
                    verdict: "NON_COMPLIANT"
                    score: 0
                    sources:
                      - name: "Conservation Units"
                        category: "environmental"
                        status: "FAIL"
                        severity: "CRITICAL"
                        message: "Location overlaps with Conservation Unit: Parque Nacional do Ja√∫"
                        details:
                          unidadeConservacao: "Parque Nacional do Ja√∫"
                          category: "Parque Nacional"
                          group: "Prote√ß√£o Integral"
                          groupDescription: "Full Protection - economic activities strictly prohibited"
                          areaHa: 2272000
                          municipality: "Novo Air√£o"
                          state: "AM"
                          sphere: "Federal"
                          coordinates:
                            lat: -1.9
                            lon: -61.6
                          recommendation: "CRITICAL: Full Protection Conservation Unit. Economic activities strictly prohibited."
                        evidence:
                          dataSource: "ICMBio - Instituto Chico Mendes de Conserva√ß√£o da Biodiversidade"
                          url: "https://www.gov.br/icmbio/pt-br/assuntos/biodiversidade/unidade-de-conservacao"
                          lastUpdate: "2026-01-29"
                car_check:
                  summary: Propriedade com CAR cancelado
                  value:
                    verdict: "NON_COMPLIANT"
                    score: 25
                    sources:
                      - name: "CAR - Cadastro Ambiental Rural"
                        category: "environmental"
                        status: "FAIL"
                        severity: "HIGH"
                        message: "Location has cancelado CAR registration: MT-5102504-0123456789ABCDEF"
                        details:
                          carNumber: "MT-5102504-0123456789ABCDEF"
                          carStatus: "CANCELADO"
                          ownerDocument: "12345678000190"
                          ownerName: "Fazenda Exemplo Ltda"
                          propertyName: "Fazenda S√£o Jo√£o"
                          areaHa: 1250
                          municipality: "Lucas do Rio Verde"
                          state: "MT"
                          coordinates:
                            lat: -13.05
                            lon: -55.91
                          recommendation: "CRITICAL: CAR cancelled. Property is irregular according to Forest Code."
                        evidence:
                          dataSource: "SICAR - Sistema Nacional de Cadastro Ambiental Rural"
                          url: "https://www.car.gov.br/publico/imoveis/index?car=MT-5102504-0123456789ABCDEF"
                          lastUpdate: "2026-01-29"
        '400':
          description: Bad Request - Input inv√°lido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Bad Request"
                message: "Invalid input type. Must be one of: CNPJ, CPF, COORDINATES"
                statusCode: 400
        '401':
          description: Unauthorized - API key inv√°lida ou ausente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Unauthorized"
                message: "Missing API key. Include X-API-Key header."
                statusCode: 401
        '429':
          description: Too Many Requests - Rate limit excedido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Too Many Requests"
                message: "Rate limit exceeded. Maximum 10,000 requests per minute."
                statusCode: 429
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Internal Server Error"
                message: "An unexpected error occurred"
                statusCode: 500

  /checks/{id}:
    get:
      tags:
        - check
      summary: Get check by ID
      description: |
        Busca resultado de uma verifica√ß√£o anterior pelo ID.

        √ötil para:
        - Recuperar resultados hist√≥ricos
        - Implementar polling de checks ass√≠ncronos
        - Auditar verifica√ß√µes passadas
      operationId: getCheckById
      parameters:
        - name: id
          in: path
          required: true
          description: ID √∫nico da verifica√ß√£o (UUID)
          schema:
            type: string
            format: uuid
          example: "a84b07fb-8142-4cc3-bcf4-a59e368be37c"
      responses:
        '200':
          description: Check encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckResponse'
        '404':
          description: Check n√£o encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Not Found"
                message: "Check not found"
                statusCode: 404

  /sources:
    get:
      tags:
        - sources
      summary: List all data sources and checkers
      description: |
        Lista todas as fontes de dados (checkers) dispon√≠veis na API.

        **Total:** 13 checkers ativos (social, legal, environmental, certification)

        **√ötil para:**
        - Descobrir quais checkers est√£o ativos
        - Verificar status operacional de cada fonte
        - Entender categorias dispon√≠veis
        - Ver quais input types cada checker suporta

        **Nota:** Alguns checkers fazem intersec√ß√µes espaciais (spatial crosses) usando PostGIS.
        Exemplo: "CAR x PRODES Intersection" cruza geometria do CAR com pol√≠gonos PRODES.
      operationId: listSources
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: Lista de fontes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SourceInfo'
              example:
                - name: "Slave Labor Registry"
                  category: "social"
                  enabled: true
                  status: "operational"
                  description: "Verifica se CNPJ/CPF est√° na Lista Suja do Trabalho Escravo (MTE)"
                - name: "IBAMA Embargoes"
                  category: "environmental"
                  enabled: true
                  status: "operational"
                  description: "Verifica embargos ambientais ativos do IBAMA"
                - name: "PRODES Deforestation"
                  category: "environmental"
                  enabled: true
                  status: "operational"
                  description: "Detecta desmatamento hist√≥rico anual em coordenadas (INPE PRODES)"
                - name: "DETER Real-Time Alerts"
                  category: "environmental"
                  enabled: true
                  status: "operational"
                  description: "Detecta alertas de desmatamento em tempo real (√∫ltimos 90 dias) - INPE DETER-B"
                - name: "Indigenous Lands"
                  category: "environmental"
                  enabled: true
                  status: "operational"
                  description: "Verifica sobreposi√ß√£o com Terras Ind√≠genas demarcadas (FUNAI)"
                - name: "Conservation Units"
                  category: "environmental"
                  enabled: true
                  status: "operational"
                  description: "Verifica sobreposi√ß√£o com Unidades de Conserva√ß√£o (ICMBio)"
                - name: "CAR - Cadastro Ambiental Rural"
                  category: "environmental"
                  enabled: true
                  status: "operational"
                  description: "Verifica regulariza√ß√£o ambiental via CAR - Cobertura nacional 27 estados (SICAR)"
                - name: "CAR x PRODES Intersection"
                  category: "environmental"
                  enabled: true
                  status: "operational"
                  description: "Cruza geometria do CAR com pol√≠gonos PRODES para detectar desmatamento dentro da propriedade (intersec√ß√£o espacial PostGIS)"
                - name: "MapBiomas Validated Deforestation"
                  category: "environmental"
                  enabled: true
                  status: "operational"
                  description: "Desmatamento validado por analistas (MapBiomas Alerta) - suporta CAR e coordenadas"
                - name: "INPE Fire Hotspots"
                  category: "environmental"
                  enabled: true
                  status: "operational"
                  description: "Focos de calor/queimadas detectados por sat√©lites (√∫ltimos 90 dias) - suporta CAR e coordenadas"
                - name: "ANA Water Use Permits"
                  category: "environmental"
                  enabled: true
                  status: "operational"
                  description: "Outorgas de uso de recursos h√≠dricos (ANA) - suporta CAR e coordenadas"

  /sources/{category}:
    get:
      tags:
        - sources
      summary: List sources by category
      description: |
        Lista fontes de dados filtradas por categoria.

        **Categorias dispon√≠veis:**
        - `social`: Checkers de compliance social (trabalho escravo, etc)
        - `environmental`: Checkers ambientais (embargos, desmatamento, CAR)
        - `legal`: Checkers legais (em desenvolvimento)
      operationId: listSourcesByCategory
      security:
        - ApiKeyAuth: []
      parameters:
        - name: category
          in: path
          required: true
          description: Categoria das fontes
          schema:
            type: string
            enum:
              - environmental
              - social
              - legal
          example: "environmental"
      responses:
        '200':
          description: Lista de fontes da categoria
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SourceInfo'
              example:
                - name: "IBAMA Embargoes"
                  category: "environmental"
                  enabled: true
                  status: "operational"
                  description: "Verifica embargos ambientais ativos do IBAMA"
                - name: "PRODES Deforestation"
                  category: "environmental"
                  enabled: true
                  status: "operational"
                  description: "Detecta desmatamento hist√≥rico anual em coordenadas (INPE PRODES)"
                - name: "DETER Real-Time Alerts"
                  category: "environmental"
                  enabled: true
                  status: "operational"
                  description: "Detecta alertas de desmatamento em tempo real (INPE DETER-B)"
                - name: "Indigenous Lands"
                  category: "environmental"
                  enabled: true
                  status: "operational"
                  description: "Verifica sobreposi√ß√£o com Terras Ind√≠genas (FUNAI)"
                - name: "Conservation Units"
                  category: "environmental"
                  enabled: true
                  status: "operational"
                  description: "Verifica sobreposi√ß√£o com Unidades de Conserva√ß√£o (ICMBio)"
                - name: "CAR - Cadastro Ambiental Rural"
                  category: "environmental"
                  enabled: true
                  status: "operational"
                  description: "Verifica regulariza√ß√£o ambiental via CAR (SICAR)"

  /health:
    get:
      tags:
        - health
      summary: Health check
      description: |
        Verifica status de sa√∫de da API e servi√ßos dependentes.

        **Status poss√≠veis:**
        - `ok`: Todos os servi√ßos operacionais
        - `degraded`: Alguns servi√ßos offline mas API ainda funcional
        - `down`: API n√£o operacional

        **Servi√ßos monitorados:**
        - Database (PostgreSQL + PostGIS)
        - Cache (Redis)
      operationId: healthCheck
      security: []
      responses:
        '200':
          description: API operacional
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: "ok"
                timestamp: "2026-01-29T10:30:00.000Z"
                version: "1.0.0"
                services:
                  database: "ok"
                  redis: "ok"
        '503':
          description: API indispon√≠vel ou degradada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: "degraded"
                timestamp: "2026-01-29T10:30:00.000Z"
                version: "1.0.0"
                services:
                  database: "ok"
                  redis: "down"

  /samples/all:
    get:
      tags:
        - samples
      summary: Get one sample from each data source
      description: |
        Retorna um exemplo de cada fonte de dados dispon√≠vel (overview completo).

        **√ötil para:**
        - Overview r√°pido de todas as fontes
        - Testes end-to-end da API
        - Demos para clientes
        - Verificar quais fontes est√£o populadas

        **Fontes inclu√≠das:**
        - `listaSuja`: CPF/CNPJ na Lista Suja do Trabalho Escravo
        - `ibama`: CPF/CNPJ com embargos IBAMA
        - `terrasIndigenas`: Coordenadas dentro de Terras Ind√≠genas
        - `unidadesConservacao`: Coordenadas dentro de UCs (pode ser null se API offline)
        - `deter`: Alertas DETER recentes (pode ser null se API offline)
        - `car`: CAR com status irregular (CA/SU/PE)
        - `prodes`: Coordenadas com desmatamento PRODES

        **Nota:** Alguns campos podem ser `null` se as APIs governamentais estiverem
        temporariamente indispon√≠veis (n√£o bloqueante - checkers tratam isso retornando PASS).

        Cada exemplo inclui um `testUrl` pronto para usar no endpoint `/check`.
      operationId: getSamplesAll
      security: []
      responses:
        '200':
          description: Samples retornados com sucesso
          content:
            application/json:
              schema:
                type: object
                properties:
                  listaSuja:
                    type: object
                    nullable: true
                  ibama:
                    type: object
                    nullable: true
                  terrasIndigenas:
                    type: object
                    nullable: true
                  unidadesConservacao:
                    type: object
                    nullable: true
                  deter:
                    type: object
                    nullable: true
                  car:
                    type: object
                    nullable: true
                  prodes:
                    type: object
                    nullable: true

  /samples/lista-suja:
    get:
      tags:
        - samples
      summary: Get samples from Lista Suja do Trabalho Escravo
      description: |
        Retorna 10 exemplos aleat√≥rios de CPF/CNPJ presentes na Lista Suja do Trabalho Escravo (MTE).

        **Dados:** 664 registros de empregadores flagrados com trabalho escravo ou an√°logo.

        **Input types suportados:** CPF, CNPJ

        **Uso:**
        Use os documentos retornados (`document` field) para testar o endpoint `/check`
        e verificar que a API realmente detecta trabalho escravo (status: FAIL, severity: CRITICAL).

        **Response:** Cada sample inclui documento, nome, estado, ano da infra√ß√£o e trabalhadores afetados.
      operationId: getSamplesListaSuja
      security: []
      responses:
        '200':
          description: 10 samples retornados
          content:
            application/json:
              schema:
                type: object
                properties:
                  source:
                    type: string
                  count:
                    type: integer
                  samples:
                    type: array
                    items:
                      type: object
                      properties:
                        document:
                          type: string
                        documentFormatted:
                          type: string
                        name:
                          type: string
                        type:
                          type: string
                        state:
                          type: string
                        year:
                          type: integer
                        workersAffected:
                          type: integer
                        testUrl:
                          type: string

  /samples/ibama:
    get:
      tags:
        - samples
      summary: Get samples from IBAMA Environmental Embargoes
      description: |
        Retorna 10 exemplos aleat√≥rios de CPF/CNPJ com embargos ambientais do IBAMA.

        **Dados:** 122,814 documentos agregados com embargos ambientais.

        **Input types suportados:** CPF, CNPJ, COORDINATES (buffer 5km)

        **Uso:**
        Use os documentos retornados para testar detec√ß√£o de embargos IBAMA.
        API retorna FAIL quando embargo_count > 0.

        **Response:** Cada sample inclui documento, nome, n√∫mero de embargos e √°rea total embargada (hectares).
      operationId: getSamplesIbama
      security: []
      responses:
        '200':
          description: 10 samples retornados
          content:
            application/json:
              schema:
                type: object
                properties:
                  source:
                    type: string
                  count:
                    type: integer
                  samples:
                    type: array
                    items:
                      type: object

  /samples/terras-indigenas:
    get:
      tags:
        - samples
      summary: Get samples from Indigenous Lands (Terras Ind√≠genas)
      description: |
        Retorna 10 coordenadas aleat√≥rias dentro de Terras Ind√≠genas demarcadas (FUNAI).

        **Dados:** 649 territ√≥rios ind√≠genas com geometrias PostGIS.

        **Input types suportados:** COORDINATES, ADDRESS (via geocoding)

        **Uso:**
        Use as coordenadas retornadas (centr√≥ide de cada TI) para testar o endpoint `/check`.
        API retorna FAIL (severity: CRITICAL) quando coordenadas caem dentro de Terra Ind√≠gena.

        **Response:** Cada sample inclui nome da TI, etnia, fase de regulariza√ß√£o, √°rea (ha),
        munic√≠pio, estado e coordenadas do centr√≥ide.
      operationId: getSamplesTerrasIndigenas
      security: []
      responses:
        '200':
          description: 10 samples retornados
          content:
            application/json:
              schema:
                type: object
                properties:
                  source:
                    type: string
                  count:
                    type: integer
                  samples:
                    type: array
                    items:
                      type: object

  /samples/unidades-conservacao:
    get:
      tags:
        - samples
      summary: Get samples from Conservation Units (Unidades de Conserva√ß√£o)
      description: |
        Retorna at√© 10 coordenadas aleat√≥rias dentro de Unidades de Conserva√ß√£o (ICMBio).

        **Dados:** Federais, estaduais e municipais (quando dispon√≠vel).

        **Input types suportados:** COORDINATES, ADDRESS (via geocoding)

        **Uso:**
        Use as coordenadas retornadas (centr√≥ide de cada UC) para testar o endpoint `/check`.
        API retorna FAIL quando coordenadas caem dentro de UC de prote√ß√£o integral.

        **‚ö†Ô∏è Nota importante:**
        Se `count: 0`, significa que a API ICMBio est√° temporariamente indispon√≠vel.
        Neste caso, o endpoint retorna um `message` explicativo. Isso √© esperado e
        n√£o bloqueante - o checker retorna PASS quando n√£o h√° dados dispon√≠veis.

        **Response:** Cada sample inclui nome da UC, categoria, grupo, √°rea (ha),
        munic√≠pio, estado, esfera administrativa e coordenadas do centr√≥ide.
      operationId: getSamplesUnidadesConservacao
      security: []
      responses:
        '200':
          description: 10 samples retornados
          content:
            application/json:
              schema:
                type: object

  /samples/deter:
    get:
      tags:
        - samples
      summary: Get samples from DETER Real-Time Alerts
      description: |
        Retorna at√© 10 coordenadas aleat√≥rias com alertas DETER recentes (√∫ltimos 90 dias).

        **Dados:** Alertas de desmatamento em tempo real do INPE/TerraBrasilis.

        **Input types suportados:** COORDINATES, ADDRESS (via geocoding)

        **Uso:**
        Use as coordenadas retornadas (centr√≥ide de cada alerta) para testar o endpoint `/check`.
        API retorna FAIL quando coordenadas caem pr√≥ximas a alertas DETER recentes.

        **‚ö†Ô∏è Nota importante:**
        Se `count: 0`, significa que a API INPE/TerraBrasilis est√° temporariamente indispon√≠vel.
        Neste caso, o endpoint retorna um `message` explicativo. Isso √© esperado e
        n√£o bloqueante - o checker retorna PASS quando n√£o h√° dados dispon√≠veis.

        **Response:** Cada sample inclui data do alerta, √°rea (ha), munic√≠pio, estado,
        classifica√ß√£o, sensor e coordenadas do centr√≥ide.
      operationId: getSamplesDeter
      security: []
      responses:
        '200':
          description: 10 samples retornados
          content:
            application/json:
              schema:
                type: object

  /samples/car:
    get:
      tags:
        - samples
      summary: Get CAR registrations with irregular status
      description: |
        Retorna at√© 10 registros CAR (Cadastro Ambiental Rural) com status irregular.

        **Dados:** 8,096,127 registros CAR de 27 estados brasileiros (SICAR).

        **Input types suportados:** CAR (c√≥digo completo), COORDINATES, ADDRESS (via geocoding)

        **Status Codes SICAR:**
        - `CA` (CANCELADO): Registro cancelado
        - `SU` (SUSPENSO): Registro suspenso por irregularidades
        - `PE` (PENDENTE): Registro pendente de valida√ß√£o

        **Uso:**
        Use o `carNumber` retornado para testar o endpoint `/check` com input type CAR.
        Tamb√©m retorna coordenadas do centr√≥ide para testes espaciais.
        API retorna FAIL quando CAR est√° cancelado ou suspenso.

        **‚ö†Ô∏è Fix aplicado (2026-02-02):**
        Query SQL corrigido para usar c√≥digos SICAR (CA/SU/PE) ao inv√©s de nomes completos.
        Adicionado campo `statusDescription` para mapear c√≥digos ‚Üí nomes leg√≠veis.

        **Response:** Cada sample inclui carNumber, status (c√≥digo), statusDescription (leg√≠vel),
        √°rea (ha), munic√≠pio, estado e coordenadas do centr√≥ide.

        Se `count: 0`, significa que n√£o h√° CARs com status irregular no momento
        (ou dados em processamento). Neste caso retorna `message` explicativo.
      operationId: getSamplesCar
      security: []
      responses:
        '200':
          description: Lista de CAR samples com status irregular (ou mensagem explicativa se vazio)
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SampleResponse'
                  - type: object
                    properties:
                      samples:
                        type: array
                        items:
                          $ref: '#/components/schemas/CARSample'

  /samples/prodes:
    get:
      tags:
        - samples
      summary: Get samples from PRODES Deforestation
      description: |
        Retorna 10 coordenadas aleat√≥rias com desmatamento hist√≥rico detectado pelo PRODES.

        **Dados:** 216,252 pol√≠gonos de desmatamento de todos os 6 biomas brasileiros (INPE).

        **Input types suportados:** COORDINATES, ADDRESS (via geocoding)

        **Biomas cobertos:**
        - Amaz√¥nia Legal (2015-2024)
        - Cerrado, Caatinga, Mata Atl√¢ntica, Pampa, Pantanal

        **Uso:**
        Use as coordenadas retornadas (centr√≥ide de cada pol√≠gono) para testar o endpoint `/check`.
        API retorna FAIL quando coordenadas caem dentro de pol√≠gono de desmatamento.
        Severity baseada na √°rea e ano do desmatamento.

        **Response:** Cada sample inclui ano do desmatamento, √°rea (ha), munic√≠pio, estado,
        path/row (refer√™ncia sat√©lite) e coordenadas do centr√≥ide.
      operationId: getSamplesProdes
      security: []
      responses:
        '200':
          description: 10 samples retornados
          content:
            application/json:
              schema:
                type: object

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: |
        API key para autentica√ß√£o. Formato: `ck_` + 64 caracteres hexadecimais.

        Entre em contato com o time DeFarm para obter uma API key.

        **Rate limit:** 10,000 requisi√ß√µes/minuto por key.

  schemas:
    CheckRequest:
      type: object
      required:
        - input
      properties:
        input:
          type: object
          required:
            - type
            - value
          properties:
            type:
              type: string
              enum:
                - CNPJ
                - CPF
                - CAR
                - COORDINATES
                - ADDRESS
              description: Tipo do input a ser verificado
            value:
              oneOf:
                - type: string
                  description: |
                    CNPJ, CPF, CAR (com ou sem formata√ß√£o) ou ADDRESS (endere√ßo brasileiro em texto livre).

                    Exemplos de endere√ßo:
                    - "S√£o Paulo, SP"
                    - "Altamira, Par√°"
                    - "Bras√≠lia, DF"
                    - "Rua Augusta 123, S√£o Paulo"

                    Endere√ßos s√£o geocodificados automaticamente para coordenadas usando OpenStreetMap Nominatim.
                - type: object
                  description: Coordenadas geogr√°ficas
                  required:
                    - lat
                    - lon
                  properties:
                    lat:
                      type: number
                      format: float
                      minimum: -90
                      maximum: 90
                      description: Latitude em decimal (WGS84)
                    lon:
                      type: number
                      format: float
                      minimum: -180
                      maximum: 180
                      description: Longitude em decimal (WGS84)
        options:
          type: object
          description: Op√ß√µes adicionais para a verifica√ß√£o
          properties:
            sources:
              type: array
              items:
                type: string
              description: Lista de checkers espec√≠ficos a executar (opcional)
            useCache:
              type: boolean
              default: true
              description: Usar cache para acelerar resposta
            includeEvidence:
              type: boolean
              default: true
              description: Incluir evid√™ncias e links para fontes
            timeout:
              type: integer
              default: 15000
              description: Timeout em milissegundos para cada checker

    CheckResponse:
      type: object
      required:
        - checkId
        - input
        - timestamp
        - verdict
        - score
        - sources
        - summary
        - metadata
      properties:
        checkId:
          type: string
          format: uuid
          description: ID √∫nico da verifica√ß√£o
        input:
          type: object
          properties:
            type:
              type: string
            value:
              oneOf:
                - type: string
                - type: object
          description: Input original da requisi√ß√£o
        timestamp:
          type: string
          format: date-time
          description: Data/hora da verifica√ß√£o (ISO 8601)
        verdict:
          type: string
          enum:
            - COMPLIANT
            - NON_COMPLIANT
            - PARTIAL
            - UNKNOWN
          description: |
            Veredito final agregado:
            - `COMPLIANT`: Totalmente conforme (score = 100)
            - `NON_COMPLIANT`: N√£o conforme (score < 80)
            - `PARTIAL`: Parcialmente conforme (80 ‚â§ score < 100)
            - `UNKNOWN`: Erro ao executar verifica√ß√£o
        score:
          type: integer
          minimum: 0
          maximum: 100
          description: |
            Score de compliance (0-100):
            - 100 = Totalmente conforme
            - 80-99 = Parcialmente conforme
            - 0-79 = N√£o conforme
        sources:
          type: array
          items:
            $ref: '#/components/schemas/SourceResult'
          description: Resultado de cada checker executado
        summary:
          type: object
          required:
            - totalCheckers
            - passed
            - failed
            - warnings
            - errors
          properties:
            totalCheckers:
              type: integer
              description: Total de checkers executados
            passed:
              type: integer
              description: Checkers que passaram (PASS)
            failed:
              type: integer
              description: Checkers que falharam (FAIL)
            warnings:
              type: integer
              description: Checkers com alertas (WARNING)
            errors:
              type: integer
              description: Checkers com erro de execu√ß√£o
            notApplicable:
              type: integer
              description: Checkers n√£o aplic√°veis ao input
        metadata:
          type: object
          required:
            - processingTimeMs
            - cacheHitRate
            - apiVersion
            - timestamp
          properties:
            processingTimeMs:
              type: integer
              description: Tempo total de processamento em ms
            cacheHitRate:
              type: number
              format: float
              minimum: 0
              maximum: 1
              description: Taxa de cache hits (0-1)
            apiVersion:
              type: string
              description: Vers√£o da API
            timestamp:
              type: string
              format: date-time

    SourceResult:
      type: object
      required:
        - name
        - category
        - status
        - message
      properties:
        name:
          type: string
          description: Nome da fonte/checker
        category:
          type: string
          enum:
            - social
            - environmental
            - legal
          description: Categoria do checker
        status:
          type: string
          enum:
            - PASS
            - FAIL
            - WARNING
            - ERROR
            - NOT_APPLICABLE
          description: |
            Status do check:
            - `PASS`: Conforme (nenhum problema encontrado)
            - `FAIL`: N√£o conforme (problema detectado)
            - `WARNING`: Alerta (aten√ß√£o necess√°ria)
            - `ERROR`: Erro ao executar checker
            - `NOT_APPLICABLE`: Checker n√£o aplic√°vel ao input
        severity:
          type: string
          enum:
            - LOW
            - MEDIUM
            - HIGH
            - CRITICAL
          description: |
            Severidade do problema (apenas quando status = FAIL):
            - `LOW`: Problema menor
            - `MEDIUM`: Problema moderado
            - `HIGH`: Problema grave
            - `CRITICAL`: Problema cr√≠tico (bloqueante)
        message:
          type: string
          description: Mensagem descritiva do resultado
        details:
          type: object
          description: Detalhes espec√≠ficos do resultado (varia por checker)
        evidence:
          type: object
          properties:
            dataSource:
              type: string
              description: Nome da fonte de dados oficial
            url:
              type: string
              format: uri
              description: URL da fonte de dados
            lastUpdate:
              type: string
              format: date
              description: Data da √∫ltima atualiza√ß√£o dos dados
            raw:
              type: object
              description: Dados brutos da fonte (opcional)
        executionTimeMs:
          type: integer
          description: Tempo de execu√ß√£o do checker em ms
        cached:
          type: boolean
          description: Se o resultado veio do cache

    SourceInfo:
      type: object
      required:
        - name
        - category
        - enabled
        - status
        - description
      properties:
        name:
          type: string
          description: Nome da fonte de dados
        category:
          type: string
          enum:
            - social
            - environmental
            - legal
          description: Categoria da fonte
        enabled:
          type: boolean
          description: Se a fonte est√° habilitada
        status:
          type: string
          enum:
            - operational
            - down
            - maintenance
          description: Status operacional da fonte
        description:
          type: string
          description: Descri√ß√£o da fonte e o que ela verifica

    HealthResponse:
      type: object
      required:
        - status
        - timestamp
        - version
        - services
      properties:
        status:
          type: string
          enum:
            - ok
            - degraded
            - down
          description: Status geral da API
        timestamp:
          type: string
          format: date-time
          description: Data/hora da verifica√ß√£o
        version:
          type: string
          description: Vers√£o da API
        services:
          type: object
          required:
            - database
            - redis
          properties:
            database:
              type: string
              enum:
                - ok
                - down
              description: Status do PostgreSQL + PostGIS
            redis:
              type: string
              enum:
                - ok
                - down
              description: Status do Redis (cache)

    SampleResponse:
      type: object
      description: Response padr√£o para endpoints /samples/*
      required:
        - source
        - count
        - samples
      properties:
        source:
          type: string
          description: Nome da fonte de dados
          example: "CAR - Cadastro Ambiental Rural (SICAR)"
        count:
          type: integer
          description: N√∫mero de samples retornados (0-10)
          minimum: 0
          maximum: 10
          example: 10
        message:
          type: string
          nullable: true
          description: |
            Mensagem explicativa quando count=0.
            Indica que APIs governamentais est√£o offline (n√£o bloqueante).
          example: "Dados em processamento. API temporariamente indispon√≠vel."
        samples:
          type: array
          description: Lista de samples (vazio se count=0)
          items:
            type: object

    CARSample:
      type: object
      description: Sample de registro CAR com status irregular
      required:
        - carNumber
        - status
        - statusDescription
        - areaHa
        - municipality
        - state
        - coordinates
        - testUrl
      properties:
        carNumber:
          type: string
          description: C√≥digo √∫nico do registro CAR (formato UF-MUNIC√çPIO-C√ìDIGO)
          example: "PR-4111506-1B80A47993684BEE9908ED4468199BF8"
        status:
          type: string
          enum: [CA, SU, PE, AT]
          description: C√≥digo de status SICAR
          example: "CA"
        statusDescription:
          type: string
          enum: [CANCELADO, SUSPENSO, PENDENTE, ATIVO]
          description: Descri√ß√£o leg√≠vel do status
          example: "CANCELADO"
        areaHa:
          type: integer
          description: √Årea do im√≥vel em hectares
          example: 150
        municipality:
          type: string
          description: Munic√≠pio do im√≥vel
          example: "Ivaipora"
        state:
          type: string
          description: Sigla do estado (UF)
          example: "PR"
        coordinates:
          type: object
          description: Coordenadas do centr√≥ide da propriedade
          required:
            - lat
            - lon
          properties:
            lat:
              type: number
              format: float
              description: Latitude (WGS84)
              example: -24.33476771879231
            lon:
              type: number
              format: float
              description: Longitude (WGS84)
              example: -51.587721288619306
        testUrl:
          type: string
          description: URL de exemplo para testar no endpoint /check
          example: 'POST /check {"input":{"type":"CAR","value":"PR-4111506-..."}}'

    Error:
      type: object
      required:
        - error
        - message
        - statusCode
      properties:
        error:
          type: string
          description: Nome do erro
        message:
          type: string
          description: Mensagem descritiva do erro
        statusCode:
          type: integer
          description: C√≥digo HTTP do erro
        details:
          type: array
          items:
            type: object
          description: Detalhes adicionais (valida√ß√£o, etc)
